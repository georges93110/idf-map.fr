<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="Explorez la carte interactive de la map Ile-de-France."/>
  <meta property="og:locale" content="fr_FR"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="Ile-de-France Map - Carte Interactive"/>
  <meta property="og:title" content="Ile-de-France Map"/>
  <meta property="og:description" content="Explorez la carte interactive de la map Ile-de-France."/>
  <meta property="og:url" content="https://idf-map.fr/map.html"/>
  <meta property="og:image" content="https://idf-map.fr/images/idf_logo_new.webp"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Ile-de-France Map - Carte Interactive"/>
  <meta name="twitter:description" content="Explorez la carte interactive de la map Ile-de-France."/>
  <meta name="twitter:image" content="https://idf-map.fr/images/idf_logo_new.webp"/>
  <style>
    html[data-app-ready="0"] {
      background:#000;
    }
    html[data-app-ready="0"] body {
      opacity:0 !important;
      visibility:hidden !important;
      overflow:hidden !important;
    }
  </style>
  <script>
    (function setupAppReadyGate() {
      const root = document.documentElement;
      root.setAttribute("data-app-ready", "0");
      let done = false;
      function reveal() {
        if (done) return;
        done = true;
        root.setAttribute("data-app-ready", "1");
      }
      window.__setAppReady = function __setAppReady(options) {
        const cfg = options && typeof options === "object" ? options : {};
        const minFrames = Math.max(4, Number(cfg.minFrames) || 8);
        const stableFrames = Math.max(2, Number(cfg.stableFrames) || 3);
        const maxFrames = Math.max(minFrames + stableFrames, Number(cfg.maxFrames) || 28);
        let frameCount = 0;
        let stableCount = 0;
        let previousKey = "";
        const step = () => {
          frameCount += 1;
          let layoutKey = "";
          const body = document.body;
          if (body) {
            const rect = body.getBoundingClientRect();
            layoutKey = [
              Math.round(rect.width),
              Math.round(rect.height),
              document.documentElement.scrollWidth,
              document.documentElement.scrollHeight
            ].join("x");
          }
          stableCount = layoutKey && layoutKey === previousKey ? stableCount + 1 : 0;
          previousKey = layoutKey;
          const enoughFrames = frameCount >= minFrames;
          const visuallyStable = stableCount >= stableFrames;
          const frameBudgetExceeded = frameCount >= maxFrames;
          if ((!enoughFrames || !visuallyStable) && !frameBudgetExceeded) {
            requestAnimationFrame(step);
            return;
          }
          reveal();
        };
        const start = () => requestAnimationFrame(step);
        if (document.fonts && document.fonts.ready) {
          Promise.race([
            document.fonts.ready.catch(() => {}),
            new Promise((resolve) => setTimeout(resolve, 1200))
          ]).finally(start);
          return;
        }
        start();
      };
      window.addEventListener("pageshow", reveal, { once: true });
      window.setTimeout(reveal, 7000);
    })();
  </script>
  <title>Map</title>
  <link rel="icon" type="image/png" href="images/idf_logo_new.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --panel:#121212;--panel2:#1a1a1a;--border:#3a3a3a;--text:#ececec;--muted:#8f8f8f;--shadow:0 10px 30px rgba(0,0,0,.40);
      --logoW:110px; --logoH:44px;
      --sidePanelW:460px;
      --busA:#3a3a3a; --busB:#3a3a3a; --busC:#3a3a3a; --busD:#3a3a3a; --busE:#3a3a3a;
      --rer-mask-url: none;
      --metro-icon-url: none;
      --metro-mask-url: none;
      --anim-fast:.16s;
      --anim-med:.24s;
      --anim-slow:.34s;
      --anim-ease:cubic-bezier(.22,.61,.36,1);
      --topbar-top:0px;
      --sitebar-height:52px;
      --mapbar-height:56px;
      --topbar-gap:10px;
      --site-header-h: calc(var(--topbar-top) + var(--sitebar-height));
      --header-stack-h: calc(var(--topbar-top) + var(--sitebar-height) + var(--topbar-gap) + var(--mapbar-height));
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    #map{position:fixed;inset:0}
    .leaflet-container,html,body,#map{background:#000}
    .city-label{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      color:#fff;font-weight:600;white-space:nowrap;text-align:center;
      text-shadow:0 2px 4px rgba(0,0,0,.8);
      pointer-events:auto; cursor:pointer;
    }
    .city-selected{color:#ffda3a !important;text-shadow:0 0 0 rgba(0,0,0,0),0 2px 6px rgba(0,0,0,.9)}
    body.map-icons-disabled .leaflet-image-layer.leaflet-zoom-animated.leaflet-interactive,
    body.map-icons-disabled .dbus-stop-marker,
    body.map-icons-disabled .dbus-stop-marker-host{
      opacity:0 !important;
      visibility:hidden !important;
    }
    body.route-selected .dbus-stop-marker-wrap{
      opacity:0 !important;
      visibility:hidden !important;
      pointer-events:none !important;
    }

    .map-topbar{
      position:fixed;
      top:calc(var(--site-header-h) + var(--topbar-gap));
      left:12px;
      right:12px;
      z-index:1305;
      padding:0 10px;
      border:none;
      border-radius:14px;
      background:transparent;
      box-shadow:none;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
      transition:transform .2s ease;
      pointer-events:none;
    }
    .map-topbar.dbus-open{
      transform:none;
    }
    body.side-panel-resizing .map-topbar.dbus-open{
      transform:none;
    }
    .map-topbar-row{
      position:relative;
      display:flex;
      align-items:center;
      gap:16px;
      width:100%;
      max-width:none;
      padding:0;
      box-sizing:border-box;
      min-height:var(--mapbar-height);
      pointer-events:none;
    }
    .map-topbar-row .search-input,
    .map-topbar-row .top-actions,
    .map-topbar-row .top-actions *{
      pointer-events:auto;
    }
    .map-topbar-row .search-input{
      position:static;
      left:auto;
      transform:none;
      flex:0 1 560px;
      width:auto;
      max-width:min(560px, 64vw);
      min-width:220px;
      margin:0;
    }
    .search-panel{
      position:fixed;
      top:calc(var(--header-stack-h) + 6px);
      left:0;
      right:0;
      z-index:1000;
    }
    .top-actions{
      position:static;
      right:auto;
      top:auto;
      transform:none;
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      transition:transform .2s ease;
    }
    .search-panel.dbus-open{z-index:1250}
    .top-actions.dbus-open{
      transform:translateX(calc(-1 * var(--activePanelShift, min(var(--sidePanelW), 50vw, 94vw))));
    }
    body.side-panel-resizing .top-actions.dbus-open{
      transform:translateX(calc(-1 * var(--activePanelShift, var(--sidePanelDragShift, 460px))));
    }
    body.compact-open-ui .map-topbar-row .search-input,
    body.compact-open-ui .map-topbar-row .top-actions{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
      width:0;
      min-width:0;
      max-width:0;
      margin:0;
      overflow:hidden;
    }
    body.compact-open-ui .top-actions.dbus-open,
    body.compact-open-ui.side-panel-resizing .top-actions.dbus-open{
      transform:none;
    }
    body.compact-open-ui .map-topbar-row{
      gap:0;
      min-height:0;
    }
    .icon-btn{
      width:44px;
      min-width:44px;
      height:44px;
      padding:11px 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
    }
    #btnSettings{
      width:44px;
      min-width:44px;
      height:44px;
      padding:0;
      box-sizing:border-box;
    }
    #btnDbus{
      width:44px;
      min-width:44px;
      height:44px;
      padding:0;
      box-sizing:border-box;
    }
    .dbus-icon-logo{
      width:24px;
      height:24px;
      display:block;
      object-fit:contain;
    }
    .settings-icon{
      width:18px;
      height:18px;
      stroke:currentColor;
      fill:none;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .map-topbar .btn{
      background:#1a1a1a;
      border-color:#2c2c2c;
      color:#f2f2f2;
    }
    .map-topbar .btn:hover{
      background:#252525;
      border-color:#444444;
    }
    html[lang="fr"] #settingsTranslateStopsRow{
      display:none !important;
    }
    .lang-toggle-badge{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(245,158,11,0.15);
      border:1px solid rgba(245,158,11,0.45);
      color:#fbbf24;
      font-weight:800;
    }
    .search-input{flex:1;min-width:300px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-size:15px;box-shadow:var(--shadow);outline:none}
    .search-input:disabled{opacity:.5;cursor:not-allowed;background:color-mix(in oklab, var(--panel) 85%, #000 15%)}
    .search-input::placeholder{color:var(--muted)}
    .btn{padding:11px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-weight:600;cursor:pointer;box-shadow:var(--shadow);text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn:hover{background:#222222}
    .btn,.dbus-mode-btn,.dbus-switch,.dbus-item,.dbus-logo,.dbus-sechead,.result-item,.line-preview-link{
      transition:
        transform var(--anim-fast) var(--anim-ease),
        opacity var(--anim-fast) var(--anim-ease),
        background var(--anim-fast) var(--anim-ease),
        border-color var(--anim-fast) var(--anim-ease),
        color var(--anim-fast) var(--anim-ease),
        box-shadow var(--anim-fast) var(--anim-ease);
    }
    .btn:disabled,
    .btn.is-disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
    .btn.is-open{
      outline:2px solid #f59e0b;
      outline-offset:2px;
    }
    .results{margin-top:6px;max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .result-item{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-bottom:1px solid #2c2c2c;color:var(--text);font-size:14px}
    .result-item:last-child{border-bottom:none}
    .result-item:hover{background:#222222}
    .result-item img.ico{width:var(--logoW);height:var(--logoH);flex:0 0 auto;border-radius:6px;object-fit:contain}
    .result-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;line-height:1.2}
    .result-empty{
      padding:10px 12px;
      color:var(--muted);
      font-size:14px;
      border-bottom:1px solid #2c2c2c;
    }
    .result-item img.ico { width: var(--logoW); height: var(--logoH); }
    .result-item img.ico.ico-service { width: calc(var(--logoW) / 2); height: calc(var(--logoH) / 2); }

    .search-panel-modal .search-toolbar{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid #2c2c2c;
      background:var(--panel2);
    }
    .search-panel-modal .search-input{width:100%;min-width:0;box-shadow:none}
    .search-panel-modal .results{
      margin:0;
      padding:6px;
      max-height:none;
      border:0;
      background:transparent;
      box-shadow:none;
      overflow:visible;
    }
    #searchFilters{flex:1;min-width:0}
    .search-panel-modal .dbus-header .dbus-close{margin-left:auto}
    .result-sechead{
      padding:8px 10px;
      color:#b1b1b1;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:1px solid #2c2c2c;
      background:var(--panel2);
    }

    .dbus-panel{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:min(1240px,94vw);
      height:min(760px,92vh);
      max-width:94vw;
      max-height:92vh;
      box-sizing:border-box;
      padding:12px 18px;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 25px 90px rgba(0,0,0,.7);
      display:none;
      overflow:hidden;
      z-index:1200;
      flex-direction:column;
    }
    #dbusPanel{
      top:var(--site-header-h);
      right:0;
      left:auto;
      transform:none;
      z-index:1308;
      width:min(var(--sidePanelW),50vw,94vw);
      max-width:50vw;
      height:calc(100vh - var(--site-header-h));
      max-height:calc(100vh - var(--site-header-h));
      padding:0;
      border-radius:0;
      border-top:none;
      border-right:none;
      border-bottom:none;
      box-shadow:-16px 0 50px rgba(0,0,0,.55);
    }
    #settingsPanel{
      top:var(--site-header-h);
      right:0;
      left:auto;
      transform:none;
      z-index:1308;
      width:min(var(--sidePanelW),50vw,94vw);
      max-width:50vw;
      height:calc(100vh - var(--site-header-h));
      max-height:calc(100vh - var(--site-header-h));
      padding:0;
      border-radius:0;
      border-top:none;
      border-right:none;
      border-bottom:none;
      border-left:1px solid var(--border);
      background:var(--panel);
      box-shadow:-16px 0 50px rgba(0,0,0,.55);
    }
    #settingsPanel .dbus-content{
      padding:12px;
      display:block;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden;
      scrollbar-gutter:stable;
      background:var(--panel);
    }
    #settingsPanel .dbus-content::-webkit-scrollbar{
      width:12px;
    }
    #settingsPanel .dbus-content::-webkit-scrollbar-track{
      background:var(--panel2);
      border-radius:10px;
    }
    #settingsPanel .dbus-content::-webkit-scrollbar-thumb{
      background:#7a7a7a;
      border-radius:10px;
      border:2px solid var(--panel2);
    }
    #settingsPanel .dbus-content::-webkit-scrollbar-thumb:hover{
      background:#9d9d9d;
    }
    #settingsPanel .settings-category{
      margin:0 0 14px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--panel2);
    }
    #settingsPanel .settings-category:last-child{margin-bottom:0}
    #settingsPanel .settings-group-title{
      margin:0;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:#171717;
      color:var(--text);
      font-size:12px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    #settingsPanel .settings-sec{
      padding:10px 12px 12px;
      border-bottom:1px solid var(--border);
    }
    #settingsPanel .settings-category .settings-sec:last-child{border-bottom:none}
    #settingsPanel .settings-title{
      margin:0 0 10px;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    #settingsPanel .settings-legend{
      margin-top:12px;
      position:sticky;
      bottom:0;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#171717;
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      z-index:2;
    }
    #settingsPanel .settings-legend .settings-group-title{
      border-bottom:1px solid var(--border);
    }
    #settingsPanel .settings-legend-list{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:8px;
      padding:10px 12px 12px;
    }
    #settingsPanel .settings-legend-item{
      display:flex;
      align-items:center;
      gap:10px;
      min-height:28px;
      color:#e0e0e0;
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    #settingsPanel .settings-legend-item-main{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex:1 1 auto;
    }
    #settingsPanel .settings-legend-icon{
      width:22px;
      height:22px;
      object-fit:contain;
      border-radius:5px;
      flex:0 0 auto;
      box-shadow:0 0 0 1px rgba(255,255,255,.06) inset;
      background:rgba(255,255,255,.03);
    }
    #settingsPanel .settings-legend-label{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #settingsPanel .settings-legend-exp{
      margin-left:auto;
      flex:0 0 auto;
    }
    #settingsPanel .settings-legend-switch{
      margin-left:8px;
      flex:0 0 auto;
    }
    #settingsPanel .settings-legend-item-toggle{
      grid-column:1 / -1;
    }
    #settingsPanel .lang-menu{
      position:static;
      top:auto;
      right:auto;
      min-width:0;
      width:100%;
      padding:0;
      border:none;
      border-radius:0;
      background:transparent;
      box-shadow:none;
      display:block !important;
    }
    #settingsPanel .settings-map-version-row{
      display:flex;
      align-items:center;
    }
    #settingsPanel .settings-map-version-select{
      width:100%;
      max-width:100%;
      min-height:38px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--panel2);
      color:var(--text);
      font-size:13px;
      font-weight:600;
      padding:8px 10px;
      outline:none;
    }
    #settingsPanel .settings-map-version-select:focus{
      border-color:#6f6f6f;
      box-shadow:0 0 0 2px rgba(111,111,111,.2);
    }
    #dbusPanel .dbus-header .dbus-close,
    #settingsPanel .dbus-header .dbus-close{
      order:-1;
      margin-right:4px;
    }
    #dbusPanel .dbus-header .dbus-world-link{
      margin-left:auto;
    }
    #searchPanel.search-panel-modal{
      position:absolute;
      top:calc(100% + 8px);
      left:12px;
      right:auto;
      transform:none;
      width:min(760px,calc(100vw - 24px));
      max-width:calc(100vw - 24px);
      height:auto;
      max-height:min(70vh,620px);
      padding:0;
      border-radius:14px;
    }
    #searchPanel.search-panel-modal .dbus-header{display:none}
    #searchPanel.search-panel-modal .dbus-content{
      max-height:calc(min(70vh,620px) - 56px);
      overflow:auto;
    }
    .dbus-panel.is-open,
    .dbus-stop-panel.is-open{
      outline:2px solid #ffffff33;
      outline-offset:-2px;
    }
    #dbusPanel.is-open,
    #settingsPanel.is-open{
      animation:sidePanelIn var(--anim-med) var(--anim-ease) both;
    }
    #dbusPanel.is-closing,
    #settingsPanel.is-closing{
      animation:sidePanelOut var(--anim-med) var(--anim-ease) both;
      pointer-events:none;
    }
    #searchPanel.search-panel-modal.is-open{
      animation:searchPanelIn var(--anim-med) var(--anim-ease) both;
    }
    #searchPanel.search-panel-modal.is-closing{
      animation:searchPanelOut var(--anim-med) var(--anim-ease) both;
      pointer-events:none;
    }
    .dbus-stop-panel.is-open{
      animation:modalPanelIn var(--anim-med) var(--anim-ease) both;
    }
    .dbus-stop-panel.is-closing{
      animation:modalPanelOut var(--anim-med) var(--anim-ease) both;
      pointer-events:none;
    }
    .dbus-panel .dbus-content{
      flex:1 1 auto;
      overflow:auto;
      scrollbar-gutter: stable;
      min-height:0;
    }
    .dbus-stop-panel{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:min(1240px,92vw);
      max-width:92vw;
      height:min(760px,92vh);
      max-height:92vh;
      box-sizing:border-box;
      padding:12px 18px 0;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 25px 90px rgba(0,0,0,.7);
      display:none;
      overflow:hidden;
      z-index:1308;
      flex-direction:column;
    }
    .dbus-stop-panel .dbus-title{white-space:normal;line-height:1.25}
    .dbus-stop-content{flex:1 1 auto;overflow:auto;scrollbar-gutter: stable;min-height:0}
    .dbus-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #2c2c2c;color:var(--muted);font-size:16px}
    .dbus-header .dbus-title{font-size:20px;font-weight:700;color:#f2f2f2;}
    .dbus-header .dbus-close{
      background:transparent;
      border:none;
      color:#ef4444;
      font-size:24px;
      cursor:pointer;
      line-height:1;
    }
    .dbus-mode-group{display:flex;gap:8px;align-items:center;margin-left:auto}
    .dbus-group-label{
      font-size:11px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#7c879d;
      font-weight:700;
    }
    .dbus-modes{display:flex;gap:6px;align-items:center}
    .dbus-mode-btn{border:1px solid #2c2c2c;background:#1a1a1a;color:#b1b1b1;padding:6px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer}
    .dbus-mode-btn:hover{background:#252525;color:#d0d6e6}
    .dbus-mode-btn.active{background:#343434;color:#f2f2f2;border-color:#444444;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)}
    .dbus-footer{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-top:1px solid #2c2c2c;
      background:var(--panel2);
      border-radius:12px;
      margin-top:10px;
      flex:0 0 auto;
    }
    #dbusPanel .dbus-layout{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px 12px 12px;
    }
    #dbusPanel .dbus-box{
      border:1px solid #2c2c2c;
      border-radius:12px;
      background:#1a1a1a;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #dbusPanel .dbus-lines-box{flex:1 1 auto}
    #dbusPanel .dbus-routes-box{
      flex:1 1 auto;
      min-height:220px;
      max-height:none;
    }
    #dbusPanel .dbus-network-filters{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      padding:0 6px 6px;
    }
    #dbusPanel .dbus-box-title{
      padding:10px 12px;
      border-bottom:1px solid #2c2c2c;
      color:#b1b1b1;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      background:#171717;
      display:flex;
      align-items:center;
      gap:8px;
    }
    #dbusPanel .dbus-box-title-label{
      flex:1 1 auto;
      min-width:0;
    }
    #dbusPanel .dbus-box-clear{
      margin-left:auto;
      border:none;
      background:transparent;
      color:#ef4444;
      font-size:18px;
      line-height:1;
      font-weight:900;
      padding:0 2px;
      cursor:pointer;
      border-radius:6px;
    }
    #dbusPanel .dbus-box-clear:hover{
      color:#ff6666;
      background:rgba(239,68,68,0.12);
    }
    #dbusPanel .dbus-box .dbus-content{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
    }
    #dbusPanel .dbus-footer{
      margin-top:0;
      border-radius:0;
      border-top:none;
      border-bottom:1px solid #2c2c2c;
      background:#171717;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:10px;
      padding:10px 12px;
    }
    #dbusPanel .dbus-footer-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
    }
    #dbusPanel .dbus-sort-modes{
      display:flex;
      align-items:center;
      gap:6px;
      width:100%;
    }
    #dbusPanel .dbus-sort-modes .dbus-mode-btn{
      flex:1 1 0;
      text-align:center;
    }
    #dbusRoutesList .dbus-none{
      margin:6px;
    }
    .dbus-filters{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .dbus-switch{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid #2c2c2c;border-radius:999px;background:#1a1a1a;color:#b1b1b1;font-size:12px;font-weight:700}
    .dbus-switch-label{white-space:nowrap}
    .dbus-switch input{
      appearance:none;
      width:34px;height:20px;
      background:#2a2a2a;
      border-radius:999px;
      border:1px solid #444444;
      position:relative;
      cursor:pointer;
      transition:background .2s ease,border-color .2s ease;
    }
    .dbus-switch input::after{
      content:"";
      position:absolute;
      width:16px;height:16px;
      border-radius:50%;
      background:#ececec;
      top:1px;left:1px;
      transition:transform .2s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.4);
    }
    .dbus-switch input:checked{
      background:#5e5e5e;
      border-color:#5e5e5e;
    }
    .dbus-switch input:checked::after{transform:translateX(14px)}
    .dbus-depart-indicator-wrap{display:flex;justify-content:flex-end;margin-top:6px}
    .dbus-depart-indicator-wrap[hidden]{display:none !important}
    .dbus-depart-indicator{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #444444;
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      color:#e0e0e0;
      font-size:12px;
      font-weight:700;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
    }
    .dbus-depart-close{
      background:transparent;
      border:none;
      color:#ef4444;
      font-size:25px;
      line-height:1;
      cursor:pointer;
      padding:0 2px;
    }
    .dbus-depart-close:hover{color:#ff6666}
    .dbus-stop-panel .dbus-close{margin-left:auto}
    .dbus-list{padding:6px}
    .dbus-depart-actions{padding:6px 12px 0}
    .dbus-depart-map-btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #2c2c2c;
      background:#1a1a1a;
      color:#e0e0e0;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
    }
    .dbus-depart-map-btn:hover{background:#252525;color:#f2f2f2}
    .dbus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 4px; 
      padding: 6px;
      justify-content: start; 
      align-items: start;
    }
    .dbus-double {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 10px;
      padding-bottom: 10px;
      grid-auto-rows: minmax(0, auto);
    }
    .dbus-double .dbus-item {
      width: 100%;
      box-sizing: border-box;
    }
    .dbus-double .dbus-item .rname {
      max-width: 100%;
      word-break: break-word;
    }
    .line-block{display:flex;flex-direction:column;align-items:flex-start}
    .dbus-logo{width:88px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #2c2c2c;background:#303030;color:#fff;font-weight:800;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,0.04)}
    .dbus-logo--titus{border:none;background:transparent;box-shadow:none}
    .dbus-logo.dim{opacity:.25; filter:grayscale(100%);}
    .dbus-logo.sel{position:relative}
    
    .dbus-logo img{display:block;width:100%;height:100%;object-fit:contain;border-radius:10px}
    .routes-host .dbus-item{margin:2px 6px;padding:8px 10px}
    .line-routes{margin-top:8px;width:100%}
    .dbus-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #2c2c2c;border-radius:10px;background:var(--panel2);cursor:pointer;margin:6px}
    .dbus-item:hover{background:#222222}
    .dbus-item .badge{display:flex;align-items:center;justify-content:center;width:72px;height:32px;border-radius:8px;font-weight:800;font-size:16px}
    .dbus-route-logo{width:46px;height:26px;object-fit:contain;flex:0 0 auto}
    .dbus-route-logo + .dbus-route-logo{margin-left:6px}
    .dbus-item .rname{
      color:var(--text);
      font-size:14px;
      white-space:normal;
      overflow:hidden;
      text-overflow:clip;
      word-break:break-word;
      line-height:1.3;
    }
    .dbus-duration{margin-left:auto;min-width:90px;text-align:right;color:#a5a5a5;font-size:13px;align-self:flex-start}
    .dbus-item-length{
      align-items:flex-start;
    }
    .dbus-item-length.logo-badge-tight{
      gap:6px;
    }
    .dbus-item-length.logo-badge-tight .dbus-route-logo + .badge{
      margin-left:-4px;
    }
    .dbus-item-length .dbus-item-meta{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      flex:1 1 auto;
      min-width:0;
    }
    .dbus-item-length .rname{
      width:100%;
    }
    .dbus-item-length .dbus-duration{
      margin-left:0;
      min-width:0;
      text-align:left;
      align-self:flex-start;
    }
    .dbus-stop-count{
      min-width:44px;
      height:32px;
      border-radius:8px;
      background:#343434;
      color:#f2f2f2;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:14px;
    }
    .dbus-none{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed #303030;border-radius:10px;background:#171717;color:#a5a5a5;cursor:pointer;margin:6px}
    .dbus-item.active{ outline:2px solid #ffffff55; background:#222222; }
    .dbus-sec{margin:8px 6px 4px}
    .dbus-sec h4{
      margin:10px 6px 6px;
      color:#b1b1b1;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .dbus-sechead {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      color:#b1b1b1;
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      border-bottom:1px solid #2c2c2c;
      background:var(--panel2);
      cursor:pointer;
      user-select:none;
    }
    .dbus-sechead-logo{
      height:20px;
      width:auto;
      object-fit:contain;
      display:block;
      border-radius:4px;
    }
    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }
    .dbus-secbody[hidden] { display:none; }
    .dbus-stop-panel .dbus-sec{margin:6px 6px 4px}
    .dbus-stop-panel .dbus-sec h4{margin:8px 6px 4px}
    .dbus-stop-panel .dbus-sec .dbus-sec{margin:6px 4px 4px}

    .dbus-depart-icon{background:transparent;border:none}
    .dbus-depart-dot{
      width:24px;height:24px;border-radius:50%;
      background:#f2f2f2;border:2px solid #121212;color:#121212;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:800;box-shadow:0 4px 10px rgba(0,0,0,.35);
    }
    .dbus-depart-dot.is-hover{background:#dbeafe}
    .dbus-depart-dot.is-selected{background:#60a5fa}
    .leaflet-tooltip.dbus-depart-tooltip{
      background:color-mix(in oklab, var(--panel2) 90%, #000 10%);
      border:1px solid #2c2c2c;
      color:var(--text);
      padding:4px 8px;
      border-radius:8px;
      box-shadow:var(--shadow);
      font-size:12px;
      font-weight:700;
    }
    .leaflet-tooltip.dbus-depart-tooltip:before{border-top-color:#2c2c2c}


    .watermark{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:400;
      pointer-events:none;
      filter:grayscale(10%);
      mix-blend-mode:screen;
      transition:transform .2s ease, opacity .2s ease;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }
    .watermark.dbus-open{
      transform:translateX(calc(-1 * min(var(--sidePanelW), 50vw, 94vw) - 10px));
    }
    body.side-panel-resizing .watermark.dbus-open{
      transform:translateX(calc(-1 * var(--sidePanelDragShift, 460px) - 10px));
    }
    .side-panel-resizer{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:12px;
      cursor:ew-resize;
      z-index:3;
      touch-action:none;
      background:linear-gradient(to right, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .side-panel-resizer::after{
      content:"";
      position:absolute;
      left:2px;
      top:50%;
      transform:translateY(-50%);
      width:2px;
      height:70px;
      border-radius:2px;
      background:rgba(255,255,255,.28);
    }
    .side-panel-resizer:hover::after{
      background:rgba(255,255,255,.45);
    }
    .watermark img{
      display:block;
      width:220px;
      max-width:32vw;
      height:auto;
      opacity:.2;
      pointer-events:none;
    }
    .watermark-version{
      font-size:11px;
      font-weight:700;
      letter-spacing:.03em;
      color:#ffffff;
      opacity:.2;
      cursor:default;
      user-select:none;
      -webkit-user-select:none;
      text-align:right;
      text-shadow:0 1px 2px rgba(0,0,0,.55);
      max-width:min(340px, 56vw);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      pointer-events:none;
    }
    .watermark-version.is-outdated{
      color:#ff0000;
    }
    .leaflet-top.leaflet-left .leaflet-control{display:none !important}

    .inline-ico{ height:1.5em; width:auto; vertical-align:-.35em; margin:0 .12em }
    .rer-invert { filter: invert(1); }
    .leaflet-popup-content{white-space:normal;overflow:visible}
    .dbus-stop-name{font-size:15px;line-height:1.35;word-break:break-word}
    .stop-popup{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:260px;
      max-width:420px;
      font-size:13px;
      color:#d4dcf0;
    }
    .stop-popup .sp-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-radius:10px;
      background:color-mix(in oklab,var(--panel2) 85%, #000 15%);
      border:1px solid rgba(255,255,255,0.08);
    }
    .stop-popup .sp-title{
      font-weight:700;
      font-size:14px;
      color:#f2f2f2;
    }
    .stop-popup .sp-index{
      padding:2px 10px;
      border-radius:999px;
      background:#2a2a2a;
      border:1px solid #3a3a3a;
      color:#e2e2e2;
      font-weight:700;
      font-size:12px;
    }
    .stop-popup .sp-body{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .stop-popup .sp-coords{
      font-size:12px;
      line-height:1.5;
      color:#a5a5a5;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #303030;
      background:#1a1a1a;
    }
    .stop-popup .sp-coords span{
      display:block;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:11px;
      margin-bottom:3px;
      color:#c2c2c2;
    }
    .stop-popup .sp-coords-code{
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size:12px;
      color:#ececec;
    }
    .dbus-stop-lines-popup{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:260px;
      max-width:420px;
      font-size:13px;
      color:#d4dcf0;
    }
    .dbus-stop-lines-title{
      font-weight:700;
      font-size:14px;
      color:#f2f2f2;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background:color-mix(in oklab,var(--panel2) 85%, #000 15%);
    }
    .dbus-stop-lines-row{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(15,23,34,0.78);
    }
    .dbus-stop-lines-logo{
      width:48px;
      height:24px;
      object-fit:contain;
      flex:0 0 auto;
    }
    .dbus-stop-lines-badges{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:4px;
      min-width:0;
    }
    .dbus-stop-line-badge{
      margin:0;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .dbus-stop-line-school-logo{
      width:20px;
      height:20px;
      object-fit:contain;
      border-radius:4px;
      box-shadow:0 0 0 1px rgba(255,255,255,0.08);
      background:rgba(8,12,20,0.7);
      padding:1px;
      box-sizing:border-box;
      flex:0 0 auto;
    }
    .dbus-stop-marker-host{
      background:transparent !important;
      border:none !important;
    }
    .dbus-stop-marker-wrap{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
    }
    .dbus-stop-marker{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 1px 2px rgba(0,0,0,.55));
      pointer-events:none;
      user-select:none;
    }
    .dbus-stop-marker-count{
      position:absolute;
      right:-4px;
      top:-4px;
      min-width:14px;
      height:14px;
      padding:0 3px;
      border-radius:999px;
      background:#121212;
      border:1px solid rgba(255,255,255,0.30);
      color:#ececec;
      font-size:9px;
      font-weight:800;
      line-height:12px;
      text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.5);
      pointer-events:none;
    }
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip{
      background:color-mix(in oklab,var(--panel) 92%, #000 8%);
      color:var(--text);
      border:1px solid #1c2533;
      box-shadow:0 12px 32px rgba(0,0,0,.55);
    }

    @media (max-width:800px){
      .search-panel{min-width:0;max-width:92vw}
      .search-input{min-width:180px}
      .watermark img{width:180px}
    }
    .selected-chip{margin-top:6px;display:none;width:100%}
    .line-chip{display:flex;align-items:center;padding:6px 6.5px;border:1px solid var(--border);border-radius:12px;background:color-mix(in oklab, var(--panel) 92%, #000 8%);box-shadow:var(--shadow);width:fit-content}
    .line-chip .close{margin-left:10px;border:none;background:transparent;color:#ef4444;font-weight:900;font-size:22px;cursor:pointer;line-height:1}
    .line-chip .close:hover{color:#ff6666}

    .line-preview-wrap{
      position:fixed;
      left:12px;
      top:calc(var(--header-stack-h) + 12px);
      right:auto;
      bottom:auto;
      transform:none;
      z-index:1100;
      pointer-events:none;
    }
    .line-preview-wrap.with-side-panel{
      right:auto;
    }
    .line-preview{
      margin:0;
      width:max-content;
      max-width:calc(100vw - 24px);
      background:rgba(11,17,24,0);
      padding:10px 12px;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .line-preview-wrap.is-open .line-preview{
      animation:previewIn var(--anim-slow) var(--anim-ease) both;
    }
    .line-preview-wrap.is-closing .line-preview{
      animation:previewOut var(--anim-slow) var(--anim-ease) both;
      pointer-events:none;
    }
    .line-preview-info{
      border:1px solid #2c2c2c;
      background:rgba(18,18,18,.98);
      padding:10px;
      width:100%;
      box-sizing:border-box;
      position:relative;
      overflow:hidden;
      isolation:isolate;
      pointer-events:auto;
    }
    .line-preview-info::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      background:rgba(18,18,18,.98);
      backdrop-filter:blur(22px) saturate(1.3);
      -webkit-backdrop-filter:blur(22px) saturate(1.3);
    }
    .line-preview-info > *{
      position:relative;
      z-index:1;
    }
    .line-preview-info-header{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .line-preview-info-text{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
      flex:1 1 auto;
    }
    .line-preview .dbus-badge {
      width:72px;
      min-width:72px;
      height:30px;
      padding:0 8px;
      box-sizing:border-box;
      font-size:18px;
      font-variant-numeric:tabular-nums;
      align-self:flex-start;
    }
    .line-preview-route{
      color:var(--text);
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .line-preview-meta{
      color:#a5a5a5;
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .line-preview-stops{
      --lineColor:#8a8a8a;
      background:rgba(18,18,18,.98);
      padding:5px;
      width:max-content;
      max-width:calc(100vw - 48px);
      box-sizing:border-box;
      border:1px solid #2c2c2c;
      position:relative;
      overflow:hidden;
      isolation:isolate;
      pointer-events:auto;
    }
    .line-preview-scroll-cue{
      position:absolute;
      left:6px;
      right:6px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:3;
      opacity:0;
      transition:opacity var(--anim-fast) var(--anim-ease);
    }
    .line-preview-scroll-cue::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
    }
    .line-preview-scroll-cue > span{
      position:relative;
      z-index:1;
      color:var(--lineColor, #8a8a8a);
      font-size:26px;
      font-weight:900;
      text-shadow:0 2px 6px rgba(0,0,0,.65);
      letter-spacing:.02em;
      opacity:.98;
      line-height:1;
    }
    .line-preview-scroll-cue.top{top:4px}
    .line-preview-scroll-cue.top::before{
      background:linear-gradient(to bottom, rgba(12,12,12,.75), rgba(12,12,12,0));
    }
    .line-preview-scroll-cue.bottom{bottom:4px}
    .line-preview-scroll-cue.bottom::before{
      background:linear-gradient(to top, rgba(12,12,12,.75), rgba(12,12,12,0));
    }
    .line-preview-stops.can-scroll-up .line-preview-scroll-cue.top,
    .line-preview-stops.can-scroll-down .line-preview-scroll-cue.bottom{
      opacity:1;
      pointer-events:auto;
      cursor:pointer;
    }
    .line-preview-stops.can-scroll-up .line-preview-scroll-cue.top > span{
      animation:scrollCuePulse 1.2s ease-in-out infinite, scrollCueNudgeUp 1.2s ease-in-out infinite;
    }
    .line-preview-stops.can-scroll-down .line-preview-scroll-cue.bottom > span{
      animation:scrollCuePulse 1.2s ease-in-out infinite, scrollCueNudgeDown 1.2s ease-in-out infinite;
    }
    .line-preview-stops::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      background:rgba(18,18,18,.28);
      backdrop-filter:blur(55px) saturate(1.3);
      -webkit-backdrop-filter:blur(55px) saturate(1.3);
    }
    .line-preview-stops > *{
      position:relative;
      z-index:1;
    }
    .line-preview-close{ border:none;background:transparent;color:#ef4444;font-weight:900; font-size:22px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:8px; }
    .line-preview-close:hover{ color:#ff6666; background:rgba(28,28,28,.45); }
    .line-preview-actions{ display:flex; align-items:center; gap:6px; flex:0 0 auto; margin-left:auto; }
    .line-preview-link{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border-radius:8px;
      border:1px solid #2c2c2c; background:transparent; color:#a5a5a5;
      text-decoration:none; cursor:pointer;
    }
    .line-preview-link:hover{ background:rgba(28,28,28,.45); color:#f2f2f2; }
    .line-preview-link svg{ width:16px; height:16px; display:block; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .line-preview{
      --lp-logo-h:36px;
      --lp-chip-ratio:2.25;
    }
    .line-preview .network-badge{
      align-items:stretch;
      height:var(--lp-logo-h);
    }
    .line-preview .network-badge img{
      height:100%;
      width:auto;
    }
    .line-preview .network-badge .dbus-badge,
    .line-preview .network-badge .network-chip,
    .line-preview .network-badge .titus-chip{
      --_lp-chip-ratio:var(--lp-chip-ratio);
      height:var(--lp-logo-h) !important;
      min-height:var(--lp-logo-h) !important;
      width:calc(var(--lp-logo-h) * var(--_lp-chip-ratio)) !important;
      min-width:calc(var(--lp-logo-h) * var(--_lp-chip-ratio)) !important;
      box-sizing:border-box;
      padding:0 8px;
    }
    .line-preview .network-badge .network-chip.network-chip-express{
      --_lp-chip-ratio:3.2;
    }

    .transit-scroll{
      overflow-x:auto;
      overflow-y:auto;
      white-space:normal;
      max-height:min(130vh,620px);
      padding-right:4px;
      width:max-content;
      max-width:calc(100vw - 64px);
      box-sizing:border-box;
      direction:rtl;
    }
    .transit{
      --lineColor:#8a8a8a;
      --lineX:14px;
      --dot:14px;
      --gapY:8px;
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:var(--gapY);
      min-height:0;
      padding:1px 0 4px;
      width:max-content;
      direction:ltr;
    }
    .transit-main-line{
      position:absolute;
      top:0;
      left:calc(var(--lineX) - 2px);
      width:4px;
      height:0;
      border-radius:2px;
      background:var(--lineColor);
      pointer-events:none;
      z-index:0;
    }

    .stop{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      flex:0 0 auto;
      box-sizing:border-box;
      width:max-content;
      min-height:var(--dot);
      padding-left:30px;
      padding-right:2px;
      z-index:1;
    }
    .stop .dot{
      position:absolute;
      left:var(--lineX);
      top:0;
      transform:translateX(-50%);
      width:var(--dot);
      height:var(--dot);
      border-radius:50%;
      background:var(--lineColor);
      border:none; box-shadow:0 1px 2px rgba(0,0,0,.5); }
    .stop.first .dot,
    .stop.last .dot{
      background:#fff;
      border:2px solid #000;
      box-sizing:border-box;
    }
    .stop.first .dot::after,
    .stop.last .dot::after{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      width:5px;
      height:5px;
      border-radius:50%;
      background:var(--lineColor);
      transform:translate(-50%,-50%);
    }
    .stop .name{
      color:var(--text);
      font-size:11px;
      line-height:1.3;
      display:inline-block;
      width:auto;
      min-width:auto;
      text-align:left;
      margin-top:0;
      font-weight:700;
      max-width:none;
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;
    }
    .stop-flag{
      font-size:8px;
      color:#fbbf24;
      background:rgba(251,191,36,0.2);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:2px 6px;
      margin-left:6px;
      white-space:nowrap;
      display:inline-block;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    .stop .name .inline-ico{ height:1em; vertical-align:-.2em; }
    .stop.active .name{ color:#ffda3a; }

    @media (max-width:800px){
      .transit-scroll{max-height:min(44vh,280px)}
      .stop{padding-left:34px}
    }

    .rer-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background-color: currentColor;
      -webkit-mask: var(--rer-mask-url) no-repeat center / contain;
              mask: var(--rer-mask-url) no-repeat center / contain;
    }
    .metro-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background: var(--metro-icon-url) no-repeat center / contain;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{
      display:inline-block; width:16px; height:16px;
      border:2px solid #8f8f8f; border-top-color:#ececec;
      border-radius:50%; animation:spin .8s linear infinite;
      vertical-align:-.2em;
    }

    .results::-webkit-scrollbar,
    .dbus-content::-webkit-scrollbar,
    .dbus-stop-content::-webkit-scrollbar,
    .transit-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
    .results::-webkit-scrollbar-track,
    .dbus-content::-webkit-scrollbar-track,
    .dbus-stop-content::-webkit-scrollbar-track,
    .transit-scroll::-webkit-scrollbar-track { background: var(--panel2); border-radius: 8px; }
    .results::-webkit-scrollbar-thumb,
    .dbus-content::-webkit-scrollbar-thumb,
    .dbus-stop-content::-webkit-scrollbar-thumb,
    .transit-scroll::-webkit-scrollbar-thumb {
      background: var(--muted); border-radius: 8px; border: 2px solid var(--panel2);
    }
    .results::-webkit-scrollbar-thumb:hover,
    .dbus-content::-webkit-scrollbar-thumb:hover,
    .dbus-stop-content::-webkit-scrollbar-thumb:hover,
    .transit-scroll::-webkit-scrollbar-thumb:hover { background: var(--text); }
    .results, .dbus-content, .dbus-stop-content, .transit-scroll { scrollbar-width: thin; scrollbar-color: var(--muted) var(--panel2); }
    .line-preview-stops .transit-scroll{
      scrollbar-width:none;
      -ms-overflow-style:none;
    }
    .line-preview-stops .transit-scroll::-webkit-scrollbar{
      width:0;
      height:0;
    }
    .line-preview-stops .transit-scroll::-webkit-scrollbar-track,
    .line-preview-stops .transit-scroll::-webkit-scrollbar-thumb{
      background:transparent;
      border:none;
    }
    body.line-preview-horizontal .line-preview-wrap{
      left:0;
      right:0;
      top:auto;
      bottom:0;
      transform:none;
      padding-bottom:env(safe-area-inset-bottom, 0);
    }
    body.line-preview-horizontal .line-preview-wrap.with-side-panel{
      right:min(var(--sidePanelW),50vw,94vw);
    }
    body.line-preview-horizontal .line-preview{
      margin:10px auto 12px;
      width:auto;
      max-width:min(1100px,94vw);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      pointer-events:auto;
      display:block;
    }
    body.line-preview-horizontal .line-preview-info{
      width:auto;
      max-width:none;
      border:0;
      padding:0;
      margin:0 0 8px;
      background:transparent;
      isolation:auto;
      overflow:visible;
    }
    body.line-preview-horizontal .line-preview-info::before{
      display:none;
    }
    body.line-preview-horizontal .line-preview-info-header{
      align-items:center;
    }
    body.line-preview-horizontal .line-preview .dbus-badge{
      width:auto;
      min-width:56px;
      height:28px;
      padding:4px 10px;
      font-size:18px;
    }
    body.line-preview-horizontal .line-preview{
      --lp-logo-h:28px;
    }
    body.line-preview-horizontal .line-preview-stops{
      width:auto;
      max-width:none;
      padding:0;
      border:0;
      background:transparent;
      isolation:auto;
      overflow:visible;
    }
    body.line-preview-horizontal .line-preview-stops::before{
      display:none;
    }
    body.line-preview-horizontal .line-preview-scroll-cue{
      display:none !important;
    }
    body.line-preview-horizontal .transit-scroll{
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      max-height:none;
      width:100%;
      max-width:none;
      padding-right:0;
      padding-bottom:4px;
      direction:ltr;
    }
    body.line-preview-horizontal .line-preview-stops .transit-scroll{
      scrollbar-width:thin;
      scrollbar-color:var(--muted) var(--panel2);
      -ms-overflow-style:auto;
    }
    body.line-preview-horizontal .line-preview-stops .transit-scroll::-webkit-scrollbar{
      width:10px;
      height:10px;
    }
    body.line-preview-horizontal .line-preview-stops .transit-scroll::-webkit-scrollbar-track{
      background:var(--panel2);
      border-radius:8px;
    }
    body.line-preview-horizontal .line-preview-stops .transit-scroll::-webkit-scrollbar-thumb{
      background:var(--muted);
      border-radius:8px;
      border:2px solid var(--panel2);
    }
    body.line-preview-horizontal .line-preview-stops .transit-scroll::-webkit-scrollbar-thumb:hover{
      background:var(--text);
    }
    body.line-preview-horizontal .transit{
      --rail-h:26px;
      --dot:16px;
      --gap:50px;
      --nameH:18px;
      position:relative;
      display:flex;
      flex-direction:row;
      align-items:flex-start;
      gap:0;
      min-height:calc(var(--rail-h) + var(--nameH) + 14px);
      padding:2px 2px 6px;
      width:max-content;
      direction:ltr;
    }
    body.line-preview-horizontal .transit-main-line{
      top:calc(var(--rail-h)/2 - 2px);
      left:0;
      width:0;
      height:4px;
      border-radius:2px;
    }
    body.line-preview-horizontal .stop{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      flex:0 0 auto;
      box-sizing:border-box;
      width:auto;
      min-height:0;
      padding-top:calc(var(--rail-h) - var(--dot)/2);
      padding-left:0;
      padding-right:0;
      margin:0 calc(var(--gap)/2);
      z-index:1;
    }
    body.line-preview-horizontal .stop .dot{
      position:absolute;
      left:50%;
      top:calc(var(--rail-h)/2 - var(--dot)/2);
      transform:translateX(-50%);
      width:var(--dot);
      height:var(--dot);
    }
    body.line-preview-horizontal .stop .name{
      color:var(--text);
      font-size:12px;
      line-height:1.3;
      text-align:center;
      margin-top:8px;
      font-weight:700;
      max-width:110px;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
    }
    body.line-preview-horizontal .stop-flag{
      margin-left:0;
    }

    .result-sechead{ display:flex;align-items:center;justify-content:space-between; cursor:pointer; user-select:none; }
    .result-sechead .chev{ font-size:14px; opacity:.9; transition:transform .18s ease; }
    .result-sechead[aria-expanded="false"] .chev{ transform:rotate(-90deg); }
    .result-secbody[hidden]{ display:none !important; }
    
    .results-filters,
    .search-categories{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      width:100%;
    }
    .search-categories .dbus-mode-btn{
      padding:6px 10px;
      font-size:12px;
    }

    .result-sechead{ display:block; cursor:default; user-select:text; }
    .result-sechead .chev{ display:none !important; }

    .dbus-badge {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      background:#444;
      color:#fff;
      padding:6px 14px;
      border-radius:8px;
      min-width:48px;
      text-align:center;
      position:relative; 
    }
    
    .titus-chip{
      height:32px;
      padding:0 8px;
      font-size:16px;
      min-width:72px;
      width:72px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      font-variant-numeric:tabular-nums;
    }
    .network-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .network-badge img{
      height:36px;
      width:auto;
      object-fit:contain;
    }
    .network-logo-invert{
      filter: invert(1);
    }
    .network-chip{
      min-width:72px;
      width:72px;
      height:32px;
      padding:0 8px;
      font-size:16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      font-variant-numeric:tabular-nums;
    }
    .line-preview .network-chip-express{
      min-width:116px;
      width:116px;
    }
    #lpBadge.lp-badge-wrapper{
      display:flex;
      align-items:center;
      background:transparent;
      padding:0;
    }
    
    .dbus-badge .noctilien-stripe {
      position:absolute;
      left:0; right:0; bottom:0;
      height:4px;
      border-bottom-left-radius:8px;
      border-bottom-right-radius:8px;
    }
    .has-noctilien-stripe .badge-label{
      transform:translateY(-1px);
    }

    .route-flag {
      font-size:8px;
      color:#fbbf24;
      background:rgba(255, 255, 255, 0.15);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:1px 5px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .badge.fictive {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-top: 10px;
      box-sizing: border-box;
    }

    .badge .fictive-stripe {
      position: absolute;
      top: 2px;
      left: 6px;
      right: 6px;
      height: 10px;
      border-radius: 4px;
      background: #000000;
      color: #fff;
      font-size: 8px;
      font-weight: 600;
      text-align: center;
      line-height: 10px;
      text-transform: uppercase;
      pointer-events: none;
      overflow: hidden;
      white-space: nowrap;
    }

    .badge-label {
      display: inline-block;
      white-space: nowrap;
      line-height: 1;
      position: relative;
      z-index: 1;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }

    .results {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }

    .custom-scale {
      position: relative;
      height: 8px;
      margin: 10px;
      background: transparent;
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,.8);
      width: fit-content;
    }

    .custom-scale .bar {
      height: 3px;
      background: var(--text);
      border-radius: 2px;
    }

    .custom-scale span {
      position: absolute;
      top: -18px;
      left: 0;
    }

    @keyframes sidePanelIn{
      from{opacity:0;transform:translateX(22px)}
      to{opacity:1;transform:translateX(0)}
    }
    @keyframes sidePanelOut{
      from{opacity:1;transform:translateX(0)}
      to{opacity:0;transform:translateX(22px)}
    }
    @keyframes searchPanelIn{
      from{opacity:0;transform:translateY(-8px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes searchPanelOut{
      from{opacity:1;transform:translateY(0)}
      to{opacity:0;transform:translateY(-8px)}
    }
    @keyframes modalPanelIn{
      from{opacity:0;transform:translate(-50%,-47%) scale(.985)}
      to{opacity:1;transform:translate(-50%,-50%) scale(1)}
    }
    @keyframes modalPanelOut{
      from{opacity:1;transform:translate(-50%,-50%) scale(1)}
      to{opacity:0;transform:translate(-50%,-47%) scale(.985)}
    }
    @keyframes previewIn{
      from{opacity:0;transform:translateY(12px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes previewOut{
      from{opacity:1;transform:translateY(0)}
      to{opacity:0;transform:translateY(12px)}
    }
    @keyframes scrollCuePulse{
      0%,100%{opacity:.35}
      50%{opacity:1}
    }
    @keyframes scrollCueNudgeUp{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-3px)}
    }
    @keyframes scrollCueNudgeDown{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(3px)}
    }

    body.animations-off *,
    body.animations-off *::before,
    body.animations-off *::after{
      animation:none !important;
      transition:none !important;
      scroll-behavior:auto !important;
    }
    @media (max-width:1200px){
      .map-topbar{left:12px;right:12px}
      .search-panel{left:0;right:0}
    }
    @media (max-width:980px){
      :root{
        --sitebar-height:52px;
        --mapbar-height:56px;
      }
      .map-topbar{left:12px;right:12px}
      .search-panel{left:0;right:0}
      .map-topbar-row{
        width:100%;
        max-width:none;
        flex-wrap:nowrap;
        min-height:var(--mapbar-height);
      }
      .map-topbar-row .search-input{
        position:static;
        left:auto;
        transform:none;
        width:auto;
        max-width:none;
        min-width:0;
        flex:1 1 auto;
        order:0;
      }
      .top-actions{
        order:0;
        margin-left:auto;
        width:auto;
        flex:0 0 auto;
      }
      .map-topbar.dbus-open{transform:none}
      .top-actions.dbus-open,
      body.side-panel-resizing .top-actions.dbus-open{transform:none}
      .watermark.dbus-open{transform:none}
      #btnSettings{width:44px;justify-content:center}
      .results{max-height:50vh}
      #dbusPanel{
        top:var(--site-header-h);
        left:0;
        right:0;
        transform:none;
        width:100%;
        max-width:none;
        height:calc(100vh - var(--site-header-h));
        max-height:calc(100vh - var(--site-header-h));
      }
      #settingsPanel{
        top:var(--site-header-h);
        left:0;
        right:0;
        transform:none;
        width:100%;
        max-width:none;
        height:calc(100vh - var(--site-header-h));
        max-height:calc(100vh - var(--site-header-h));
      }
      .line-preview-wrap{
        left:0;
        right:0;
        top:calc(var(--header-stack-h) + 18px);
        bottom:auto;
        transform:none;
        padding-top:0;
      }
      .line-preview-wrap.with-side-panel{right:0}
      .line-preview{
        margin:8px auto 10px;
        width:max-content;
        max-width:min(760px,94vw);
      }
      #dbusPanel .dbus-routes-box{
        flex:1 1 auto;
        min-height:170px;
        max-height:none;
      }
      .side-panel-resizer{display:none}
      #searchPanel.search-panel-modal{
        left:0;
        right:0;
        transform:none;
        width:auto;
        max-width:none;
      }
      .dbus-header{flex-wrap:wrap;align-items:flex-start}
      .dbus-mode-group{width:100%;flex-wrap:wrap;justify-content:flex-start}
      .dbus-modes{flex-wrap:wrap}
      .dbus-mode-btn{padding:6px 12px;font-size:12px}
      .dbus-footer{flex-wrap:wrap}
    }
    @media (max-width:700px){
      .dbus-panel,.dbus-stop-panel{border-radius:16px}
      #dbusPanel{border-radius:0}
      .dbus-header{gap:8px;font-size:14px}
      .dbus-header .dbus-title{font-size:18px}
      .dbus-grid{grid-template-columns:repeat(auto-fill,72px)}
      .dbus-double{grid-template-columns:1fr}
      .dbus-item{flex-wrap:wrap;gap:8px}
      .dbus-item .badge{width:64px;height:28px;font-size:14px}
      .dbus-route-logo{width:38px;height:22px}
      .line-preview{padding:8px 10px;margin:8px auto 10px}
      .line-preview .dbus-badge{
        width:64px;
        min-width:64px;
        height:28px;
        padding:0 6px;
        font-size:16px;
      }
      .line-preview .network-chip-express{width:96px;min-width:96px}
      .line-preview-route{font-size:13px}
      .stop .name{font-size:11px;max-width:100%}
      .watermark img{width:150px}
    }
    @media (max-width:520px){
      :root{
        --topbar-top:0px;
        --sitebar-height:52px;
        --mapbar-height:56px;
        --topbar-gap:8px;
      }
      .map-topbar{left:8px;right:8px}
      .search-panel{left:0;right:0}
      .map-topbar{padding:0 8px;border-radius:12px}
      .map-topbar-row{gap:6px}
      .btn{padding:10px 12px;font-size:13px}
      .search-input{padding:10px 12px;font-size:14px}
      .dbus-panel{padding:10px 12px}
      #dbusPanel{padding:0}
      .dbus-footer{padding:8px 10px}
      .dbus-group-label{font-size:10px}
      .dbus-switch{padding:3px 6px}
      .dbus-switch-label{font-size:11px}
      .dbus-route-logo{width:34px;height:20px}
      .results{max-height:55vh}
    }
    @media (max-height:700px){
      .dbus-panel,.dbus-stop-panel{height:92vh}
    }

    .analysis-hud{
      position:fixed; right:8px; bottom:6px; z-index:1500;
      color:#ffffff; font-size:5px; font-weight:600; letter-spacing:.02em;
      background:rgba(11,17,24,0.6); border:1px solid rgba(255,255,255,0.05);
      border-radius:6px; padding:2px 4px; user-select:none; pointer-events:none;
    }

  </style>
  
</head>
<body>
  <div id="map"></div>

  <script src="config/config.js"></script>
  <script src="config/shared-header.js"></script>

  <div class="map-topbar" id="topBar">
    <div class="map-topbar-row">
      <input id="search" class="search-input" type="search" placeholder="Rechercher..." autocomplete="off" aria-label="Recherche"/>
      <div class="top-actions">
        <button id="btnDbus" class="btn icon-btn" type="button" aria-expanded="false" aria-label="Lignes Dbus World" title="Lignes Dbus World">
          <img id="btnDbusLogo" class="dbus-icon-logo" src="map_files/0.1.5a/Overlays/bus_logo_idfm.png" alt="" aria-hidden="true"/>
        </button>
        <button id="btnSettings" class="btn icon-btn" type="button" aria-expanded="false" aria-label="Parametres" title="Parametres">
          <svg class="settings-icon" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.7 1.7 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.7 1.7 0 0 0 15 19.4a1.7 1.7 0 0 0-1 .6 1.7 1.7 0 0 0-.4 1.1V21a2 2 0 1 1-4 0v-.1a1.7 1.7 0 0 0-.4-1.1 1.7 1.7 0 0 0-1-.6 1.7 1.7 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-.6-1 1.7 1.7 0 0 0-1.1-.4H2.8a2 2 0 1 1 0-4h.1a1.7 1.7 0 0 0 1.1-.4 1.7 1.7 0 0 0 .6-1 1.7 1.7 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.7 1.7 0 0 0 9 4.6a1.7 1.7 0 0 0 1-.6 1.7 1.7 0 0 0 .4-1.1V2.8a2 2 0 1 1 4 0v.1a1.7 1.7 0 0 0 .4 1.1 1.7 1.7 0 0 0 1 .6 1.7 1.7 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.7 1.7 0 0 0 19.4 9a1.7 1.7 0 0 0 .6 1 1.7 1.7 0 0 0 1.1.4h.1a2 2 0 1 1 0 4h-.1a1.7 1.7 0 0 0-1.1.4 1.7 1.7 0 0 0-.6 1z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="search-panel">
    <div id="dbusDepartIndicatorWrap" class="dbus-depart-indicator-wrap" hidden>
      <div class="dbus-depart-indicator" role="status" aria-live="polite">
        <span id="dbusDepartIndicatorLabel"></span>
        <button type="button" class="dbus-depart-close" id="dbusDepartIndicatorClose" aria-label="Désactiver">&times;</button>
      </div>
    </div>
    
    <div id="selectedChip" class="selected-chip"></div>

    <div id="searchPanel" class="dbus-panel search-panel-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="searchPanelTitle">
      <div class="dbus-header">
        <div class="dbus-title" id="searchPanelTitle">Recherche</div>
        <button type="button" class="line-preview-close dbus-close" id="searchPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="dbus-content">
        <div id="results" class="results results-panel" hidden></div>
      </div>
      <div class="dbus-footer">
        <span class="dbus-group-label" id="searchFilterLabel">Filtres</span>
        <div id="searchFilters"></div>
      </div>
    </div>

    <div id="dbusPanel" class="dbus-panel">
      <div class="side-panel-resizer" data-panel-resizer aria-hidden="true"></div>
      <div class="dbus-header">
        <div class="dbus-title" id="dbusPanelTitle">Lignes Dbus World</div>
        <a
          class="line-preview-link dbus-world-link"
          id="dbusWorldLink"
          data-offsite-key="dbus_world"
          href="#"
          target="_blank"
          rel="noopener"
          aria-label="Ouvrir le lien"
          title="Ouvrir le lien"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
          </svg>
        </a>
        <button type="button" class="line-preview-close dbus-close" id="dbusPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="dbus-layout">
        <div class="dbus-box dbus-lines-box">
          <div class="dbus-box-title" id="dbusLinesTitle">Lignes</div>
          <div class="dbus-content">
            <div id="dbusList" class="dbus-list"></div>
            <div id="dbusDepartActions" class="dbus-depart-actions" hidden>
              <button type="button" id="dbusDepartMapBtn" class="dbus-depart-map-btn"></button>
            </div>
            <div id="dbusDepartList" class="dbus-list"></div>
          </div>
        </div>
        <div class="dbus-box dbus-routes-box" id="dbusRoutesBox">
          <div class="dbus-box-title" id="dbusRoutesTitle">
            <span class="dbus-box-title-label" id="dbusRoutesTitleLabel">Liste des routes</span>
            <button type="button" class="dbus-box-clear" id="dbusRoutesClear" aria-label="Désélectionner" hidden>&times;</button>
          </div>
          <div class="dbus-content">
            <div id="dbusRoutesList" class="dbus-list"></div>
          </div>
        </div>
        <div class="dbus-footer">
          <div class="dbus-footer-row">
            <span class="dbus-group-label" id="dbusFilterLabel">Filtres</span>
            <div class="dbus-filters">
              <label class="dbus-switch">
                <span class="dbus-switch-label" id="dbusSchoolLabel">Scolaires</span>
                <input type="checkbox" id="dbusSchoolToggle">
              </label>
              <label class="dbus-switch">
                <span class="dbus-switch-label" id="dbusFictiveLabel">Fictives</span>
                <input type="checkbox" id="dbusFictiveToggle">
              </label>
            </div>
          </div>
          <div class="dbus-footer-row">
            <span class="dbus-group-label" id="dbusSortLabel">Trier par (Lignes)</span>
            <div class="dbus-modes dbus-sort-modes" id="dbusSortModes" role="tablist" aria-label="Trier par">
              <button type="button" class="dbus-mode-btn active" data-mode="lines" aria-pressed="true">Catégorie</button>
              <button type="button" class="dbus-mode-btn" data-mode="length" aria-pressed="false">Longueur</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="settingsPanel" class="dbus-panel" aria-hidden="true" aria-labelledby="settingsPanelTitle">
      <div class="side-panel-resizer" data-panel-resizer aria-hidden="true"></div>
      <div class="dbus-header">
        <div class="dbus-title" id="settingsPanelTitle">Parametres</div>
        <button type="button" class="line-preview-close dbus-close" id="settingsPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="dbus-content">
        <div class="settings-category">
          <h3 class="settings-group-title" id="settingsWebCategoryTitle">PAGE WEB</h3>
          <section class="settings-sec">
            <h4 class="settings-title" id="settingsAnimationsTitle">General</h4>
            <div class="dbus-filters">
              <label class="dbus-switch">
                <span class="dbus-switch-label" id="settingsAnimationsLabel">Animations des menus</span>
                <input type="checkbox" id="settingsAnimationsToggle" checked>
              </label>
              <label class="dbus-switch" id="settingsTranslateStopsRow">
                <span class="dbus-switch-label" id="settingsTranslateStopsLabel">Traduire les arrêts</span>
                <input type="checkbox" id="settingsTranslateStopsToggle">
              </label>
            </div>
          </section>
          <section class="settings-sec" id="settingsMapVersionSection" hidden>
            <h4 class="settings-title" id="settingsMapVersionTitle">Version de la carte</h4>
            <div class="settings-map-version-row">
              <select id="settingsMapVersionSelect" class="settings-map-version-select"></select>
            </div>
          </section>
        </div>
        <div class="settings-category">
          <h3 class="settings-group-title" id="settingsDbusCategoryTitle">PANNEAU DE LIGNES DBUS</h3>
          <section class="settings-sec">
            <h4 class="settings-title" id="settingsCenteringTitle">General</h4>
            <div class="dbus-filters">
              <label class="dbus-switch">
                <span class="dbus-switch-label" id="settingsCenterLineLabel">Centrer sur la ligne sélectionnée</span>
                <input type="checkbox" id="settingsCenterLineToggle" checked>
              </label>
            </div>
          </section>
          <section class="settings-sec">
            <h4 class="settings-title" id="settingsPreviewLayoutTitle">Aperçu de ligne</h4>
            <div class="dbus-footer-row">
              <div class="dbus-modes dbus-sort-modes" id="settingsPreviewLayoutModes" role="tablist" aria-label="Orientation de l'aperçu de ligne">
                <button type="button" class="dbus-mode-btn active" data-preview-layout="vertical" aria-pressed="true">Vertical</button>
                <button type="button" class="dbus-mode-btn" data-preview-layout="horizontal" aria-pressed="false">Horizontal</button>
              </div>
            </div>
          </section>
        </div>
        <div class="settings-legend" id="settingsLeafletLegend" aria-labelledby="settingsLeafletLegendTitle">
          <h3 class="settings-group-title" id="settingsLeafletLegendTitle">Légende</h3>
          <div class="settings-legend-list">
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="overlay_monument.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendMonumentLabel">Lieux emblématiques</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="overlay_centrecom.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendMallLabel">Centres commerciaux</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="service_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendRepairLabel">Ateliers de réparation</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="recruitment_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendAgencyLabel">Agences de recrutement</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="dealer_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendDealerLabel">Concessionnaires</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="garage_large_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendGarageLabel">Garages</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="gas_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendGasLabel">Station service</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="bus_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendBusStationLabel">Gare routière</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="border_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendBorderLabel">Contrôle d'identité</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="toll_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendTollLabel">Péage</span>
            </div>
            <div class="settings-legend-item">
              <img class="settings-legend-icon" data-overlay-src="parking_ico.png" alt="" aria-hidden="true"/>
              <span class="settings-legend-label" id="settingsLegendParkingLabel">Parking</span>
            </div>
            <div class="settings-legend-item settings-legend-item-toggle">
              <div class="settings-legend-item-main">
                <img class="settings-legend-icon" data-overlay-src="bus_logo_idfm.png" alt="" aria-hidden="true"/>
                <span class="settings-legend-label" id="settingsLegendBusStopsLabel">Arrêts de bus</span>
                <span class="lang-toggle-badge settings-legend-exp" id="settingsLegendBusStopsBadge">Expérimental</span>
              </div>
              <label class="dbus-switch settings-legend-switch">
                <span class="dbus-switch-label" id="settingsLegendBusStopsToggleLabel">Afficher</span>
                <input type="checkbox" id="settingsBusStopsToggle">
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dbusStopPanel" class="dbus-stop-panel">
    <div class="dbus-header">
      <div class="dbus-title" id="dbusStopTitle">Arrêt</div>
      <button type="button" class="line-preview-close dbus-close" id="dbusStopClose" aria-label="Fermer">&times;</button>
    </div>
    <div class="dbus-stop-content">
      <div id="dbusStopList" class="dbus-list"></div>
    </div>
  </div>

  <div id="linePreviewWrap" class="line-preview-wrap" style="display:none">
    <div class="line-preview" id="linePreview">
      <div class="line-preview-info">
        <div class="line-preview-info-header">
          <div class="dbus-badge" id="lpBadge">?</div>
          <div class="line-preview-info-text">
            <div class="line-preview-route" id="lpRouteTitle">-</div>
            <div class="line-preview-meta" id="lpRouteMeta">-</div>
          </div>
          <div class="line-preview-actions">
            <a class="line-preview-link" id="lpLink" href="" target="_blank" rel="noopener" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
            </a>
            <button type="button" class="line-preview-close" id="lpClose" aria-label="Fermer">X</button>
          </div>
        </div>
      </div>
      <div class="line-preview-stops">
        <div class="line-preview-scroll-cue top" role="button" tabindex="0" aria-label="Monter d'un arrêt"><span>▲</span></div>
        <div class="transit-scroll">
          <div class="transit" id="lpTransit"></div>
        </div>
        <div class="line-preview-scroll-cue bottom" role="button" tabindex="0" aria-label="Descendre d'un arrêt"><span>▼</span></div>
      </div>
    </div>
  </div>

  <div class="watermark">
    <img id="watermarkLogo" src="" alt="IDF Logo">
    <div id="watermarkVersionLabel" class="watermark-version"></div>
  </div>

  <!-- <div id="analysisHUD" class="analysis-hud"></div>*/ -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="config/translations.js"></script>
  <script src="config/site-nav.js"></script>

  <script>

  const LINE_STYLES = {
    "24":         ["#ab5798", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-24/"],
    "63":         ["#cdc74f", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-63/"],
    "109":        ["#cdc74f", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-109/"],
    "112":        ["#e69459", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-112/"],
    "114":        ["#8cc299", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-114/"],
    "121":        ["#d63e34", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-121/"],
    "124":        ["#e6a4b2", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-124/"],
    "210":        ["#fecd08", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-210/"],
    "221":        ["#e7a5b3", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-221/"],
    "303":        ["#99974a", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-303/"],
    "325":        ["#9ad1dc", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-325/"],
    "351":        ["#d7b152", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-351/"],
    "FLIXBUS":    ["#a7d245", "#FFFFFF","https://www.flixbus.fr/"],
    "N11":        ["#e9682a", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n11"],
    "N23":        ["#d09835", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n23"],
    "N33":        ["#e9682a", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n33"],
    "Titus 1":    ["#e63b20", "#FFFFFF","https://www.rosnysousbois.fr/mobilites/le-titus/"],
    "Titus 2":    ["#49713e", "#FFFFFF","https://www.rosnysousbois.fr/mobilites/le-titus/"],
    "Fictives":   ["#cfcfcf", "#221f20",""],
    "Autocar":    ["#cfcfcf", "#221f20",""],
    "Scolaire":   ["#f0c748", "#221f20",""],
    "Express":    ["#6fb2e1", "#FFFFFF",""],
    "Express 75": ["#6fb2e1", "#FFFFFF",""],
    "Express 77": ["#6fb2e1", "#FFFFFF",""],
    "Express 93": ["#6fb2e1", "#FFFFFF",""],
    "Express 94": ["#6fb2e1", "#FFFFFF",""],
  };

  const I18N = window.I18N || {};
  const I18N_COMPAT_PATCH = window.I18N_COMPAT_PATCH || {};
  Object.entries(I18N_COMPAT_PATCH).forEach(([code, patch]) => {
    if (!I18N[code]) return;
    Object.entries(patch).forEach(([key, value]) => {
      const current = I18N[code][key];
      if (typeof current !== "string" || !current.trim()) {
        I18N[code][key] = value;
        return;
      }
      if (current === key) {
        I18N[code][key] = value;
        return;
      }
      if (code === "en") return;
      const enValue = I18N.en && typeof I18N.en[key] === "string" ? I18N.en[key] : "";
      if (enValue && current === enValue) {
        I18N[code][key] = value;
      }
    });
  });
  const LANG_OPTIONS = [
    { code: "fr", label: "Français", flagSrc: "https://flagcdn.com/w40/fr.png" },
    { code: "en", label: "English", flagSrc: "https://flagcdn.com/w40/gb.png" },
    { code: "es", label: "Español", flagSrc: "https://flagcdn.com/w40/es.png" },
    { code: "de", label: "Deutsch", flagSrc: "https://flagcdn.com/w40/de.png" },
    { code: "pl", label: "Polski", flagSrc: "https://flagcdn.com/w40/pl.png" },
    { code: "pt", label: "Português", flagSrc: "https://flagcdn.com/w40/pt.png" },
    { code: "nl", label: "Nederlands", flagSrc: "https://flagcdn.com/w40/nl.png" },
    { code: "it", label: "Italiano", flagSrc: "https://flagcdn.com/w40/it.png" },
    { code: "ru", label: "Русский", flagSrc: "https://flagcdn.com/w40/ru.png" },
    { code: "zh", label: "中文", flagSrc: "https://flagcdn.com/w40/cn.png" },
    { code: "ko", label: "한국어", flagSrc: "https://flagcdn.com/w40/kr.png" },
    { code: "ja", label: "日本語", flagSrc: "https://flagcdn.com/w40/jp.png" }
  ];
  const LANG_META = Object.fromEntries(LANG_OPTIONS.map(entry => [entry.code, entry]));
  const SUPPORTED = new Set(LANG_OPTIONS.map(entry => entry.code));
  function detectInitialLang(){
    const qs = new URLSearchParams(location.search);
    const fromURL = (qs.get("lang")||"").toLowerCase();
    if (SUPPORTED.has(fromURL)) return fromURL;
    const stored = localStorage.getItem("idf_lang");
    if (SUPPORTED.has(stored)) return stored;
    const nav = (navigator.language||"fr").slice(0,2).toLowerCase();
    return SUPPORTED.has(nav) ? nav : "fr";
  }
  let LANG = detectInitialLang();
  const STOP_TYPE_TRANSLATION_KEY = "idf_translate_stop_types";
  const UI_ANIMATIONS_KEY = "idf_ui_animations";
  const LINE_PREVIEW_LAYOUT_KEY = "idf_line_preview_layout";
  const CENTER_ON_LINE_SELECT_KEY = "idf_center_on_line_select";
  const DBUS_STOP_ICONS_KEY = "idf_dbus_stop_icons";
  const LINE_PREVIEW_LAYOUTS = { VERTICAL: "vertical", HORIZONTAL: "horizontal" };
  let TRANSLATE_STOP_TYPES = (() => {
    const stored = localStorage.getItem(STOP_TYPE_TRANSLATION_KEY);
    return stored === "1" || stored === "true";
  })();
  let UI_ANIMATIONS = (() => {
    const stored = localStorage.getItem(UI_ANIMATIONS_KEY);
    return !(stored === "0" || stored === "false");
  })();
  let LINE_PREVIEW_LAYOUT = (() => {
    const stored = String(localStorage.getItem(LINE_PREVIEW_LAYOUT_KEY) || "").toLowerCase();
    return (stored === LINE_PREVIEW_LAYOUTS.HORIZONTAL) ? LINE_PREVIEW_LAYOUTS.HORIZONTAL : LINE_PREVIEW_LAYOUTS.VERTICAL;
  })();
  let CENTER_ON_LINE_SELECT = (() => {
    const stored = localStorage.getItem(CENTER_ON_LINE_SELECT_KEY);
    return !(stored === "0" || stored === "false");
  })();
  let DBUS_STOP_ICONS_ENABLED = (() => {
    const stored = localStorage.getItem(DBUS_STOP_ICONS_KEY);
    return stored === "1" || stored === "true";
  })();
  function t(key){ return (I18N[LANG] && I18N[LANG][key]) || (I18N.fr[key]||key); }
  const SITE_NAV_TREE = Array.isArray(window.SITE_NAV_TREE) && window.SITE_NAV_TREE.length
    ? window.SITE_NAV_TREE
    : [
        {
          labelKey: "nav_group_maps",
          items: [
            { href: "./", labelKey: "nav_page_index" },
            { href: "test.html", labelKey: "nav_page_test" }
          ]
        }
      ];
  function closeSiteNavMenus(){
    window.sharedHeader?.closeSiteNavMenus?.();
  }
  function renderSiteNav(){
    window.sharedHeader?.renderSiteNav?.();
  }
  const STOP_PREFIXES = [
    { re: /^centre\s+de\s+protection\s+maternelle\s+et\s+infantile\b/i, key: "stop_centre_pmi" },
    { re: /^centre\s+aquanautique\b/i, key: "stop_centre_aquanautique" },
    { re: /^centre\s+aquatique\b/i, key: "stop_centre_aquatique" },
    { re: /^centre\s+commercial\b/i, key: "stop_centre_commercial" },
    { re: /^centre\s+municipal\b/i, key: "stop_centre_municipal" },
    { re: /^march[ée]\s+international\b/i, key: "stop_marche_international" },
    { re: /^parc\s+floral\b/i, key: "stop_parc_floral" },
    { re: /^plateau\b/i, key: "stop_plateau" },
    { re: /^h(?:ô|o)tel\s+de\s+ville\b/i, key: "stop_hotel_de_ville" },
    { re: /^(?:é|e)cole\s+(?:élémentaire|elementaire)\b/i, key: "stop_ecole_elementaire" },
    { re: /^(?:é|e)l[ée]mentaire\b/i, key: "stop_ecole" },
    { re: /^(?:é|e)cole\s+primaire\b/i, key: "stop_ecole_primaire" },
    { re: /^(?:é|e)cole\s+maternelle\s+publique\b/i, key: "stop_ecole_maternelle_publique" },
    { re: /^(?:é|e)cole\s+maternelle\b/i, key: "stop_ecole_maternelle" },
    { re: /^cit[ée]\s+scolaire\b/i, key: "stop_cite_scolaire" },
    { re: /^(?:é|e)cole\b/i, key: "stop_ecole" },
    { re: /^coll[èe]ge\b/i, key: "stop_college" },
    { re: /^lyc[ée]e\s+polyvalent\b/i, key: "stop_lycee_polyvalent" },
    { re: /^lyc[ée]e\b/i, key: "stop_lycee" },
    { re: /^h[ôo]pital\b/i, key: "stop_hopital" },
    { re: /^(?:é|e)glise\b/i, key: "stop_eglise" },
    { re: /^square\b/i, key: "stop_square" },
    { re: /^all[ée]e\b/i, key: "stop_allee" },
    { re: /^chemin\b/i, key: "stop_chemin" },
    { re: /^tour\b/i, key: "stop_tour" },
    { re: /^ferme\s+p[ée]dagogique\b/i, key: "stop_ferme_pedagogique" },
    { re: /^ferme\b/i, key: "stop_ferme" },
    { re: /^minist[èe]re\s+de\s+l['’]?(?:é|e)conomie\s+et\s+des\s+finances\b/i, key: "stop_ministere_economie_finances" },
    { re: /^minist[èe]re\b/i, key: "stop_ministere" },
    { re: /^(?:é|e)changeur\b/i, key: "stop_echangeur" },
    { re: /^(?:cimetière|cimetiere)\b/i, key: "stop_cimetiere" },
    { re: /^(?:château|chateau)\b/i, key: "stop_chateau" },
    { re: /^gare\b/i, key: "stop_gare" },
    { re: /^piscine\b/i, key: "stop_piscine" },
    { re: /^stade\b/i, key: "stop_stade" },
    { re: /^mairie\b/i, key: "stop_mairie" },
    { re: /^pont\b/i, key: "stop_pont" },
    { re: /^porte\b/i, key: "stop_porte" },
    { re: /^place\b/i, key: "stop_place" },
    { re: /^avenue\b/i, key: "stop_avenue" },
    { re: /^rue\b/i, key: "stop_rue" },
    { re: /^parc\b/i, key: "stop_parc" },
    { re: /^centre\b/i, key: "stop_centre" },
    { re: /^maison\b/i, key: "stop_maison" },
    { re: /^jaune\b/i, key: "color_yellow" },
    { re: /^vert\b/i, key: "color_green" },
    { re: /^verte\b/i, key: "color_green" },
    { re: /^rouge\b/i, key: "color_red" },
    { re: /^bleu/i, key: "color_blue" },
    { re: /^bleue/i, key: "color_blue" },
    { re: /^orange\b/i, key: "color_orange" },
    { re: /^violet\b/i, key: "color_purple" },
    { re: /^violete\b/i, key: "color_purple" },
    { re: /^blanc\b/i, key: "color_white" },
    { re: /^blanche\b/i, key: "color_white" },
    { re: /^noir\b/i, key: "color_black" },
    { re: /^noire\b/i, key: "color_black" },
    { re: /^gris\b/i, key: "color_grey" },
    { re: /^grise\b/i, key: "color_grey" },
  ];
  const POSTFIX_LANGS = new Set(["en"]);
  function stripFrenchJoiners(text){
    let s = String(text || "").trim();
    let prev;
    do {
      prev = s;
      s = s.replace(/^(?:d['’]|de l['’]|de la|du|des|de|l['’]|la|le|les)\s*/i, "").trim();
    } while (s && s !== prev);
    return s;
  }
  function appendPostfix(base, postfix){
    const trimmed = String(base || "").trim();
    if (!trimmed) return postfix;
    const m = trimmed.match(/^(.*?)(\s*\([^)]*\))$/);
    if (m) {
      const main = (m[1] || "").trim();
      if (main) return `${main} ${postfix}${m[2]}`.replace(/\s+/g, " ").trim();
      return `${postfix}${m[2]}`.replace(/\s+/g, " ").trim();
    }
    return `${trimmed} ${postfix}`.replace(/\s+/g, " ").trim();
  }
  function endsWithWord(text, word){
    const t = String(text || "").trim();
    const w = String(word || "").trim();
    if (!t || !w) return false;
    const m = t.match(/^(.*?)(\s*\([^)]*\))$/);
    const core = (m ? m[1] : t).trim();
    const escaped = w.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return new RegExp(`\\b${escaped}$`, "i").test(core);
  }
  function startsWithWord(text, word){
    const t = String(text || "").trim();
    const w = String(word || "").trim();
    if (!t || !w) return false;
    const m = t.match(/^(.*?)(\s*\([^)]*\))$/);
    const core = (m ? m[1] : t).trim();
    const escaped = w.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return new RegExp(`^${escaped}\\b`, "i").test(core);
  }
  function translateDirectionTokens(text){
    if (!TRANSLATE_STOP_TYPES || LANG === "fr") return text;
    let s = String(text || "");
    const tokens = [
      { re: /\bnord\b/gi, key: "dir_north" },
      { re: /\bsud\b/gi, key: "dir_south" },
      { re: /\best\b/gi, key: "dir_east" },
      { re: /\bouest\b/gi, key: "dir_west" },
    ];
    tokens.forEach(({ re, key }) => { s = s.replace(re, t(key)); });
    return s;
  }
  function translateStopNameSegment(name, depth = 0){
    const raw = String(name || "").trim();
    if (!raw || !TRANSLATE_STOP_TYPES || LANG === "fr") return raw;
    if (depth > 2) return raw;
    for (const { re, key } of STOP_PREFIXES){
      if (re.test(raw)) {
        const translatedPrefix = t(key);
        const remainderRaw = raw.replace(re, "").trim();
        const remainderNoJoin = stripFrenchJoiners(remainderRaw);
        let remainderTranslated = remainderNoJoin ? translateStopNameSegment(remainderNoJoin, depth + 1) : "";
        remainderTranslated = translateDirectionTokens(remainderTranslated);
        if (POSTFIX_LANGS.has(LANG) && remainderTranslated) {
          if (endsWithWord(remainderTranslated, translatedPrefix)) return remainderTranslated;
          return appendPostfix(remainderTranslated, translatedPrefix);
        }
        if (remainderTranslated) {
          if (startsWithWord(remainderTranslated, translatedPrefix)) return remainderTranslated;
          return `${translatedPrefix} ${remainderTranslated}`.replace(/\s+/g, " ").trim();
        }
        return translatedPrefix;
      }
    }
    return raw;
  }
  function translateStopName(raw){
    const name = String(raw || "").trim();
    if (!name || !TRANSLATE_STOP_TYPES || LANG === "fr") return name;
    const parts = name.split(/(\s+[–—/]\s+|\s+-\s+)/);
    if (parts.length > 1) {
      const translated = parts.map(part => {
        if (/^\s*[-–—/]\s*$/.test(part)) return part;
        return translateStopNameSegment(part, 0);
      }).join("");
      return translateDirectionTokens(translated).replace(/\s+/g, " ").trim();
    }
    return translateDirectionTokens(translateStopNameSegment(name, 0)).replace(/\s+/g, " ").trim();
  }
  const I18N_LAYERS = [];
  function registerI18nLayer(layer, updater){
    if (!layer || typeof updater !== "function") return;
    I18N_LAYERS.push({ layer, updater });
  }
  function refreshI18nLayers(){
    I18N_LAYERS.forEach(entry => {
      const layer = entry.layer;
      if (!layer || typeof layer.getPopup !== "function") return;
      if (!layer.getPopup()) return;
      try { entry.updater(); } catch {}
    });
  }
  const SEARCH_CATEGORY_ALL = "ALL";
  const ALL_TYPES = [ "Ville","Monument","Atelier","Agence","Concessionnaire","Entreprise" ];
  let ACTIVE_SEARCH_CATEGORY = SEARCH_CATEGORY_ALL;
  let SEARCH_CATEGORY_COUNTS = Object.fromEntries(ALL_TYPES.map(t => [t, 0]));
  let SEARCH_CATEGORY_TOTAL = 0;
  function searchCategoryLabel(typeKey){
    const map = {
      "Ville": t("villes"),
      "Monument": t("emblematic"),
      "Atelier": t("repair_shops"),
      "Agence": t("agencies"),
      "Concessionnaire": t("dealers"),
      "Entreprise": t("companies")
    };
    return map[typeKey] || typeKey;
  }
  function searchCategoryDisplay(typeKey){
    if (typeKey === SEARCH_CATEGORY_ALL) return t("search_category_all");
    return searchCategoryLabel(typeKey);
  }
  function searchCategoryButtonLabel(typeKey){
    const label = searchCategoryDisplay(typeKey);
    const count = typeKey === SEARCH_CATEGORY_ALL
      ? SEARCH_CATEGORY_TOTAL
      : (SEARCH_CATEGORY_COUNTS[typeKey] ?? 0);
    return `${label} (${count})`;
  }
  function resultsEmptyText(){
    const label = searchCategoryDisplay(ACTIVE_SEARCH_CATEGORY);
    return t("results_empty_category").replace("{category}", label);
  }
  function langLabel(code){
    const meta = LANG_META[code];
    if (meta && meta.label) return meta.label;
    return String(code || "").toUpperCase();
  }
  function formatStopCount(count){
    const key = count === 1 ? "stop_count_singular" : "stop_count_plural";
    return t(key).replace("{count}", count);
  }
  function formatStopDuration(count, durationText, format = "paren"){
    const base = formatStopCount(count);
    if (!durationText) return base;
    if (format === "dash") return `${base} - ${durationText}`;
    return `${base} (${durationText})`;
  }
  const MINUTE_SHORT_LABELS = {
    fr: "min", en: "min", es: "min", de: "min", pl: "min", pt: "min",
    nl: "min", it: "min", ru: "мин", zh: "分", ko: "분", ja: "分"
  };
  function minuteShortLabel(){
    return MINUTE_SHORT_LABELS[LANG] || "min";
  }
  const NIGHT_BUS_LABELS = {
    fr: "Noctilien", en: "Night Bus", es: "Bus nocturno", de: "Nachtbus",
    pl: "Autobus nocny", pt: "Ônibus noturno", nl: "Nachtbus", it: "Bus notturno",
    ru: "Ночной автобус", zh: "夜间巴士", ko: "심야 버스", ja: "深夜バス"
  };
  const SCHOOL_BADGE_LABELS = {
    fr: "Scolaire", en: "School", es: "Escolar", de: "Schule",
    pl: "Szkolna", pt: "Escolar", nl: "School", it: "Scolastica",
    ru: "Школьный", zh: "校车", ko: "스쿨", ja: "スクール"
  };
  const EXPRESS_BADGE_LABELS = {
    fr: "Express", en: "Express", es: "Expres", de: "Express",
    pl: "Express", pt: "Expresso", nl: "Express", it: "Express",
    ru: "Экспресс", zh: "快线", ko: "급행", ja: "急行"
  };
  const FICTIVE_BADGE_LABELS = {
    fr: "Fictive", en: "Fictional", es: "Ficticia", de: "Fiktiv",
    pl: "Fikcyjna", pt: "Ficticia", nl: "Fictief", it: "Fittizia",
    ru: "Фиктивная", zh: "虚构", ko: "가상", ja: "架空"
  };
  const AUTOCAR_BADGE_LABELS = {
    fr: "Autocar", en: "Coach", es: "Autocar", de: "Reisebus",
    pl: "Autokar", pt: "Autocarro", nl: "Touringcar", it: "Pullman",
    ru: "Междугородний автобус", zh: "长途客车", ko: "장거리 버스", ja: "観光バス"
  };
  function localizedLabel(mapObj, fallback = ""){
    return mapObj[LANG] || mapObj.fr || fallback;
  }
  function normalizeBadgeToken(value){
    return String(value || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "")
      .trim();
  }
  function translatedNightBusLabel(){
    return localizedLabel(NIGHT_BUS_LABELS, t("dbus_sub_noctilien"));
  }
  function translateBadgeToken(value){
    const raw = String(value || "").trim();
    if (!raw) return raw;
    if (/^\d+$/.test(raw) || /^N\d+$/i.test(raw) || /^titus\s*\d+/i.test(raw)) return raw;
    const expressMatch = /^express\b\s*(.*)$/i.exec(raw);
    if (expressMatch) {
      const base = localizedLabel(EXPRESS_BADGE_LABELS, "Express");
      const suffix = String(expressMatch[1] || "").trim();
      return suffix ? `${base} ${suffix}` : base;
    }
    const normalized = normalizeBadgeToken(raw);
    if (normalized.startsWith("scolaire")) return localizedLabel(SCHOOL_BADGE_LABELS, t("dbus_school_toggle"));
    if (normalized.startsWith("fictive")) return localizedLabel(FICTIVE_BADGE_LABELS, t("dbus_fictive_toggle"));
    if (normalized.startsWith("noctilien") || normalized === "busdenuit") return translatedNightBusLabel();
    if (normalized.startsWith("autocar")) return localizedLabel(AUTOCAR_BADGE_LABELS, "Autocar");
    return raw;
  }
  function dbusCategoryTitle(key){
    if (key === "Express") return translateBadgeToken("Express");
    if (key === "urban") return t("dbus_sub_urban");
    if (key === "noctilien") return translatedNightBusLabel();
    if (key === "other_networks") return t("dbus_sub_other_networks");
    if (key === "others") return localizedLabel(AUTOCAR_BADGE_LABELS, "Autocar");
    if (key === "Scolaire") return translateBadgeToken("Scolaire");
    if (key === "Autres") return localizedLabel(AUTOCAR_BADGE_LABELS, "Autocar");
    if (key === "Urbain") return "IDFM";
    if (key === "Noctilien") return translatedNightBusLabel();
    if (key === "FlixBus") return "FlixBus";
    return key;
  }
  function setStopDurationText(el, stopCount, durationText, format){
    if (!el) return;
    el.dataset.stopCount = String(stopCount);
    el.dataset.durationText = String(durationText || "");
    el.dataset.durationFormat = format || "paren";
    el.textContent = formatStopDuration(stopCount, durationText, format);
  }
  function typeFallbackLabel(type){
    if (type === "Agence") return t("recruitment_agency");
    if (type === "Atelier") return t("repair_shop");
    if (type === "Garage") return t("garage");
    return type;
  }
  function setStopTypeTranslation(enabled, { persist = true, apply = true } = {}) {
    TRANSLATE_STOP_TYPES = !!enabled;
    if (persist) {
      localStorage.setItem(STOP_TYPE_TRANSLATION_KEY, TRANSLATE_STOP_TYPES ? "1" : "0");
    }
    if (apply) applyI18N();
  }
  function setUiAnimationsEnabled(enabled, { persist = true } = {}) {
    UI_ANIMATIONS = !!enabled;
    document.body.classList.toggle("animations-off", !UI_ANIMATIONS);
    if (persist) {
      localStorage.setItem(UI_ANIMATIONS_KEY, UI_ANIMATIONS ? "1" : "0");
    }
    const toggle = document.getElementById("settingsAnimationsToggle");
    if (toggle) toggle.checked = UI_ANIMATIONS;
  }
  function isLinePreviewHorizontal(){
    return LINE_PREVIEW_LAYOUT === LINE_PREVIEW_LAYOUTS.HORIZONTAL;
  }
  function setLinePreviewLayout(layout, { persist = true } = {}) {
    const next = (layout === LINE_PREVIEW_LAYOUTS.HORIZONTAL)
      ? LINE_PREVIEW_LAYOUTS.HORIZONTAL
      : LINE_PREVIEW_LAYOUTS.VERTICAL;
    LINE_PREVIEW_LAYOUT = next;
    document.body.classList.toggle("line-preview-horizontal", isLinePreviewHorizontal());
    if (persist) {
      localStorage.setItem(LINE_PREVIEW_LAYOUT_KEY, LINE_PREVIEW_LAYOUT);
    }
    document.querySelectorAll("#settingsPreviewLayoutModes .dbus-mode-btn[data-preview-layout]").forEach(btn => {
      const active = btn.dataset.previewLayout === LINE_PREVIEW_LAYOUT;
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
    });
    if (typeof refreshLinePreviewRail === "function") {
      try { refreshLinePreviewRail(); } catch {}
    }
    if (typeof updateLinePreviewScrollCues === "function") {
      try { updateLinePreviewScrollCues(); } catch {}
    }
  }
  function setCenterOnLineSelectEnabled(enabled, { persist = true } = {}) {
    CENTER_ON_LINE_SELECT = !!enabled;
    if (persist) {
      localStorage.setItem(CENTER_ON_LINE_SELECT_KEY, CENTER_ON_LINE_SELECT ? "1" : "0");
    }
    const toggle = document.getElementById("settingsCenterLineToggle");
    if (toggle) toggle.checked = CENTER_ON_LINE_SELECT;
  }
  function setDbusStopIconsEnabled(enabled, { persist = true, apply = true } = {}) {
    DBUS_STOP_ICONS_ENABLED = !!enabled;
    if (persist) {
      localStorage.setItem(DBUS_STOP_ICONS_KEY, DBUS_STOP_ICONS_ENABLED ? "1" : "0");
    }
    const toggle = document.getElementById("settingsBusStopsToggle");
    if (toggle) toggle.checked = DBUS_STOP_ICONS_ENABLED;
    if (apply && typeof renderDbusStopsLayer === "function") {
      try { renderDbusStopsLayer(); } catch {}
    }
  }
  function wikiBase(){ return LANG === "en" ? "https://en.wikipedia.org/wiki/" : "https://fr.wikipedia.org/wiki/"; }
  function buildLangMenu(){
    window.sharedHeader?.buildLangMenu?.();
  }
  function updateLangButtonUI(){
    window.sharedHeader?.updateLangButtonUI?.();
  }
  function setLangMenuOpen(open){
    window.sharedHeader?.setLangMenuOpen?.(open);
  }
  function isLangMenuOpen(){
    return !!window.sharedHeader?.isLangMenuOpen?.();
  }
  function openLangMenu(){
    window.sharedHeader?.openLangMenu?.();
  }
  function closeLangMenu(){
    window.sharedHeader?.closeLangMenu?.();
  }
  function toggleLangMenu(){ window.sharedHeader?.toggleLangMenu?.(); }
  function dbusLinesPanelTitleByMode(){
    return t("dbus_button");
  }
  function updateDbusPanelTitles(){
    const title = dbusLinesPanelTitleByMode();
    const panelTitle = document.getElementById("dbusPanelTitle");
    if (panelTitle) panelTitle.textContent = title;
    const linesTitle = document.getElementById("dbusLinesTitle");
    if (linesTitle) linesTitle.textContent = t("dbus_lines_title");
  }
  function updateLangUI(){
    updateLangButtonUI();
    const btnSettings = document.getElementById("btnSettings");
    if (btnSettings) {
      const label = t("settings_button");
      btnSettings.setAttribute("aria-label", label);
      btnSettings.title = label;
    }
    const settingsTitle = document.getElementById("settingsPanelTitle");
    if (settingsTitle) settingsTitle.textContent = t("settings_button");
    const settingsClose = document.getElementById("settingsPanelClose");
    if (settingsClose) {
      settingsClose.setAttribute("aria-label", t("close"));
      settingsClose.title = t("close");
    }
    const menu = document.getElementById("langMenu");
    if (menu) {
      menu.setAttribute("aria-label", t("language_label"));
      menu.querySelectorAll(".lang-option").forEach(option => {
        const isActive = option.dataset.lang === LANG;
        option.setAttribute("aria-selected", isActive ? "true" : "false");
        const name = option.querySelector(".lang-name");
        if (name) name.textContent = langLabel(option.dataset.lang);
      });
    }
    const settingsWebCategoryTitle = document.getElementById("settingsWebCategoryTitle");
    if (settingsWebCategoryTitle) settingsWebCategoryTitle.textContent = t("settings_web_category");
    const settingsDbusCategoryTitle = document.getElementById("settingsDbusCategoryTitle");
    if (settingsDbusCategoryTitle) settingsDbusCategoryTitle.textContent = t("settings_dbus_category");
    const settingsMapVersionTitle = document.getElementById("settingsMapVersionTitle");
    if (settingsMapVersionTitle) settingsMapVersionTitle.textContent = t("settings_map_version");
    const settingsMapVersionSelect = document.getElementById("settingsMapVersionSelect");
    if (settingsMapVersionSelect) {
      const label = t("settings_map_version");
      settingsMapVersionSelect.setAttribute("aria-label", label);
      settingsMapVersionSelect.title = label;
    }
    const settingsAnimationsTitle = document.getElementById("settingsAnimationsTitle");
    if (settingsAnimationsTitle) settingsAnimationsTitle.textContent = t("settings_animations_title");
    const settingsAnimationsLabel = document.getElementById("settingsAnimationsLabel");
    if (settingsAnimationsLabel) settingsAnimationsLabel.textContent = t("settings_animations_toggle");
    const settingsAnimationsToggle = document.getElementById("settingsAnimationsToggle");
    if (settingsAnimationsToggle) {
      const label = t("settings_animations_toggle");
      settingsAnimationsToggle.setAttribute("aria-label", label);
      settingsAnimationsToggle.title = label;
      settingsAnimationsToggle.checked = !!UI_ANIMATIONS;
    }
    const settingsTranslateStopsLabel = document.getElementById("settingsTranslateStopsLabel");
    if (settingsTranslateStopsLabel) settingsTranslateStopsLabel.textContent = t("translate_stop_types");
    const settingsTranslateStopsRow = document.getElementById("settingsTranslateStopsRow");
    const settingsTranslateStopsToggle = document.getElementById("settingsTranslateStopsToggle");
    const hideTranslateStops = LANG === "fr";
    if (settingsTranslateStopsRow) {
      settingsTranslateStopsRow.hidden = hideTranslateStops;
      settingsTranslateStopsRow.style.display = hideTranslateStops ? "none" : "";
    }
    if (settingsTranslateStopsToggle) {
      const label = t("translate_stop_types");
      settingsTranslateStopsToggle.setAttribute("aria-label", label);
      settingsTranslateStopsToggle.title = label;
      settingsTranslateStopsToggle.checked = !!TRANSLATE_STOP_TYPES;
      settingsTranslateStopsToggle.disabled = hideTranslateStops;
    }
    const settingsPreviewLayoutTitle = document.getElementById("settingsPreviewLayoutTitle");
    if (settingsPreviewLayoutTitle) settingsPreviewLayoutTitle.textContent = t("settings_preview_layout_title");
    const settingsPreviewLayoutModes = document.getElementById("settingsPreviewLayoutModes");
    if (settingsPreviewLayoutModes) settingsPreviewLayoutModes.setAttribute("aria-label", t("settings_preview_layout_label"));
    document.querySelectorAll("#settingsPreviewLayoutModes .dbus-mode-btn[data-preview-layout]").forEach(btn => {
      const mode = btn.dataset.previewLayout;
      if (mode === LINE_PREVIEW_LAYOUTS.VERTICAL) btn.textContent = t("settings_preview_layout_vertical");
      if (mode === LINE_PREVIEW_LAYOUTS.HORIZONTAL) btn.textContent = t("settings_preview_layout_horizontal");
      const active = mode === LINE_PREVIEW_LAYOUT;
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
    });
    const settingsCenteringTitle = document.getElementById("settingsCenteringTitle");
    if (settingsCenteringTitle) settingsCenteringTitle.textContent = t("settings_centering_title");
    const settingsCenterLineLabel = document.getElementById("settingsCenterLineLabel");
    if (settingsCenterLineLabel) settingsCenterLineLabel.textContent = t("settings_center_line_toggle");
    const settingsCenterLineToggle = document.getElementById("settingsCenterLineToggle");
    if (settingsCenterLineToggle) {
      const label = t("settings_center_line_toggle");
      settingsCenterLineToggle.setAttribute("aria-label", label);
      settingsCenterLineToggle.title = label;
      settingsCenterLineToggle.checked = !!CENTER_ON_LINE_SELECT;
    }
    const settingsLeafletLegendTitle = document.getElementById("settingsLeafletLegendTitle");
    if (settingsLeafletLegendTitle) settingsLeafletLegendTitle.textContent = t("settings_leaflet_legend_title");
    const settingsLegendMonumentLabel = document.getElementById("settingsLegendMonumentLabel");
    if (settingsLegendMonumentLabel) settingsLegendMonumentLabel.textContent = t("emblematic");
    const settingsLegendMallLabel = document.getElementById("settingsLegendMallLabel");
    if (settingsLegendMallLabel) settingsLegendMallLabel.textContent = t("malls");
    const settingsLegendRepairLabel = document.getElementById("settingsLegendRepairLabel");
    if (settingsLegendRepairLabel) settingsLegendRepairLabel.textContent = t("repair_shops");
    const settingsLegendAgencyLabel = document.getElementById("settingsLegendAgencyLabel");
    if (settingsLegendAgencyLabel) settingsLegendAgencyLabel.textContent = t("agencies");
    const settingsLegendDealerLabel = document.getElementById("settingsLegendDealerLabel");
    if (settingsLegendDealerLabel) settingsLegendDealerLabel.textContent = t("dealers");
    const settingsLegendGarageLabel = document.getElementById("settingsLegendGarageLabel");
    if (settingsLegendGarageLabel) settingsLegendGarageLabel.textContent = t("garage");
    const settingsLegendGasLabel = document.getElementById("settingsLegendGasLabel");
    if (settingsLegendGasLabel) settingsLegendGasLabel.textContent = t("icon_gas");
    const settingsLegendBusStationLabel = document.getElementById("settingsLegendBusStationLabel");
    if (settingsLegendBusStationLabel) settingsLegendBusStationLabel.textContent = t("icon_bus_station");
    const settingsLegendBorderLabel = document.getElementById("settingsLegendBorderLabel");
    if (settingsLegendBorderLabel) settingsLegendBorderLabel.textContent = t("icon_border_control");
    const settingsLegendTollLabel = document.getElementById("settingsLegendTollLabel");
    if (settingsLegendTollLabel) settingsLegendTollLabel.textContent = t("icon_toll");
    const settingsLegendParkingLabel = document.getElementById("settingsLegendParkingLabel");
    if (settingsLegendParkingLabel) settingsLegendParkingLabel.textContent = t("icon_parking");
    const settingsLegendBusStopsLabel = document.getElementById("settingsLegendBusStopsLabel");
    if (settingsLegendBusStopsLabel) settingsLegendBusStopsLabel.textContent = t("settings_legend_bus_stops");
    const settingsLegendBusStopsToggleLabel = document.getElementById("settingsLegendBusStopsToggleLabel");
    if (settingsLegendBusStopsToggleLabel) settingsLegendBusStopsToggleLabel.textContent = t("settings_legend_bus_stops_toggle");
    const settingsLegendBusStopsBadge = document.getElementById("settingsLegendBusStopsBadge");
    if (settingsLegendBusStopsBadge) settingsLegendBusStopsBadge.textContent = t("experimental");
    const settingsBusStopsToggle = document.getElementById("settingsBusStopsToggle");
    if (settingsBusStopsToggle) {
      const label = t("settings_legend_bus_stops");
      settingsBusStopsToggle.setAttribute("aria-label", label);
      settingsBusStopsToggle.title = label;
      settingsBusStopsToggle.checked = !!DBUS_STOP_ICONS_ENABLED;
    }
    const settingsSortTitle = document.getElementById("settingsSortTitle");
    if (settingsSortTitle) settingsSortTitle.textContent = t("settings_category_sort");
    const dbusSortLabel = document.getElementById("dbusSortLabel");
    if (dbusSortLabel) dbusSortLabel.textContent = t("settings_category_sort");
    const settingsFilterTitle = document.getElementById("settingsFilterTitle");
    if (settingsFilterTitle) settingsFilterTitle.textContent = t("dbus_filter_label");
    const settingsSchoolLabel = document.getElementById("settingsSchoolLabel");
    if (settingsSchoolLabel) settingsSchoolLabel.textContent = t("dbus_school_toggle");
    const settingsFictiveLabel = document.getElementById("settingsFictiveLabel");
    if (settingsFictiveLabel) settingsFictiveLabel.textContent = t("dbus_fictive_toggle");
    const settingsSortModes = document.getElementById("settingsSortModes");
    if (settingsSortModes) settingsSortModes.setAttribute("aria-label", t("settings_category_sort"));
    const dbusSortModes = document.getElementById("dbusSortModes");
    if (dbusSortModes) dbusSortModes.setAttribute("aria-label", t("settings_category_sort"));
    if (typeof window.updateMapVersionSettingsUI === "function") {
      try { window.updateMapVersionSettingsUI(); } catch {}
    }
    if (typeof window.updateWatermarkVersionLabel === "function") {
      try { window.updateWatermarkVersionLabel(); } catch {}
    }
  }
  function setLang(lang, {persist=true, apply=true} = {}){
    const previousLang = LANG;
    if (!SUPPORTED.has(lang)) lang = "fr";
    LANG = lang;
    const langChanged = previousLang !== LANG;
    if (persist) localStorage.setItem("idf_lang", lang);
    document.documentElement.setAttribute("lang", lang);
    if (LANG === "fr" && TRANSLATE_STOP_TYPES) {
      setStopTypeTranslation(false, { persist: true, apply: false });
    }
    if (typeof isLinePreviewOpen === "function" && isLinePreviewOpen()) {
      try { currentSelectedKey = ""; } catch {}
      try { currentSelectedLineUid = ""; } catch {}
      if (typeof hideAllRoutes === "function") {
        try { hideAllRoutes(); } catch {}
      }
      if (typeof hideLinePreview === "function") {
        try { hideLinePreview(); } catch {}
      }
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item").forEach(it => {
        it.classList.remove("active");
        it.style.outline = "none";
      });
      if (typeof renderSelectedChip === "function") {
        try { renderSelectedChip(); } catch {}
      }
    }
    if (apply) applyI18N();
    if (langChanged) {
      const dbusPanelEl = document.getElementById("dbusPanel");
      const dbusStopPanelEl = document.getElementById("dbusStopPanel");
      const isDbusPanelOpenNow = !!dbusPanelEl && getComputedStyle(dbusPanelEl).display !== "none" && !dbusPanelEl.classList.contains("is-closing");
      const isDbusStopOpenNow = !!dbusStopPanelEl && getComputedStyle(dbusStopPanelEl).display !== "none" && !dbusStopPanelEl.classList.contains("is-closing");
      if (isDbusPanelOpenNow || isDbusStopOpenNow) {
        try {
          if (typeof closeDbusPanel === "function") closeDbusPanel();
          else throw new Error("closeDbusPanel_unavailable");
        } catch {
          if (dbusPanelEl) {
            dbusPanelEl.classList.remove("is-open", "is-closing");
            dbusPanelEl.style.display = "none";
            dbusPanelEl.setAttribute("aria-hidden", "true");
          }
          if (dbusStopPanelEl) {
            dbusStopPanelEl.classList.remove("is-open", "is-closing");
            dbusStopPanelEl.style.display = "none";
            dbusStopPanelEl.setAttribute("aria-hidden", "true");
          }
          const btnDbusEl = document.getElementById("btnDbus");
          if (btnDbusEl) btnDbusEl.setAttribute("aria-expanded", "false");
        }
      }
    }
    if (typeof updateUiOverlays === "function") {
      try { updateUiOverlays(); } catch {}
    }
  }
    function applyI18N(){
    renderSiteNav();
    const routeTitleFn = (typeof translateRouteTitle === "function")
      ? translateRouteTitle
      : (title) => translateStopName(title);
    const $search = document.getElementById("search");
    if ($search) {
      const label = t("search_placeholder");
      $search.placeholder = label;
      $search.setAttribute("aria-label", label);
    }
    const $btnSearch = document.getElementById("btnSearch");
    if ($btnSearch) $btnSearch.textContent = t("search_button");
    const $searchPanelTitle = document.getElementById("searchPanelTitle");
    if ($searchPanelTitle) $searchPanelTitle.textContent = t("search_button");
    const $searchPanelClose = document.getElementById("searchPanelClose");
    if ($searchPanelClose){ $searchPanelClose.setAttribute("aria-label", t("close")); $searchPanelClose.title = t("close"); }
    const $searchFilterLabel = document.getElementById("searchFilterLabel");
    if ($searchFilterLabel) $searchFilterLabel.textContent = t("search_category_label");
    document.querySelectorAll(".search-categories .dbus-mode-btn").forEach(btn => {
      const key = btn.dataset.category;
      if (key) btn.textContent = searchCategoryButtonLabel(key);
    });
    const $btnDbus = document.getElementById("btnDbus");
    if ($btnDbus) {
      const label = t("dbus_button");
      $btnDbus.setAttribute("aria-label", label);
      $btnDbus.title = label;
    }
    updateDbusPanelTitles();
    const $dbusModeLabel = document.getElementById("dbusModeLabel");
    if ($dbusModeLabel) $dbusModeLabel.textContent = t("dbus_mode_label");
    document.querySelectorAll(".dbus-mode-btn").forEach(btn => {
      const mode = btn.dataset.mode;
      if (mode === "lines") btn.textContent = t("dbus_mode_lines");
      if (mode === "length") btn.textContent = t("dbus_mode_length");
      if (mode === "departures") btn.textContent = t("dbus_mode_stops");
    });
    const $dbusDepartMapBtn = document.getElementById("dbusDepartMapBtn");
    if ($dbusDepartMapBtn) {
      const label = t("dbus_depart_map_btn");
      $dbusDepartMapBtn.textContent = label;
      $dbusDepartMapBtn.setAttribute("aria-label", label);
      $dbusDepartMapBtn.title = label;
    }
    const $dbusFilterLabel = document.getElementById("dbusFilterLabel");
    if ($dbusFilterLabel) $dbusFilterLabel.textContent = t("dbus_filter_label");
    const $dbusSortLabel = document.getElementById("dbusSortLabel");
    if ($dbusSortLabel) $dbusSortLabel.textContent = t("settings_category_sort");
    const $dbusRoutesTitleLabel = document.getElementById("dbusRoutesTitleLabel");
    if ($dbusRoutesTitleLabel) {
      const count = parseInt($dbusRoutesTitleLabel.dataset.routeCount || "", 10);
      if (Number.isFinite(count) && count >= 0) $dbusRoutesTitleLabel.textContent = `${t("dbus_routes_title")} (${count})`;
      else $dbusRoutesTitleLabel.textContent = t("dbus_routes_title");
    }
    const $dbusRoutesClear = document.getElementById("dbusRoutesClear");
    if ($dbusRoutesClear) {
      $dbusRoutesClear.setAttribute("aria-label", t("close"));
      $dbusRoutesClear.title = t("close");
    }
    const $dbusSchoolLabel = document.getElementById("dbusSchoolLabel");
    const $dbusSchoolToggle = document.getElementById("dbusSchoolToggle");
    if ($dbusSchoolLabel) $dbusSchoolLabel.textContent = t("dbus_school_toggle");
    if ($dbusSchoolToggle) {
      const label = t("dbus_school_toggle");
      $dbusSchoolToggle.setAttribute("aria-label", label);
      $dbusSchoolToggle.title = label;
    }
    const $dbusFictiveLabel = document.getElementById("dbusFictiveLabel");
    const $dbusFictiveToggle = document.getElementById("dbusFictiveToggle");
    if ($dbusFictiveLabel) $dbusFictiveLabel.textContent = t("dbus_fictive_toggle");
    if ($dbusFictiveToggle) {
      const label = t("dbus_fictive_toggle");
      $dbusFictiveToggle.setAttribute("aria-label", label);
      $dbusFictiveToggle.title = label;
    }
    const $settingsSchoolToggle = document.getElementById("settingsSchoolToggle");
    if ($settingsSchoolToggle) {
      const label = t("dbus_school_toggle");
      $settingsSchoolToggle.setAttribute("aria-label", label);
      $settingsSchoolToggle.title = label;
    }
    const $settingsFictiveToggle = document.getElementById("settingsFictiveToggle");
    if ($settingsFictiveToggle) {
      const label = t("dbus_fictive_toggle");
      $settingsFictiveToggle.setAttribute("aria-label", label);
      $settingsFictiveToggle.title = label;
    }
    const $lpClose = document.getElementById("lpClose");
    if ($lpClose){ $lpClose.setAttribute("aria-label", t("close")); $lpClose.title = t("close"); }
    const $lpCueUp = document.querySelector("#linePreview .line-preview-scroll-cue.top");
    if ($lpCueUp) $lpCueUp.setAttribute("aria-label", t("line_preview_scroll_up"));
    const $lpCueDown = document.querySelector("#linePreview .line-preview-scroll-cue.bottom");
    if ($lpCueDown) $lpCueDown.setAttribute("aria-label", t("line_preview_scroll_down"));
    const $lpLink = document.getElementById("lpLink");
    if ($lpLink){
      const label = t("open_link");
      $lpLink.setAttribute("aria-label", label);
      $lpLink.title = label;
    }
    const $dbusWorldLink = document.getElementById("dbusWorldLink");
    if ($dbusWorldLink){
      const offsite = window.SITE_OFFSITE_LINKS && typeof window.SITE_OFFSITE_LINKS === "object"
        ? window.SITE_OFFSITE_LINKS
        : {};
      const offsiteKey = String($dbusWorldLink.getAttribute("data-offsite-key") || "").trim();
      const offsiteHref = String(offsite[offsiteKey] || "").trim();
      if (offsiteHref) $dbusWorldLink.href = offsiteHref;
      const label = t("dbus_world_button");
      $dbusWorldLink.setAttribute("aria-label", label);
      $dbusWorldLink.title = label;
    }
    const $dbusStopClose = document.getElementById("dbusStopClose");
    if ($dbusStopClose){ $dbusStopClose.setAttribute("aria-label", t("close")); $dbusStopClose.title = t("close"); }
    const $dbusDepartIndicatorLabel = document.getElementById("dbusDepartIndicatorLabel");
    if ($dbusDepartIndicatorLabel) $dbusDepartIndicatorLabel.textContent = t("departures_active");
    const $dbusDepartIndicatorClose = document.getElementById("dbusDepartIndicatorClose");
    if ($dbusDepartIndicatorClose){
      $dbusDepartIndicatorClose.setAttribute("aria-label", t("departures_disable"));
      $dbusDepartIndicatorClose.title = t("departures_disable");
    }
    const $dbusRoutesListLocal = document.getElementById("dbusRoutesList");
    if ($dbusRoutesListLocal && !$dbusRoutesListLocal.querySelector(".dbus-item")) {
      $dbusRoutesListLocal.innerHTML = `<div class="dbus-none">${t("none")}</div>`;
    }
    const home = document.querySelector(".leaflet-custom-home a.home-btn");
    if (home) home.title = t("home_tooltip");

    const results = document.getElementById("results");
    if (results && !results.hidden) {
      const empty = results.querySelector(".result-empty");
      if (empty) empty.textContent = resultsEmptyText();
      results.querySelectorAll(".result-sechead").forEach(h => {
        const raw = h.textContent.trim().toLowerCase();
        const map = {
          "villes": t("villes"),
          "lieux emblématiques": t("emblematic"),
          "ateliers de réparation": t("repair_shops"),
          "agences de recrutement": t("agencies"),
          "concessionnaires": t("dealers"),
          "entreprises": t("companies"),
          "centres commerciaux": t("malls"),
        };
        if (map[raw]) h.textContent = map[raw];
      });
    }
    if (results && !results.hidden) {
      results.querySelectorAll(".result-sechead").forEach(h => {
        const typeKey = h.dataset.type;
        const count = h.dataset.count;
        if (typeKey && count !== undefined) {
          h.textContent = `${searchCategoryLabel(typeKey)} (${count})`;
        }
      });
    }
    const $dbusStopTitle = document.getElementById("dbusStopTitle");
    if ($dbusStopTitle) {
      const mode = $dbusStopTitle.dataset.stopMode || "";
      const name = $dbusStopTitle.dataset.stopName || "";
      if (mode === "single" && name) {
        $dbusStopTitle.innerHTML = `${t("stop")} : ${withRERIcon(translateStopName(name))}`;
      } else if (mode === "group") {
        const raw = $dbusStopTitle.dataset.stopNames || "[]";
        let list = [];
        try { list = JSON.parse(raw); } catch { list = []; }
        const translated = list.map(n => translateStopName(n));
        $dbusStopTitle.innerHTML = translated.map(n => withRERIcon(n)).join(" / ");
      } else if (!mode) {
        $dbusStopTitle.textContent = t("stop");
      }
    }
    document.querySelectorAll(".stop-flag").forEach(flag => {
      const label = t("temporary_stop");
      flag.textContent = label;
      flag.setAttribute("aria-label", label);
    });
    document.querySelectorAll(".stop[data-raw-label]").forEach(stop => {
      const raw = stop.dataset.rawLabel || "";
      const isProv = stop.dataset.provisoire === "1";
      const label = translateStopName(raw);
      const nameEl = stop.querySelector(".name");
      if (nameEl) {
        const flag = isProv ? ` <span class="stop-flag" aria-label="${t("temporary_stop")}">${t("temporary_stop")}</span>` : "";
        nameEl.innerHTML = `${withRERIcon(label)}${flag}`;
      }
    });
    document.querySelectorAll(".sp-coords span").forEach(span => {
      span.textContent = t("coordinates");
    });
    document.querySelectorAll(".dbus-sec h4[data-stop-name]").forEach(h => {
      const raw = h.dataset.stopName || "";
      const count = h.dataset.stopCount || "";
      const label = withRERIcon(translateStopName(raw));
      h.innerHTML = `${label}${count ? ` (${count})` : ""}`;
    });
    document.querySelectorAll(".rname[data-raw-name]").forEach(el => {
      const raw = el.dataset.rawName || "";
      el.innerHTML = withRERIcon(translateStopName(raw));
    });
    document.querySelectorAll(".rname[data-route-kind]").forEach(el => {
      const kind = el.dataset.routeKind;
      const routeTitle = el.dataset.routeTitle || "";
      const flag = el.dataset.routeFlag || "";
      if (kind === "line") {
        const displayTitle = routeTitleFn(routeTitle);
        let html = withRERIcon(displayTitle || routeTitle);
        if (flag) html += ` <span class="route-flag">${flag}</span>`;
        el.innerHTML = html;
      } else if (kind === "depart") {
        const titleEnd = el.dataset.routeEnd || "";
        const dirName = getRouteTerminusLabel({ stops: [] }, titleEnd) || String(titleEnd || routeTitle || "").trim();
        const dirLabel = t("destination");
        const dirText = dirName || routeTitle || "?";
        let html = `${dirLabel} : ${withRERIcon(dirText)}`;
        if (flag) html += ` <span class="route-flag">${flag}</span>`;
        el.innerHTML = html;
      }
    });
    document.querySelectorAll(".result-text[data-route-title]").forEach(el => {
      const raw = el.dataset.routeTitle || "";
      el.textContent = routeTitleFn(raw);
    });
    document.querySelectorAll("[data-stop-count]").forEach(el => {
      const count = parseInt(el.dataset.stopCount || "0", 10);
      const durationText = el.dataset.durationText || "";
      const format = el.dataset.durationFormat || "paren";
      if (Number.isFinite(count)) {
        el.textContent = formatStopDuration(count, durationText, format);
      }
    });
    document.querySelectorAll(".badge[data-badge-raw], .dbus-badge[data-badge-raw]").forEach(badgeEl => {
      const raw = badgeEl.dataset.badgeRaw || "";
      const labelText = translateBadgeToken(raw);
      const labelEl = ensureBadgeLabel(badgeEl, labelText);
      if (!labelEl) return;
      const box = badgeEl.getBoundingClientRect();
      const width = Math.max(24, Math.round(box.width || parseInt(badgeEl.style.width || "72", 10)));
      const height = Math.max(16, Math.round(box.height || parseInt(badgeEl.style.height || "32", 10)));
      labelEl.style.fontSize = computeBadgeFontSize(labelText, width, height) + "px";
    });
    const $lpRouteTitle = document.getElementById("lpRouteTitle");
    const $lpRouteMeta = document.getElementById("lpRouteMeta");
    if ($lpRouteTitle && ($lpRouteTitle.dataset.rawStart || $lpRouteTitle.dataset.rawEnd)) {
      const start = translateStopName($lpRouteTitle.dataset.rawStart || "");
      const end = translateStopName($lpRouteTitle.dataset.rawEnd || "");
      $lpRouteTitle.innerHTML = `${withRERIcon(start)} &gt; ${withRERIcon(end)}`;
      if ($lpRouteMeta) {
        const count = parseInt($lpRouteMeta.dataset.stopCount || "0", 10);
        const durationText = $lpRouteMeta.dataset.durationText || "";
        const format = $lpRouteMeta.dataset.durationFormat || "dash";
        if (Number.isFinite(count)) {
          setStopDurationText($lpRouteMeta, count, durationText, format);
        }
      }
    }
    document.querySelectorAll(".dbus-sechead").forEach(head => {
      const key = head.dataset.cat;
      const count = head.dataset.count;
      if (!key || !count) return;
      if (typeof dbusSectionHeadHTML === "function") {
        head.innerHTML = dbusSectionHeadHTML(key, Number(count));
      } else {
        const label = dbusCategoryTitle(key);
        head.innerHTML = `<span>${label} (${count})</span><span class="chev" style="margin-left:auto">▼</span>`;
      }
    });
    document.querySelectorAll("h4[data-sub-key]").forEach(head => {
      const key = head.dataset.subKey || "";
      if (key) head.textContent = t(key);
    });
    document.querySelectorAll(".dbus-none").forEach(none => {
      none.textContent = t("none");
    });
    if (typeof window.refreshLinePreviewRail === "function") {
      window.refreshLinePreviewRail();
    }
    refreshI18nLayers();
    updateLangUI();
  }
  window.sharedHeader?.init?.({
    t,
    getLang: () => LANG,
    setLang: (nextLang) => setLang(nextLang),
    langOptions: LANG_OPTIONS,
    langMeta: LANG_META,
    langLabel: (code) => langLabel(code),
    navTree: SITE_NAV_TREE
  });
  buildLangMenu();
  document.getElementById("btnSettings")?.addEventListener("click", (event) => {
    event.stopPropagation();
    closeLangMenu();
    if (isSettingsOpen()) closeSettingsPanel();
    else openSettingsPanel();
  });
  const settingsAnimationsToggleEl = document.getElementById("settingsAnimationsToggle");
  if (settingsAnimationsToggleEl) {
    settingsAnimationsToggleEl.addEventListener("change", () => {
      setUiAnimationsEnabled(settingsAnimationsToggleEl.checked);
    });
  }
  const settingsTranslateStopsToggleEl = document.getElementById("settingsTranslateStopsToggle");
  if (settingsTranslateStopsToggleEl) {
    settingsTranslateStopsToggleEl.addEventListener("change", () => {
      if (LANG === "fr") {
        settingsTranslateStopsToggleEl.checked = false;
        return;
      }
      setStopTypeTranslation(settingsTranslateStopsToggleEl.checked);
    });
  }
  document.querySelectorAll("#settingsPreviewLayoutModes .dbus-mode-btn[data-preview-layout]").forEach(btn => {
    btn.addEventListener("click", () => {
      setLinePreviewLayout(btn.dataset.previewLayout);
    });
  });
  const settingsCenterLineToggleEl = document.getElementById("settingsCenterLineToggle");
  if (settingsCenterLineToggleEl) {
    settingsCenterLineToggleEl.addEventListener("change", () => {
      setCenterOnLineSelectEnabled(settingsCenterLineToggleEl.checked);
    });
  }
  const settingsBusStopsToggleEl = document.getElementById("settingsBusStopsToggle");
  if (settingsBusStopsToggleEl) {
    settingsBusStopsToggleEl.addEventListener("change", () => {
      setDbusStopIconsEnabled(settingsBusStopsToggleEl.checked);
    });
  }
  setUiAnimationsEnabled(UI_ANIMATIONS, { persist: false });
  setLinePreviewLayout(LINE_PREVIEW_LAYOUT, { persist: false });
  setCenterOnLineSelectEnabled(CENTER_ON_LINE_SELECT, { persist: false });
  setDbusStopIconsEnabled(DBUS_STOP_ICONS_ENABLED, { persist: false, apply: false });
  setLang(LANG, {persist:false, apply:true});
  </script>

  <script>
    const QS = new URLSearchParams(location.search);
    const MAP_FILES_ROOT = "./map_files";
    const VERSION_PATTERN = /^(\d+)\.(\d+)\.(\d+)([a-z])$/i;
    function parseVersion(value){
      const match = VERSION_PATTERN.exec(String(value || "").trim());
      if (!match) return null;
      return {
        raw: `${parseInt(match[1], 10)}.${parseInt(match[2], 10)}.${parseInt(match[3], 10)}${match[4].toLowerCase()}`,
        major: parseInt(match[1], 10),
        minor: parseInt(match[2], 10),
        patch: parseInt(match[3], 10),
        suffix: match[4].toLowerCase()
      };
    }
    function compareVersions(a, b){
      if (a.major !== b.major) return a.major - b.major;
      if (a.minor !== b.minor) return a.minor - b.minor;
      if (a.patch !== b.patch) return a.patch - b.patch;
      return a.suffix.localeCompare(b.suffix);
    }
    function loadVersionsFromManifestSync(root){
      try {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `${root}/versions.json`, false);
        xhr.send(null);
        if (xhr.status < 200 || xhr.status >= 300) return [];
        const data = JSON.parse(xhr.responseText);
        if (Array.isArray(data)) {
          return data.map(v => String(v || "").trim()).filter(Boolean);
        }
        if (data && Array.isArray(data.versions)) {
          return data.versions.map(v => String(v || "").trim()).filter(Boolean);
        }
        return [];
      } catch {
        return [];
      }
    }
    function loadVersionsFromDirectorySync(root){
      try {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `${root}/`, false);
        xhr.send(null);
        if (xhr.status < 200 || xhr.status >= 300) return [];
        const html = String(xhr.responseText || "");
        const versions = new Set();
        const hrefMatches = html.matchAll(/href=["']([^"']+)["']/gi);
        for (const match of hrefMatches) {
          const href = String(match[1] || "").trim();
          if (!href) continue;
          const cleaned = href.replace(/^[./]+/, "").replace(/\/+$/, "");
          if (parseVersion(cleaned)) versions.add(cleaned);
        }
        const textMatches = html.match(/\b\d+\.\d+\.\d+[a-z]\b/gi) || [];
        textMatches.forEach((entry) => {
          const parsed = parseVersion(entry);
          if (parsed) versions.add(parsed.raw);
        });
        return [...versions];
      } catch {
        return [];
      }
    }
    function selectLatestVersion(candidates){
      const parsed = [...new Set(candidates)]
        .map(parseVersion)
        .filter(Boolean);
      if (!parsed.length) return null;
      parsed.sort(compareVersions);
      return parsed[parsed.length - 1].raw;
    }
    function getSortedAvailableVersions(candidates){
      const byRaw = new Map();
      candidates.forEach((candidate) => {
        const parsed = parseVersion(candidate);
        if (parsed) byRaw.set(parsed.raw, parsed);
      });
      return [...byRaw.values()]
        .sort((a, b) => compareVersions(b, a))
        .map(v => v.raw);
    }
    const forcedVersion = String(QS.get("version") || QS.get("v") || "").trim();
    const parsedForcedVersion = parseVersion(forcedVersion);
    const manifestVersions = loadVersionsFromManifestSync(MAP_FILES_ROOT);
    const dirVersions = loadVersionsFromDirectorySync(MAP_FILES_ROOT);
    const AVAILABLE_MAP_VERSIONS = getSortedAvailableVersions([...manifestVersions, ...dirVersions]);
    const latestVersion = selectLatestVersion(AVAILABLE_MAP_VERSIONS);
    const SELECTED_VERSION = parsedForcedVersion ? parsedForcedVersion.raw : latestVersion;
    if (QS.has("version") || QS.has("v")) {
      try {
        const cleanUrl = new URL(location.href);
        cleanUrl.searchParams.delete("version");
        cleanUrl.searchParams.delete("v");
        history.replaceState(null, "", cleanUrl.toString());
      } catch {}
    }
    const DATA_BASE = SELECTED_VERSION ? `${MAP_FILES_ROOT}/${SELECTED_VERSION}` : MAP_FILES_ROOT;
    const OVERLAY_BASE = `${DATA_BASE}/Overlays`;
    const TILE_BASE = `${DATA_BASE}/Tiles`;
    const DBUS_BASE = `${DATA_BASE}/DBus`;
    const dataPath = (file) => `${DATA_BASE}/${file}`;
    const overlayPath = (file) => `${OVERLAY_BASE}/${file}`;
    function updateMapVersionSettingsUI(){
      const section = document.getElementById("settingsMapVersionSection");
      const title = document.getElementById("settingsMapVersionTitle");
      const select = document.getElementById("settingsMapVersionSelect");
      if (title && typeof t === "function") title.textContent = t("settings_map_version");
      if (!section || !select) return;
      if (!AVAILABLE_MAP_VERSIONS.length) {
        section.hidden = true;
        select.innerHTML = "";
        return;
      }
      section.hidden = false;
      if (select.dataset.versionsHash !== AVAILABLE_MAP_VERSIONS.join("|")) {
        select.innerHTML = "";
        AVAILABLE_MAP_VERSIONS.forEach((version) => {
          const option = document.createElement("option");
          option.value = version;
          option.textContent = version;
          select.appendChild(option);
        });
        select.dataset.versionsHash = AVAILABLE_MAP_VERSIONS.join("|");
      }
      const currentVersion = (SELECTED_VERSION && AVAILABLE_MAP_VERSIONS.includes(SELECTED_VERSION))
        ? SELECTED_VERSION
        : AVAILABLE_MAP_VERSIONS[0];
      select.value = currentVersion;
      if (typeof t === "function") {
        const label = t("settings_map_version");
        select.setAttribute("aria-label", label);
        select.title = label;
      }
    }
    function updateWatermarkVersionLabel(){
      const labelEl = document.getElementById("watermarkVersionLabel");
      if (!labelEl) return;
      const currentVersion = (SELECTED_VERSION && AVAILABLE_MAP_VERSIONS.includes(SELECTED_VERSION))
        ? SELECTED_VERSION
        : (AVAILABLE_MAP_VERSIONS[0] || "");
      const prefix = (typeof t === "function") ? t("settings_map_version") : "Map version";
      labelEl.textContent = currentVersion ? `${prefix}: ${currentVersion}` : prefix;
      const isOutdated = !!(currentVersion && latestVersion && currentVersion !== latestVersion);
      labelEl.classList.toggle("is-outdated", isOutdated);
      labelEl.removeAttribute("title");
      labelEl.setAttribute("aria-label", labelEl.textContent);
    }
    window.updateWatermarkVersionLabel = updateWatermarkVersionLabel;
    window.updateMapVersionSettingsUI = updateMapVersionSettingsUI;
    updateMapVersionSettingsUI();
    updateWatermarkVersionLabel();
    const settingsMapVersionSelectEl = document.getElementById("settingsMapVersionSelect");
    if (settingsMapVersionSelectEl && !settingsMapVersionSelectEl.dataset.boundMapVersion) {
      settingsMapVersionSelectEl.dataset.boundMapVersion = "1";
      settingsMapVersionSelectEl.addEventListener("change", () => {
        const nextParsed = parseVersion(settingsMapVersionSelectEl.value);
        if (!nextParsed || nextParsed.raw === SELECTED_VERSION) return;
        try {
          const nextUrl = new URL(location.href);
          nextUrl.searchParams.set("version", nextParsed.raw);
          if (window.sharedHeader?.startPageTransition) {
            window.sharedHeader.startPageTransition();
          } else if (window.sharedHeader?.showPageLoader) {
            window.sharedHeader.showPageLoader({ persist: true });
          }
          location.assign(nextUrl.toString());
        } catch {}
      });
    }

    const watermarkLogo = document.getElementById("watermarkLogo");
    if (watermarkLogo) watermarkLogo.src = overlayPath("idf_logo.png");
    const siteTopbarLogo = document.getElementById("siteTopbarLogo");
    if (siteTopbarLogo) siteTopbarLogo.src = overlayPath("idf_logo.png");
    const btnDbusLogo = document.getElementById("btnDbusLogo");
    if (btnDbusLogo) btnDbusLogo.src = overlayPath("bus_logo_idfm.png");
    document.querySelectorAll("#settingsLeafletLegend [data-overlay-src]").forEach((img) => {
      const file = img.getAttribute("data-overlay-src");
      if (!file) return;
      img.setAttribute("src", overlayPath(file));
    });
    document.documentElement.style.setProperty(
      "--rer-mask-url",
      `url("${overlayPath("o_rer.png")}")`
    );
    document.documentElement.style.setProperty(
      "--metro-icon-url",
      `url("${overlayPath("o_metro.png")}")`
    );

    const minNativeZoom=0,maxNativeZoom=8,tileSize=256;
    const widthPx=tileSize*Math.pow(2,maxNativeZoom),heightPx=tileSize*Math.pow(2,maxNativeZoom);

    const map=L.map('map',{
      crs:L.CRS.Simple,
      attributionControl:false,
      zoomControl:false,
      minZoom:minNativeZoom+4,
      maxZoom:maxNativeZoom+2,
      zoomSnap:0.25,
      zoomDelta:0.25,
      wheelPxPerZoomLevel:80,
      maxBoundsViscosity:1.0,
      inertia:true,
      preferCanvas:true,
      zoomAnimation:true,
      fadeAnimation:true,
      markerZoomAnimation:true
    });
    const dbusRoutePane = map.createPane("dbusRoutePane");
    dbusRoutePane.style.zIndex = "320";
    dbusRoutePane.style.pointerEvents = "none";
    const dbusRouteMarkerPane = map.createPane("dbusRouteMarkerPane");
    dbusRouteMarkerPane.style.zIndex = "330";
    dbusRouteMarkerPane.style.pointerEvents = "none";
    const fullBounds=L.latLngBounds(map.unproject(L.point(0,heightPx),maxNativeZoom),map.unproject(L.point(widthPx,0),maxNativeZoom));
    const MARGIN=64;
    function innerBounds(m){const sw=L.point(0+m,heightPx-m),ne=L.point(widthPx-m,0+m);return L.latLngBounds(map.unproject(sw,maxNativeZoom),map.unproject(ne,maxNativeZoom));}

    const SCALE_RATIO = 0.95;

    function updateCustomScale() {
      const zoom = map.getZoom();
      const scaleFactor = Math.pow(2, zoom - maxNativeZoom);
      const metersPerPixel = SCALE_RATIO / scaleFactor;

      const zoomScales = {
        [maxNativeZoom - 5]: 16000,
        [maxNativeZoom - 4]: 8000,
        [maxNativeZoom - 3]: 4000,
        [maxNativeZoom - 2]: 2000,
        [maxNativeZoom - 1]: 1000,
        [maxNativeZoom]: 500,
        [maxNativeZoom + 1]: 200,
        [maxNativeZoom + 2]: 100,
      };

      let targetMeters = zoomScales[zoom];
      if (targetMeters === undefined) {
        const keys = Object.keys(zoomScales).map(k => parseInt(k));
        const closest = keys.reduce((a, b) =>
          Math.abs(b - zoom) < Math.abs(a - zoom) ? b : a
        );
        targetMeters = zoomScales[closest];
      }

      const pxLength = targetMeters / metersPerPixel;

      const scaleEl = document.getElementById("custom-scale");
      if (scaleEl) {
        scaleEl.style.width = `${pxLength}px`;
        scaleEl.querySelector("span").textContent =
          targetMeters >= 1000 ? `${(targetMeters / 1000).toFixed(0)} km` : `${targetMeters} m`;
      }
    }

    const scaleDiv = L.control({ position: 'bottomleft' });
    scaleDiv.onAdd = () => {
      const div = L.DomUtil.create('div', 'custom-scale');
      div.id = 'custom-scale';
      div.innerHTML = '<div class="bar"></div><span></span>';
      return div;
    };
    scaleDiv.addTo(map);

    map.on('zoom', updateCustomScale);
    updateCustomScale();


    L.tileLayer(`${TILE_BASE}/{z}/{x}/{y}.png`,{
      tileSize,minNativeZoom,maxNativeZoom,maxZoom:maxNativeZoom+2,
      noWrap:true,bounds:fullBounds,crossOrigin:true,referrerPolicy:"no-referrer",
      updateWhenIdle:false,updateWhenZooming:true,keepBuffer:3
    }).addTo(map);
    function applyBounds(){const ib=innerBounds(MARGIN);map.setMaxBounds(ib);map.panInsideBounds(ib,{animate:false});}
    map.fitBounds(innerBounds(MARGIN),{animate:false});applyBounds();map.on('zoomend resize',applyBounds);

    let TileMapInfo;
    const tileInfoReady = fetch(dataPath("TileMapInfo.json")).then(r=>{ if(!r.ok) throw new Error('TileMapInfo'); return r.json(); }).then(info => (TileMapInfo = info));
    const OX = parseFloat(QS.get('ox') ?? '0');
    const OY = parseFloat(QS.get('oy') ?? '0');
    const SX = parseFloat(QS.get('sx') ?? '1');
    const SY = parseFloat(QS.get('sy') ?? '1');
    
    const $search = document.getElementById("search");
    const $results = document.getElementById("results");
    const $siteTopBar = document.getElementById("siteTopBar");
    const $topBar = document.getElementById("topBar");
    const $searchPanelHost = document.querySelector(".search-panel");
    const $searchPanel = document.getElementById("searchPanel");
    const $searchFilters = document.getElementById("searchFilters");
    const $topActions = document.querySelector(".top-actions");
    const $btnLang = document.getElementById("btnLang");
    const $btnSettings = document.getElementById("btnSettings");
    const $panelSettings = document.getElementById("settingsPanel");
    const $panelResizers = document.querySelectorAll("[data-panel-resizer]");
    const $settingsPanelClose = document.getElementById("settingsPanelClose");
    const $btnSearch = document.getElementById("btnSearch");
    const $searchPanelClose = document.getElementById("searchPanelClose");
    const $analysisHUD = document.getElementById("analysisHUD");
    const $watermark = document.querySelector(".watermark");
    const SIDE_PANEL_WIDTH_KEY = "idf_side_panel_width";
    const SIDE_PANEL_MIN_WIDTH = 460;
    const COMPACT_UI_MAX_WIDTH = 1120;
    const COMPACT_UI_MAX_HEIGHT = 760;

    function isCompactViewportForOpenPanels(){
      return window.matchMedia("(max-width: 980px)").matches
        || window.innerWidth <= COMPACT_UI_MAX_WIDTH
        || window.innerHeight <= COMPACT_UI_MAX_HEIGHT;
    }
    function isPanelActuallyOpen(el){
      return !!el && getComputedStyle(el).display !== "none" && !el.classList.contains("is-closing");
    }
    function getActiveRightPanelWidth(){
      const dbusPanel = document.getElementById("dbusPanel");
      if (isPanelActuallyOpen(dbusPanel)) {
        return Math.round(dbusPanel.getBoundingClientRect().width);
      }
      const settingsPanel = document.getElementById("settingsPanel");
      if (isPanelActuallyOpen(settingsPanel)) {
        return Math.round(settingsPanel.getBoundingClientRect().width);
      }
      return 0;
    }
    function refreshHeaderMetrics(){
      const root = document.documentElement;
      const computed = getComputedStyle(root);
      const topOffset = parseFloat(computed.getPropertyValue("--topbar-top")) || 0;
      const gap = parseFloat(computed.getPropertyValue("--topbar-gap")) || 0;
      const fallbackSiteHeight = parseFloat(computed.getPropertyValue("--sitebar-height")) || 52;
      const fallbackMapHeight = parseFloat(computed.getPropertyValue("--mapbar-height")) || 56;
      const siteHeight = $siteTopBar ? Math.ceil($siteTopBar.getBoundingClientRect().height) : fallbackSiteHeight;
      const mapHeight = $topBar ? Math.ceil($topBar.getBoundingClientRect().height) : fallbackMapHeight;
      const siteHeaderHeight = topOffset + siteHeight;
      const stackHeight = siteHeaderHeight + gap + mapHeight;
      root.style.setProperty("--site-header-h", `${siteHeaderHeight}px`);
      root.style.setProperty("--header-stack-h", `${stackHeight}px`);
    }
    if ("ResizeObserver" in window) {
      const headerResizeObserver = new ResizeObserver(() => {
        refreshHeaderMetrics();
        if (typeof updateUiOverlays === "function") updateUiOverlays();
      });
      if ($siteTopBar) headerResizeObserver.observe($siteTopBar);
      if ($topBar) headerResizeObserver.observe($topBar);
    }
    refreshHeaderMetrics();
    window.addEventListener("load", () => {
      refreshHeaderMetrics();
      if (typeof updateUiOverlays === "function") updateUiOverlays();
    });

    function getSidePanelMaxWidth(){
      return Math.floor(window.innerWidth / 2);
    }
    function clampSidePanelWidth(width){
      const max = getSidePanelMaxWidth();
      if (max <= SIDE_PANEL_MIN_WIDTH) return SIDE_PANEL_MIN_WIDTH;
      const parsed = Number(width);
      const safe = Number.isFinite(parsed) ? parsed : SIDE_PANEL_MIN_WIDTH;
      return Math.max(SIDE_PANEL_MIN_WIDTH, Math.min(max, Math.round(safe)));
    }
    function setSidePanelWidth(width, { persist = true } = {}){
      const value = clampSidePanelWidth(width);
      document.documentElement.style.setProperty("--sidePanelW", `${value}px`);
      if (persist) localStorage.setItem(SIDE_PANEL_WIDTH_KEY, String(value));
      return value;
    }
    function syncSidePanelWidthFromStorage(){
      const saved = parseInt(localStorage.getItem(SIDE_PANEL_WIDTH_KEY) || "", 10);
      if (Number.isFinite(saved)) setSidePanelWidth(saved, { persist: false });
      else setSidePanelWidth(SIDE_PANEL_MIN_WIDTH, { persist: false });
    }
    function bindSidePanelResize(){
      if (!$panelResizers.length) return;
      const start = (event) => {
        if (window.matchMedia("(max-width: 980px)").matches) return;
        event.preventDefault();
        try { event.currentTarget.setPointerCapture(event.pointerId); } catch {}
        document.body.style.userSelect = "none";
        const currentWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sidePanelW"), 10);
        const frozenWidth = clampSidePanelWidth(Number.isFinite(currentWidth) ? currentWidth : SIDE_PANEL_MIN_WIDTH);
        document.documentElement.style.setProperty("--sidePanelDragShift", `${frozenWidth}px`);
        document.body.classList.add("side-panel-resizing");
        const move = (e) => {
          setSidePanelWidth(window.innerWidth - e.clientX);
        };
        const stop = () => {
          window.removeEventListener("pointermove", move);
          window.removeEventListener("pointerup", stop);
          window.removeEventListener("pointercancel", stop);
          document.body.style.userSelect = "";
          document.body.classList.remove("side-panel-resizing");
          document.documentElement.style.removeProperty("--sidePanelDragShift");
          if (typeof updateUiOverlays === "function") updateUiOverlays();
        };
        window.addEventListener("pointermove", move);
        window.addEventListener("pointerup", stop);
        window.addEventListener("pointercancel", stop);
      };
      $panelResizers.forEach(handle => handle.addEventListener("pointerdown", start));
      window.addEventListener("resize", () => {
        const current = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sidePanelW"), 10);
        setSidePanelWidth(Number.isFinite(current) ? current : SIDE_PANEL_MIN_WIDTH, { persist: false });
        refreshHeaderMetrics();
        if (typeof updateUiOverlays === "function") updateUiOverlays();
      });
    }
    syncSidePanelWidthFromStorage();
    bindSidePanelResize();

    const BRAND_DISPLAY = { renault: 'Renault Trucks', daf: 'DAF', mercedes: 'Mercedes-Benz', volvo : 'Volvo Trucks' };
    function brandLabel(key){
      const k = String(key||'').trim().toLowerCase();
      if (!k) return '';
      if (BRAND_DISPLAY[k]) return BRAND_DISPLAY[k];
      return k.charAt(0).toUpperCase() + k.slice(1);
    }
    function brandsText(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      return arr.map(brandLabel).join(', ');
    }

    let _resIdx = -1;
    function highlightResult(i){
      const items=[...$results.querySelectorAll('.result-item')];
      items.forEach((el,idx)=> el.style.background = idx===i ? "#222222" : "");
    }
    $search.addEventListener('keydown', e=>{
      const items=[...$results.querySelectorAll('.result-item')];
      if(!items.length) return;
      if(e.key==="ArrowDown"){ e.preventDefault(); _resIdx=Math.min(_resIdx+1, items.length-1); highlightResult(_resIdx); }
      if(e.key==="ArrowUp"){ e.preventDefault(); _resIdx=Math.max(_resIdx-1, 0); highlightResult(_resIdx); }
      if(e.key==="Enter" && _resIdx>=0){ items[_resIdx].click(); }
    });

    function dealerBrandKeyFrom(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      const raw = String(arr[0] || "").toLowerCase().trim();
      if (!raw) return "";
      const MAP = { "renault trucks": "renault", "DAF": "daf", "mercedes-benz": "mercedes", "volvo trucks": "volvo" };
      const canonical = MAP[raw] || raw;
      return canonical.replace(/trucks?|camions?/g, "").replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    }

    function addSectionBlock(typeKey, label){
      const head = document.createElement("div");
      head.className = "result-sechead";
        const labelMap = {
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies")
        };
      head.textContent = labelMap[typeKey] || label;
      $results.appendChild(head);

      const body = document.createElement("div");
      body.className = "result-secbody";
      $results.appendChild(body);
      return body;
    }

    window.addEventListener('keydown', e=>{
      if(document.getElementById("linePreviewWrap")?.style.display!=="block") return;
      if(!currentSelectedKey) return;
      const route = (()=> {
        const [lu,ru]=currentSelectedKey.split(":");
        const line=DBUS_LINES.find(l=>l.uid===lu); if(!line) return null;
        return line.routes.find(r=>r.uid===ru);
      })();
      if(!route) return;

      const ids=(route.stops||[]).map(s=>s.uid);
      const idx = ids.indexOf(currentActiveStopId);
      if((e.key==="ArrowRight" || e.key==="ArrowDown") && idx>=0 && idx<ids.length-1){
        const nextId = ids[idx+1];
        const st=DBUS_STOPS.get(nextId);
        const nextMarker = dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx+1];
        centerMarkerWithPreview(nextMarker, st?.latlng, { zoom: map.getZoom(), openPopup: true });
        setActiveStopById(nextId);
      }
      if((e.key==="ArrowLeft" || e.key==="ArrowUp") && idx>0){
        const prevId = ids[idx-1];
        const st=DBUS_STOPS.get(prevId);
        const prevMarker = dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx-1];
        centerMarkerWithPreview(prevMarker, st?.latlng, { zoom: map.getZoom(), openPopup: true });
        setActiveStopById(prevId);
      }
    });


    function applyXY(x, y){ return { x: x * SX + OX, y: y * SY + OY }; }
    function toLatLng(X,Y){
      const px=(X-TileMapInfo.x1)/(TileMapInfo.x2-TileMapInfo.x1)*widthPx;
      const py=(Y-TileMapInfo.y1)/(TileMapInfo.y2-TileMapInfo.y1)*heightPx;
      return map.unproject([px,py],maxNativeZoom);
    }
    function fromLatLngToXY(latlng){
      const pt = map.project(latlng, maxNativeZoom);
      const X = (pt.x/widthPx) * (TileMapInfo.x2 - TileMapInfo.x1) + TileMapInfo.x1;
      const Y = (pt.y/heightPx) * (TileMapInfo.y2 - TileMapInfo.y1) + TileMapInfo.y1;
      return { X, Y };
    }
    const ZOOM_SIZED_IMAGE_OVERLAYS = [];
    let MAP_POI_OVERLAYS_HIDDEN = false;
    const OVERLAY_ZOOM_SCALE_MIN = 0.01;
    const OVERLAY_ZOOM_SCALE_MAX = 1;
    const OVERLAY_ZOOM_SCALE_STEP = 1;
    function getOverlayZoomScale(zoom = map.getZoom()){
      const delta = zoom - maxNativeZoom;
      const raw = Math.pow(1 / (1 + OVERLAY_ZOOM_SCALE_STEP), delta);
      return Math.max(OVERLAY_ZOOM_SCALE_MIN, Math.min(OVERLAY_ZOOM_SCALE_MAX, raw));
    }
    function applyZoomSizedOverlayBounds(rec){
      if (!rec?.overlay) return;
      const scale = getOverlayZoomScale();
      const halfW = (rec.baseWidth * scale) / 2;
      const halfH = (rec.baseHeight * scale) / 2;
      const topLeft = toLatLng(rec.centerX - halfW, rec.centerY + halfH);
      const bottomRight = toLatLng(rec.centerX + halfW, rec.centerY - halfH);
      rec.overlay.setBounds(L.latLngBounds(topLeft, bottomRight));
    }
    function registerZoomSizedImageOverlay(overlay, { centerX, centerY, width, height } = {}){
      if (!overlay) return overlay;
      const cX = Number(centerX), cY = Number(centerY);
      const w = Number(width), h = Number(height);
      if (!Number.isFinite(cX) || !Number.isFinite(cY) || !Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) {
        return overlay;
      }
      const rec = { overlay, centerX: cX, centerY: cY, baseWidth: w, baseHeight: h };
      ZOOM_SIZED_IMAGE_OVERLAYS.push(rec);
      applyZoomSizedOverlayBounds(rec);
      if (MAP_POI_OVERLAYS_HIDDEN) {
        try { if (map.hasLayer(overlay)) map.removeLayer(overlay); } catch {}
      }
      return overlay;
    }
    function refreshZoomSizedImageOverlays(){
      ZOOM_SIZED_IMAGE_OVERLAYS.forEach(applyZoomSizedOverlayBounds);
    }
    function bringPoiOverlaysToFront(){
      ZOOM_SIZED_IMAGE_OVERLAYS.forEach(rec => {
        const overlay = rec?.overlay;
        if (!overlay || typeof overlay.bringToFront !== "function") return;
        try { overlay.bringToFront(); } catch {}
      });
    }
    map.on("zoomend", refreshZoomSizedImageOverlays);

    const transitScroll = document.querySelector("#linePreview .transit-scroll");
    const linePreviewStopsBox = document.querySelector("#linePreview .line-preview-stops");
    const linePreviewCueTop = document.querySelector("#linePreview .line-preview-scroll-cue.top");
    const linePreviewCueBottom = document.querySelector("#linePreview .line-preview-scroll-cue.bottom");
    function updateLinePreviewScrollCues(){
      if (!transitScroll || !linePreviewStopsBox) return;
      if (isLinePreviewHorizontal()) {
        linePreviewStopsBox.classList.remove("can-scroll-up", "can-scroll-down");
        return;
      }
      const maxScroll = Math.max(0, transitScroll.scrollHeight - transitScroll.clientHeight);
      const hasOverflow = maxScroll > 2;
      const canScrollUp = hasOverflow && transitScroll.scrollTop > 2;
      const canScrollDown = hasOverflow && transitScroll.scrollTop < (maxScroll - 2);
      linePreviewStopsBox.classList.toggle("can-scroll-up", canScrollUp);
      linePreviewStopsBox.classList.toggle("can-scroll-down", canScrollDown);
    }
    function scrollLinePreviewByStops(step){
      if (!transitScroll) return;
      const transit = document.getElementById("lpTransit");
      if (!transit) return;
      const stops = [...transit.querySelectorAll(".stop")];
      if (!stops.length) return;
      const dir = step < 0 ? -1 : 1;
      if (isLinePreviewHorizontal()) {
        const scrollLeft = transitScroll.scrollLeft;
        let currentIndex = stops.findIndex(stop => (stop.offsetLeft + stop.offsetWidth) > (scrollLeft + 2));
        if (currentIndex < 0) currentIndex = stops.length - 1;
        const targetIndex = Math.max(0, Math.min(stops.length - 1, currentIndex + dir));
        const targetLeft = Math.max(0, stops[targetIndex].offsetLeft - 8);
        transitScroll.scrollTo({ left: targetLeft, behavior: UI_ANIMATIONS ? "smooth" : "auto" });
        return;
      }
      const scrollTop = transitScroll.scrollTop;
      let currentIndex = stops.findIndex(stop => (stop.offsetTop + stop.offsetHeight) > (scrollTop + 2));
      if (currentIndex < 0) currentIndex = stops.length - 1;
      const targetIndex = Math.max(0, Math.min(stops.length - 1, currentIndex + dir));
      const targetTop = Math.max(0, stops[targetIndex].offsetTop - 2);
      transitScroll.scrollTo({ top: targetTop, behavior: UI_ANIMATIONS ? "smooth" : "auto" });
    }
    if (transitScroll) {
      transitScroll.addEventListener("wheel", function (e) {
        if (isLinePreviewHorizontal()) {
          const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
          if (Math.abs(delta) < 1) return;
          e.preventDefault();
          transitScroll.scrollLeft += delta;
          return;
        }
        if (Math.abs(e.deltaX) <= Math.abs(e.deltaY)) return;
        e.preventDefault();
        transitScroll.scrollTop += e.deltaX;
      }, { passive: false });
      transitScroll.addEventListener("scroll", updateLinePreviewScrollCues, { passive: true });
      window.addEventListener("resize", () => requestAnimationFrame(updateLinePreviewScrollCues));
      requestAnimationFrame(updateLinePreviewScrollCues);
    }
    linePreviewCueTop?.addEventListener("click", () => scrollLinePreviewByStops(-1));
    linePreviewCueBottom?.addEventListener("click", () => scrollLinePreviewByStops(1));
    linePreviewCueTop?.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        scrollLinePreviewByStops(-1);
      }
    });
    linePreviewCueBottom?.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        scrollLinePreviewByStops(1);
      }
    });

    const cityLayer=L.layerGroup().addTo(map);
    const cityMarkers=[],searchIndex=[];
    let selectedCityMarker = null;

    const $btnDbus = document.getElementById("btnDbus");
    const $panelDbus = document.getElementById("dbusPanel");
    const $dbusList = document.getElementById("dbusList");
    const $dbusLinesBox = document.querySelector("#dbusPanel .dbus-lines-box");
    const $dbusLinesContent = $dbusLinesBox ? $dbusLinesBox.querySelector(".dbus-content") : null;
    const $dbusRoutesBox = document.getElementById("dbusRoutesBox");
    const $dbusRoutesTitleLabel = document.getElementById("dbusRoutesTitleLabel");
    const $dbusRoutesClear = document.getElementById("dbusRoutesClear");
    const $dbusRoutesList = document.getElementById("dbusRoutesList");
    const $dbusDepartList = document.getElementById("dbusDepartList");
    const $dbusDepartActions = document.getElementById("dbusDepartActions");
    const $dbusDepartMapBtn = document.getElementById("dbusDepartMapBtn");
    const $selectedChip = document.getElementById("selectedChip");
    const $dbusStopPanel = document.getElementById("dbusStopPanel");
    const $dbusStopTitle = document.getElementById("dbusStopTitle");
    const $dbusStopList = document.getElementById("dbusStopList");
    const $dbusModeButtons = document.querySelectorAll(".dbus-sort-modes .dbus-mode-btn[data-mode]");
    const $dbusSchoolToggle = document.getElementById("dbusSchoolToggle");
    const $dbusFictiveToggle = document.getElementById("dbusFictiveToggle");
    const $settingsSchoolToggle = document.getElementById("settingsSchoolToggle");
    const $settingsFictiveToggle = document.getElementById("settingsFictiveToggle");
    const $dbusDepartIndicatorWrap = document.getElementById("dbusDepartIndicatorWrap");
    const $dbusDepartIndicatorLabel = document.getElementById("dbusDepartIndicatorLabel");
    const $dbusDepartIndicatorClose = document.getElementById("dbusDepartIndicatorClose");
    
    map.on('mousemove', (e) => {
      if (!$analysisHUD) return;
      try{
        const { X, Y } = fromLatLngToXY(e.latlng);
        $analysisHUD.textContent = `X: ${X.toFixed(2)}  Y: ${Y.toFixed(2)}`;
      }catch{}
    });

    function wikiTitleForCity(name){
      const m = /^Paris\s+(\d{1,2})(?:er|e|eme|ème|th|st|nd|rd)?$/i.exec(String(name||"").trim());
      if (m){
        const n = parseInt(m[1], 10);
        if (LANG === "en"){
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }
      return String(name||"").replaceAll(" ", "_");
    }
    function normalizeParisArrondissement(title){
      const s0 = String(title || "");

      if (/\barrondissement_(de|of)_Paris\b/i.test(s0)) return s0;

      const s = s0
        .replace(/ /g, "_")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");

      let m = /^(\d{1,2})(?:er|e|eme)?_arrondissement_(?:de|of)_paris$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?_arrondissement$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      return s0;
    }
    async function fetchWikiSummary(title){
      const url = (LANG==="en" ? "https://en.wikipedia.org/api/rest_v1/page/summary/" : "https://fr.wikipedia.org/api/rest_v1/page/summary/") + encodeURIComponent(title);
      const r = await fetch(url); if (!r.ok) throw new Error("wiki fetch"); return r.json();
    }

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function trimAroundRER(s, mode ){
      const txt = String(s || "").trim();
      if (!/\bRER\b/i.test(txt)) return txt;
      if (mode === 'start'){
        const m = txt.match(/^(.*?)\s*[–—-]\s*RER\b/i);
        return (m && m[1]) ? m[1].trim() : txt;
      } else {
        const m = txt.match(/\bRER\b\s*[–—-]\s*(.+)$/i);
        return (m && m[1]) ? m[1].trim() : txt;
      }
    }

    function decodeHTML(s){
      const t = document.createElement('textarea');
      t.innerHTML = String(s ?? "");
      return t.value;
    }

    function withRERIcon(text, opts = {}){ const caseInsensitive = !!opts.caseInsensitive;
      const esc = escapeHTML(text ?? "");
      const flags = caseInsensitive ? "gi" : "g";
      return esc
        .replace(new RegExp("(?:\\s*[---]\\s*)?\\bRER\\b(?:\\s*[---]\\s*)?", flags),
                ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(new RegExp("(?:\\s*[---]\\s*)?\\bM[ée]tro\\b(?:\\s*[---]\\s*)?", flags),
                ' <span class="metro-ico" aria-label="Métro"></span> ')
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    async function openCityPopup(cityObj, marker) {
      const latlng = marker.getLatLng();
      let rawTitle = normalizeParisArrondissement(wikiTitleForCity(cityObj.Name));
      const p = L.popup({ maxWidth: 380, autoPan: true })
        .setLatLng(latlng)
        .setContent(`<b>${cityObj.Name}</b><br><span class="spinner" aria-label="${t('loading')}"></span>`).openOn(map);
      try {
        const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
          try {
            const d0 = await fetchWikiSummary(baseTitle);
            if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
          } catch {}
          const sufList = (LANG === "en")
            ? [",_Val-de-Marne", ",_Essonne", ",_Hauts-de-Seine", ",_Seine-Saint-Denis",
              ",_Val-d'Oise", ",_Seine-et-Marne", ",_Yvelines"]
            : ["_(Commune_franà§aise)", "_(Val-de-Marne)", "_(Essonne)", "_(Hauts-de-Seine)",
              "_(Seine-Saint-Denis)", "_(Val-d'Oise)", "_(Seine-et-Marne)", "_(Yvelines)"];

          for (const suf of sufList) {
            try {
              const d = await fetchWikiSummary(baseTitle + suf);
              if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
            } catch {}
          }
          return { title: baseTitle, data: null };
        })(rawTitle);

        const pageUrl = wikiBase() + finalTitle;
        const desc = data?.description || "";
        const img = data?.thumbnail?.source || "";
        const html = data ? `
          <div style="display:flex;gap:10px;align-items:flex-start">
            ${img ? `<img src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
            <div style="min-width:0">
              <div style="font-weight:700;margin-bottom:4px">${cityObj.Name}</div>
              <div style="color:#8f8f8f;font-size:12px;margin-bottom:8px">${desc}</div>
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>
          </div>` :
          `<div style="min-width:0">
            <div style="font-weight:700;margin-bottom:6px">${cityObj.Name}</div>
            <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
          </div>`;
        p.setContent(html);
      } catch {}
    }

    tileInfoReady.then(()=> fetch(dataPath("Cities.json"))).then(r=>r.json()).then(cities=>{
      cities.forEach(city=>{
        const icon=L.divIcon({className:"",html:`<span class="city-label">${city.Name}</span>`,iconSize:[0,0]});
        const m=L.marker(toLatLng(city.X,city.Y),{icon,interactive:true,bubblingMouseEvents:true}).addTo(cityLayer);
        m.on("click", ()=> openCityPopup(city, m));
        cityMarkers.push(m);
        searchIndex.push({type:"Ville",name:city.Name||t("city"),city:"",center:m.getLatLng(),open:()=>openCityPopup(city, m)});
      });
      updateCityLabels();
    }).catch(err=>console.error("Erreur chargement Cities.json",err));

    function updateCityLabels(){
      const zMin=map.getMinZoom(),zMax=map.getMaxZoom(),z=map.getZoom(),SMALL=8,LARGE=20,t=(z-zMin)/Math.max(1,(zMax-zMin)),px=Math.round(SMALL+t*(LARGE-SMALL));
      cityMarkers.forEach(m=>{const el=m.getElement();if(!el)return;const span=el.querySelector(".city-label");if(!span)return;span.style.fontSize=px+"px";span.style.opacity=(t<0.05)?0.8:1;});
    }
    map.on("zoomend",updateCityLabels);

    const DEDUPE_MIN_PX_BASE = 100;
    const MAP_ICON_UNIFORM_SIZE = 25;
    const _placedByIcon = new Map();
    function _isTooClose(iconId, latlng, minPx){
      const pt = map.project(latlng, maxNativeZoom);
      const list = _placedByIcon.get(iconId) || [];
      for(const p of list){ const dx = pt.x - p.x, dy = pt.y - p.y; if (Math.hypot(dx, dy) < minPx) return true; }
      list.push({x: pt.x, y: pt.y}); _placedByIcon.set(iconId, list); return false;
    }

    function bindPopupWithImage(layer, html){
      layer.bindPopup(html);
      layer.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => {
            try { e.popup.update(); } catch {}
          }, { once: true });
        }
      });
    }
    function openLayerPopup(layer, latlng){
      if (!layer || typeof layer.openPopup !== "function") return;
      try { map.closePopup(); } catch {}
      layer.openPopup(latlng);
    }
    function setPopupContentWithImage(layer, html){
      if (layer.getPopup()) {
        layer.setPopupContent(html);
      } else {
        bindPopupWithImage(layer, html);
      }
    }

    function iconLabel(iconId){
      const map = {
        "gas_ico": t("icon_gas"),
        "bus_ico": t("icon_bus_station"),
        "service_ico": t("icon_repair_shop"),
        "garage_large_ico": t("icon_garage"),
        "recruitment_ico": t("icon_recruitment_agency"),
        "dealer_ico": t("icon_dealer"),
        "border_ico": t("icon_border_control"),
        "toll_ico": t("icon_toll"),
        "parking_ico": t("icon_parking")
      };
      return map[iconId];
    }

    tileInfoReady
      .then(() => fetch(dataPath("CentreCommerciaux.json")))
      .then(r => r.ok ? r.json() : Promise.reject("CentreCommerciaux.json"))
      .then(malls => {
        malls.forEach(ov => {
          const width = MAP_ICON_UNIFORM_SIZE;
          const height = MAP_ICON_UNIFORM_SIZE;

          const centerLL = toLatLng(ov.X, ov.Y);
          const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
          const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
          const bounds = L.latLngBounds(topLeft, bottomRight);

          const key = "overlay_centrecom";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;

          const overlay = registerZoomSizedImageOverlay(
            L.imageOverlay(overlayPath("overlay_centrecom.png"), bounds, { interactive: true, bubblingMouseEvents: false }).addTo(map),
            { centerX: ov.X, centerY: ov.Y, width, height }
          );
          const popup = L.popup({ maxWidth: 420, autoPan: true });
          overlay.bindPopup(popup);

          overlay.on('popupopen', (e) => {
            const el = e.popup.getElement();
            const img = el && el.querySelector('img[data-autosize]');
            if (img && !img.complete) {
              img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
            }
          });

          const rawName = String(ov.Name || "").trim();
          const city = String(ov.City || "").trim();
          const wikiKey = String(ov.wiki || "").trim();

          overlay.on("click", async () => {
            const displayName = `${t("mall")} ${rawName}`.trim();
            const p = overlay.getPopup();
            p.setLatLng(bounds.getCenter());

            if (!wikiKey) {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
              openLayerPopup(overlay);
              return;
            }

            p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
            openLayerPopup(overlay);

            try {
              const baseTitle = wikiTitleFrom(wikiKey);
              const { title: finalTitle, data } = await (async function resolveWikiSummary(title){
                try {
                  const d0 = await fetchWikiSummary(title);
                  if (d0?.type !== "disambiguation") return { title, data: d0 };
                } catch {}
                for (const suf of [
                  "_(Paris)", "_(Île-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
                  "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
                  "_(Centre_commercial)", "_(Centre_commercial_en_France)"
                ]) {
                  try {
                    const d = await fetchWikiSummary(title + suf);
                    if (d?.type !== "disambiguation") return { title: title + suf, data: d };
                  } catch {}
                }
                return { title, data: null };
              })(baseTitle);

              const pageUrlFromAPI = data?.content_urls?.desktop?.page || null;
              const hasPage = !!pageUrlFromAPI;
              const desc = data?.description || "";
              const img = data?.thumbnail?.source || "";

              const linkHTML = hasPage
                ? `<a href="${pageUrlFromAPI}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>`
                : "";

              const html = data ? `
                <div style="display:flex;gap:10px;align-items:flex-start">
                  ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
                  <div style="min-width:0">
                    <div style="font-weight:700;margin-bottom:4px">${escapeHTML(displayName)}</div>
                    ${city ? `<div style="color:#8f8f8f;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                    <div style="color:#8f8f8f;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                    ${linkHTML}
                  </div>
                </div>` :
                `<div style="min-width:0">
                  <div style="font-weight:700;margin-bottom:6px">${escapeHTML(displayName)}</div>
                  ${city ? `<div style="color:#8f8f8f;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
                </div>`;


              p.setContent(html);
            } catch {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
            }
          });

          searchIndex.push({
            type: "Centre commercial",
            name: rawName,
            city,
            center: bounds.getCenter(),
            open: () => { overlay.fire('click'); },
            logo: overlayPath("overlay_centrecom.png"),
            fallbackLogo: overlayPath("overlay_centrecom.png")
          });
        });
      })
      .catch(err => console.error("CentreCommerciaux.json error:", err));

    tileInfoReady.then(()=> fetch(dataPath("Overlays.json"))).then(r=>r.json()).then(overlays=>{
      overlays.forEach(ov=>{
        const width = MAP_ICON_UNIFORM_SIZE;
        const height = MAP_ICON_UNIFORM_SIZE;
        const centerLL = toLatLng(ov.X, ov.Y);

        if(!ov.IconId) return;
        if(
          ov.IconId.startsWith("bus_") && ov.IconId !== "bus_ico" ||
          ov.IconId.startsWith("uk_")  ||
          ov.IconId.startsWith("fr_")  ||
          ov.IconId.startsWith("b_")   ||
          ov.IconId.startsWith("bg_")  ||
          ov.IconId.startsWith("train_ico")  ||
          ov.IconId.startsWith("port_overlay")  ||
          ov.IconId.startsWith("d334p")  ||
          ov.IconId.startsWith("viewpoint")
        ){ return; }

        const isCompany = (ov.Type === "Company");

        if (!isCompany) {
          const key = ov.IconId || ov.Type || "__misc";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width||0, height||0) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;
        }

        const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
        const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
        const bounds = L.latLngBounds(topLeft, bottomRight);

       if (ov.Type==="Company"){
        const companyCenterX = ov.X + 10;
        const companyCenterY = ov.Y - 10;
        const compTopLeft = toLatLng(companyCenterX - (width / 2), companyCenterY + (height / 2));
        const compBottomRight = toLatLng(companyCenterX + (width / 2), companyCenterY - (height / 2));
        const compBounds=L.latLngBounds(compTopLeft,compBottomRight);
        const overlay = registerZoomSizedImageOverlay(
          L.imageOverlay(overlayPath("button.png"),compBounds,{interactive:true,bubblingMouseEvents:false}).addTo(map),
          { centerX: companyCenterX, centerY: companyCenterY, width, height }
        );

        const logoPath = overlayPath(`${ov.IconId}.png`);

        bindPopupWithImage(overlay, `
          <div style="text-align:center">
            <img data-autosize src="${logoPath}"
                style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
            <b>${escapeHTML(ov.Name)}</b><br/><i>${escapeHTML(ov.City||"")}</i>
          </div>
        `);

        searchIndex.push({
          type:"Entreprise",
          name:ov.Name||t("company"),
          city:ov.City||"",
          center:compBounds.getCenter(),
          open:()=>{ openLayerPopup(overlay, compBounds.getCenter()); },
          logo:logoPath
        });
      } else if (ov.Type === "TruckDealer" || ov.IconId === "dealer_ico") {
            const overlay = registerZoomSizedImageOverlay(
              L.imageOverlay(overlayPath(`${ov.IconId}.png`), bounds, { interactive: true, bubblingMouseEvents: false }).addTo(map),
              { centerX: ov.X, centerY: ov.Y, width, height }
            );
            const btxt = brandsText(ov) || '—';

            const brandKey = dealerBrandKeyFrom(ov);
            const brandLogo = brandKey ? overlayPath(`dealer_${brandKey}.png`) : overlayPath("dealer_ico.png");

            const updateDealerPopup = () => {
              const html = `
                <div style="text-align:center">
                  <img data-autosize src="${brandLogo}"
                      style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
                  <b>${escapeHTML(`${t("dealer")} ${btxt}`.trim())}</b><br/><i>${escapeHTML(ov.City || "")}</i>
                </div>
              `;
              setPopupContentWithImage(overlay, html);
            };

            const openDealerPopup = () => {
              updateDealerPopup();
              openLayerPopup(overlay, bounds.getCenter());
            };
            overlay.on("click", openDealerPopup);
            registerI18nLayer(overlay, updateDealerPopup);

            searchIndex.push({
              type: "Concessionnaire",
              name: `${btxt}`.trim(),         
              brand: btxt,                   
              city: ov.City || "",
              center: bounds.getCenter(),
              open: openDealerPopup,
              logo: brandLogo,
              fallbackLogo: overlayPath("dealer_ico.png")
            });
          
        } else {
          const overlay = registerZoomSizedImageOverlay(
            L.imageOverlay(overlayPath(`${ov.IconId}.png`), bounds, { interactive: true, bubblingMouseEvents: false }).addTo(map),
            { centerX: ov.X, centerY: ov.Y, width, height }
          );
          const updateIconPopup = () => {
            const label = iconLabel(ov.IconId) || ov.Name || ov.Type || t("place");
            if (overlay.getPopup()) {
              overlay.setPopupContent(`<b>${escapeHTML(label)}</b>`);
            } else {
              overlay.bindPopup(`<b>${escapeHTML(label)}</b>`);
            }
          };
          const openIconPopup = () => {
            updateIconPopup();
            openLayerPopup(overlay, bounds.getCenter());
          };
          overlay.on("click", openIconPopup);
          registerI18nLayer(overlay, updateIconPopup);

          const typeTag =
            ov.IconId === "service_ico"       ? "Atelier" :
            ov.IconId === "recruitment_ico"   ? "Agence"  :
            ov.IconId === "garage_large_ico"  ? "Garage"  :
            null;

          if (typeTag) {
            const logoPath =
              ov.IconId === "service_ico"      ? overlayPath("service_ico.png") :
              ov.IconId === "recruitment_ico"  ? overlayPath("recruitment_ico.png") :
              ov.IconId === "garage_large_ico" ? overlayPath("garage_large_ico.png") :
              overlayPath(`${ov.IconId}.png`);

            const keywordName =
              typeTag === "Atelier" ? `Atelier de réparation ${ov.City || ""}` :
              typeTag === "Agence"  ? `Agence de recrutement ${ov.City || ""}` :
                          `Garage ${ov.City || ""}`;

            searchIndex.push({
              type: typeTag,               
              name: keywordName.trim(),    
              city: ov.City || "",
              center: bounds.getCenter(),
              open: openIconPopup,
              logo: logoPath,
              fallbackLogo: logoPath
            });
          }
        }
      });
    });

    function wikiTitleFrom(urlOrTitle){
      const s = String(urlOrTitle||"").trim();
      try{
        const u = new URL(s);
        const m = /\/wiki\/(.+)$/.exec(u.pathname);
        return m ? decodeURIComponent(m[1]) : s.replaceAll(" ", "_");
      }catch{
        return s.replaceAll(" ", "_");
      }
    }


  tileInfoReady
  .then(() => fetch(dataPath("Monuments.json")))
  .then(r => r.ok ? r.json() : Promise.reject("Monuments.json"))
  .then(monuments => {
    monuments.forEach(ov => {
      const width = MAP_ICON_UNIFORM_SIZE;
      const height = MAP_ICON_UNIFORM_SIZE;

      const centerLL = toLatLng(ov.X, ov.Y);
      const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
      const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
      const bounds = L.latLngBounds(topLeft, bottomRight);

      const key = "overlay_monument";
      const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
      if (_isTooClose(key, centerLL, minPx)) return;

      const overlay = registerZoomSizedImageOverlay(
        L.imageOverlay(overlayPath("overlay_monument.png"), bounds, { interactive: true, bubblingMouseEvents: false }).addTo(map),
        { centerX: ov.X, centerY: ov.Y, width, height }
      );
      const popup = L.popup({ maxWidth: 420, autoPan: true });
      overlay.bindPopup(popup);

      overlay.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
        }
      });

      const name = String(ov.Name || "").trim();
      const city = String(ov.City || "").trim();
      const wikiTitle = wikiTitleFrom(ov.wiki || ov.IconId || name);

      overlay.on("click", async () => {
        const p = overlay.getPopup();
        p.setLatLng(bounds.getCenter());
        p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
        openLayerPopup(overlay);

        try {
          const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
            try {
              const d0 = await fetchWikiSummary(baseTitle);
              if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
            } catch {}
            for (const suf of [
              "_(Paris)", "_(Île-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
              "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
              "_(Monument)"
            ]) {
              try {
                const d = await fetchWikiSummary(baseTitle + suf);
                if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
              } catch {}
            }
            return { title: baseTitle, data: null };
          })(wikiTitle);

          const pageUrl = wikiBase() + finalTitle;
          const desc = data?.description || "";
          const img = data?.thumbnail?.source || "";

          const html = data ? `
            <div style="display:flex;gap:10px;align-items:flex-start">
              ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
              <div style="min-width:0">
                <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                ${city ? `<div style="color:#8f8f8f;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                <div style="color:#8f8f8f;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
              </div>
            </div>` :
            `<div style="min-width:0">
              <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
              ${city ? `<div style="color:#8f8f8f;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>`;

          p.setContent(html);
        } catch {
          p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
        }
      });

      searchIndex.push({
        type: "Monument",
        name,
        city,
        center: bounds.getCenter(),
        open: () => { 
          const p = overlay.getPopup();
          if (p) { p.setLatLng(bounds.getCenter()); }
          overlay.fire('click');
        },
        logo: overlayPath("overlay_monument.png"),
        fallbackLogo: overlayPath("overlay_monument.png")
      });
    });
  })
  .catch(err => console.error("Monuments.json error:", err));


      
    function applyInitialView() {
      const qs = new URLSearchParams(location.search);
      const x = parseFloat(qs.get("x"));
      const y = parseFloat(qs.get("y"));
      const z = parseFloat(qs.get("z"));

      if (Number.isFinite(x) && Number.isFinite(y)) {
        const ll = toLatLng(x, y);

        const ib = innerBounds(MARGIN);
        const clamped = L.latLng(
          Math.max(Math.min(ll.lat, ib.getNorth()), ib.getSouth()),
          Math.max(Math.min(ll.lng, ib.getEast()),  ib.getWest())
        );

        const targetZoom = Number.isFinite(z)
          ? Math.max(map.getMinZoom(), Math.min(map.getMaxZoom(), z))
          : map.getZoom();

        map.setView(clamped, targetZoom, { animate: false });
      }
    }

    tileInfoReady.then(() => { applyInitialView(); });

    const routeAnimHandles = new Map();
    function animatePolyline(poly, { speed = 1.2, dash = "14 10", reverse = false } = {}) {
      const apply = (path) => {
        path.style.strokeDasharray = dash;
        let offset = 0, raf = 0;
        const tick = () => { offset = (offset + speed) % 10000; path.style.strokeDashoffset = reverse ? String(-offset) : String(offset); raf = requestAnimationFrame(tick); };
        tick();
        return () => { cancelAnimationFrame(raf); path.style.strokeDasharray = ""; path.style.strokeDashoffset = ""; };
      };
      let stopFn = null;
      if (poly._path) { stopFn = apply(poly._path); }
      else { poly.once("add", () => { if (poly._path) stopFn = apply(poly._path); }); }
      return { stop: () => { try { stopFn && stopFn(); } catch {} } };
    }
    function startLineAnim(key, poly) { stopLineAnim(key); const h = animatePolyline(poly, { speed: 0.1, dash: "30 10", reverse: true }); routeAnimHandles.set(key, h); }
    function stopLineAnim(key) { const h = routeAnimHandles.get(key); if (h) { h.stop(); routeAnimHandles.delete(key); } }

    const dbusRoot = `${DBUS_BASE}/IDF MAP`;
    const dbusLayers = L.layerGroup().addTo(map);
    const dbusStopsLayer = L.layerGroup().addTo(map);
    const dbusDepartLayers = L.layerGroup();
    const dbusRouteLayers = new Map();
    let currentSelectedKey = "";
    let currentSelectedLineUid = "";
    let dbusRoutesClosedByPanel = false;
    const DBUS_MODES = { LINES: "lines", LENGTH: "length", DEPARTS: "departures" };
    let currentDbusMode = DBUS_MODES.LINES;
    let dbusDisplayMode = "normal";
    let showSchoolLines = false;
    let showFictiveLines = false;
    let renderDbusLinesList = null;
    const DBUS_DEPART_MERGE_PX = 100;
    let dbusDepartGroups = [];
    let dbusDepartMarkers = new Map();
    let dbusDepartNameIndex = new Map();
    let selectedDepartMarker = null;
    let dbusDepartFilterKey = `${showSchoolLines}-${showFictiveLines}`;
    let dbusDepartPreviewActive = false;

    async function fetchXml(path){
      const res = await fetch(path);
      if(!res.ok) throw new Error("XML load failed: "+path);
      const txt = await res.text();
      const parser = new DOMParser();
      return parser.parseFromString(txt, "text/xml");
    }

    let DBUS_STOPS = new Map();
    let dbusStopLineEntries = new Map();
    let dbusStopMarkers = new Map();
    const DBUS_STOP_ICON_CACHE = new Map();
    const DBUS_STOP_NON_MAX_RATIO = 0.75;
    const DBUS_STOP_MERGE_FACTOR = 1.05;
    let dbusStopIconSizePx = 0;
    function getOverlayIconPixelSize(baseWidth = MAP_ICON_UNIFORM_SIZE, zoom = map.getZoom()){
      if (!TileMapInfo) return Math.max(4, Math.round(baseWidth));
      const cx = (TileMapInfo.x1 + TileMapInfo.x2) / 2;
      const cy = (TileMapInfo.y1 + TileMapInfo.y2) / 2;
      const worldW = baseWidth * getOverlayZoomScale(zoom);
      const left = toLatLng(cx - (worldW / 2), cy);
      const right = toLatLng(cx + (worldW / 2), cy);
      const p1 = map.project(left, zoom);
      const p2 = map.project(right, zoom);
      return Math.max(2, Math.round(Math.abs(p2.x - p1.x)));
    }
    function getDbusStopIconSize(zoom = map.getZoom()){
      const basePx = getOverlayIconPixelSize(MAP_ICON_UNIFORM_SIZE, zoom);
      return Math.max(2, Math.round(basePx * DBUS_STOP_NON_MAX_RATIO));
    }
    function shouldShowStopClusterCount(zoom = map.getZoom()){
      return zoom >= (map.getMaxZoom() - 2);
    }
    function getDbusStopIcon(sizePx, count = 1, { showCount = true } = {}){
      const size = Math.max(4, Math.round(Number(sizePx) || 0));
      const safeCount = Math.max(1, Math.round(Number(count) || 1));
      const key = `${size}:${safeCount}:${showCount ? 1 : 0}`;
      if (DBUS_STOP_ICON_CACHE.has(key)) return DBUS_STOP_ICON_CACHE.get(key);
      const countHtml = (showCount && safeCount > 1) ? `<span class="dbus-stop-marker-count">${safeCount}</span>` : "";
      const icon = L.divIcon({
        className: "dbus-stop-marker-host",
        html: `
          <div class="dbus-stop-marker-wrap" style="width:${size}px;height:${size}px;">
            <img class="dbus-stop-marker" src="${overlayPath("bus_logo_idfm.png")}" alt="" aria-hidden="true"/>
            ${countHtml}
          </div>
        `,
        iconSize: [size, size],
        iconAnchor: [Math.round(size / 2), Math.round(size / 2)]
      });
      DBUS_STOP_ICON_CACHE.set(key, icon);
      return icon;
    }
    function isDbusLineVisibleForStopMarkers(line){
      const cat = getCategory(line);
      if (!showSchoolLines && cat === "Scolaire") return false;
      if (!showFictiveLines && cat === "Autres") return false;
      return true;
    }
    function collectVisibleStopLineEntries(stopIds){
      const ids = Array.isArray(stopIds) ? stopIds : [stopIds];
      const byLineUid = new Map();
      ids.forEach(stopId => {
        const entries = dbusStopLineEntries.get(stopId) || [];
        entries.forEach(entry => {
          if (!entry?.line || !entry?.route) return;
          if (!isDbusLineVisibleForStopMarkers(entry.line)) return;
          const uid = String(entry.line.uid || "");
          if (!uid || byLineUid.has(uid)) return;
          byLineUid.set(uid, entry);
        });
      });
      return [...byLineUid.values()].sort((a, b) => {
        const aNum = String(getLineNumber(a.line, a.route) || "").trim();
        const bNum = String(getLineNumber(b.line, b.route) || "").trim();
        const aIsNum = /^\d+$/.test(aNum);
        const bIsNum = /^\d+$/.test(bNum);
        if (aIsNum && bIsNum) return (parseInt(aNum, 10) || 0) - (parseInt(bNum, 10) || 0);
        if (aIsNum !== bIsNum) return aIsNum ? -1 : 1;
        const cmp = aNum.localeCompare(bNum, "fr", { numeric: true, sensitivity: "base" });
        if (cmp !== 0) return cmp;
        return String(a.line.uid || "").localeCompare(String(b.line.uid || ""), "fr", { numeric: true, sensitivity: "base" });
      });
    }
    function getVisibleStopLineEntries(stopId){
      return collectVisibleStopLineEntries(stopId);
    }
    function buildDbusStopLineEntries(){
      const next = new Map();
      DBUS_LINES.forEach(line => {
        (line.routes || []).forEach(route => {
          (route.stops || []).forEach(stopRef => {
            const stopId = Number(stopRef?.uid);
            if (!Number.isFinite(stopId) || !DBUS_STOPS.has(stopId)) return;
            if (!next.has(stopId)) next.set(stopId, []);
            next.get(stopId).push({ line, route });
          });
        });
      });
      dbusStopLineEntries = next;
    }
    function isTitusEntry(entry){
      if (!entry?.line) return false;
      const lineNum = String(getLineNumber(entry.line, entry.route) || "").trim();
      return isTitusLine(entry.line) || /^titus\s*\d+/i.test(lineNum);
    }
    function getStopBadgeSize(label){
      const raw = String(label || "").trim();
      if (/^express\b/i.test(raw)) return "128x26";
      return "62x26";
    }
    function getStopEntryLineLabel(entry){
      const routeName = String(entry?.route?.name || "").trim();
      const lineLabel = String(getLineNumber(entry?.line, entry?.route) || "?").trim();
      const parsed = parseRouteName(routeName || "");
      const parsedNumber = String(parsed?.lineNumber || "").trim();
      if (/^express\b/i.test(parsedNumber) && /\d/.test(parsedNumber)) {
        return parsedNumber.replace(/\s+/g, " ").trim();
      }
      const routeExpressMatch = routeName.match(/\bexpress\s*(\d+)/i);
      if (routeExpressMatch && routeExpressMatch[1]) {
        return `Express ${routeExpressMatch[1]}`.replace(/\s+/g, " ").trim();
      }
      if (/^express\b/i.test(lineLabel)) {
        const n = (parsedNumber.match(/\d+/) || routeExpressMatch || routeName.match(/\d+/) || [])[0];
        if (n) return `Express ${n}`;
      }
      return lineLabel;
    }
    function getFictiveBadgeLabel(entry){
      const routeName = String(entry?.route?.name || "").trim();
      const lineRaw = String(entry?.line?.number || "").trim();
      const parsed = parseRouteName(routeName || lineRaw || "");
      const parsedNumber = String(parsed?.lineNumber || "").trim();
      const merged = `${routeName} ${lineRaw} ${parsedNumber}`;
      if (/express/i.test(merged)) {
        let label = [parsedNumber, lineRaw].find(v => /^express\b/i.test(String(v || "").trim())) || "";
        const routeMatch = routeName.match(/\bexpress\s*(\d+)/i);
        if (label && /^express\b$/i.test(label) && routeMatch && routeMatch[1]) {
          label = `Express ${routeMatch[1]}`;
        }
        if (!label) {
          const n = (parsedNumber.match(/\d+/) || lineRaw.match(/\d+/) || routeName.match(/\d+/) || [])[0];
          label = n ? `Express ${n}` : "Express";
        }
        return label.replace(/\s+/g, " ").trim();
      }
      if (/autocar/i.test(merged)) return "Autocar";
      if (parsedNumber && !/fict/i.test(parsedNumber)) return parsedNumber;
      if (lineRaw && lineRaw !== "?" && !/fict/i.test(lineRaw)) return lineRaw;
      return "Fictive";
    }
    function getStopEntryVisual(entry){
      if (isTitusEntry(entry)) return { kind: "none" };
      const cat = getCategory(entry?.line);
      if (cat === "Scolaire") return { kind: "school" };

      let label = getStopEntryLineLabel(entry);
      if (cat === "Autres") label = getFictiveBadgeLabel(entry);
      const colorKey = (cat === "Autres")
        ? label
        : routeColorKey(entry.line, entry.route, label);
      const [bg, text] = getLineColorsSync(colorKey || label);
      const stripe = isNoctilien2(label) ? noctilienStripeColor(label) : null;
      return { kind: "badge", label, bg, text, stripe };
    }
    function getStopMergeDistancePx(){
      return Math.max(10, Math.round(getDbusStopIconSize() * DBUS_STOP_MERGE_FACTOR));
    }
    function clusterVisibleStops(stops){
      const zoom = map.getZoom();
      const mergePx = getStopMergeDistancePx();
      const clusters = [];
      stops.forEach(stop => {
        const pt = map.project(stop.latlng, zoom);
        let target = null;
        let bestDist = Number.POSITIVE_INFINITY;
        clusters.forEach(cluster => {
          const dx = pt.x - cluster.px.x;
          const dy = pt.y - cluster.px.y;
          const dist = Math.hypot(dx, dy);
          if (dist < mergePx && dist < bestDist) {
            bestDist = dist;
            target = cluster;
          }
        });
        if (!target) {
          clusters.push({
            stops: [stop],
            stopIds: [stop.id],
            sumLat: stop.latlng.lat,
            sumLng: stop.latlng.lng,
            px: { x: pt.x, y: pt.y }
          });
          return;
        }
        target.stops.push(stop);
        target.stopIds.push(stop.id);
        const n = target.stops.length;
        target.sumLat += stop.latlng.lat;
        target.sumLng += stop.latlng.lng;
        target.px.x = ((target.px.x * (n - 1)) + pt.x) / n;
        target.px.y = ((target.px.y * (n - 1)) + pt.y) / n;
      });
      return clusters.map(cluster => ({
        ...cluster,
        latlng: L.latLng(cluster.sumLat / cluster.stops.length, cluster.sumLng / cluster.stops.length)
      }));
    }
    function stopClusterTitle(cluster){
      if (!cluster?.stops?.length) return "";
      if (cluster.stops.length === 1) {
        const stop = cluster.stops[0];
        return withRERIcon(translateStopName(stripProvisoire(stop?.name || "")));
      }
      const names = [];
      const seen = new Set();
      cluster.stops.forEach(stop => {
        const raw = String(stop?.name || "").trim();
        if (!raw) return;
        const translated = translateStopName(stripProvisoire(raw)).trim();
        if (!translated) return;
        const key = translated.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        names.push(withRERIcon(translated));
      });
      if (names.length) return names.join(" / ");
      return `${formatStopCount(cluster.stops.length)} (${t("dbus_mode_stops")})`;
    }
    function stopClusterUniqueNameCount(cluster){
      if (!cluster?.stops?.length) return 0;
      const seen = new Set();
      cluster.stops.forEach(stop => {
        const raw = stripProvisoire(String(stop?.name || "")).trim();
        if (!raw) {
          seen.add(`id:${String(stop?.id ?? "")}`);
          return;
        }
        seen.add(raw.toLocaleLowerCase("fr"));
      });
      return Math.max(1, seen.size);
    }
    function openDbusStopLinesPopup(marker, cluster){
      if (!marker || !cluster) return;
      const entries = collectVisibleStopLineEntries(cluster.stopIds || []);
      if (!entries.length) {
        marker.closePopup();
        return;
      }
      const content = document.createElement("div");
      content.className = "dbus-stop-lines-popup";

      const title = document.createElement("div");
      title.className = "dbus-stop-lines-title";
      title.innerHTML = stopClusterTitle(cluster);
      content.appendChild(title);

      const badges = document.createElement("div");
      badges.className = "dbus-stop-lines-badges";
      entries.forEach(entry => {
        const activate = (opts = {}) => selectDbusLineRouteFromStopEntry(entry, opts);
        const visual = getStopEntryVisual(entry);
        if (visual.kind === "school") {
          const schoolLogo = document.createElement("img");
          schoolLogo.className = "dbus-stop-line-school-logo";
          schoolLogo.src = overlayPath("bus_school.png");
          schoolLogo.alt = "Scolaire";
          schoolLogo.style.cursor = "pointer";
          schoolLogo.addEventListener("click", (event) => {
            event.preventDefault();
            event.stopPropagation();
            activate();
          });
          badges.appendChild(schoolLogo);
          return;
        }
        if (visual.kind === "none") {
          const titusLogo = document.createElement("img");
          titusLogo.className = "dbus-stop-lines-logo";
          titusLogo.src = overlayPath("reseau_titus.png");
          titusLogo.alt = "Reseau Titus";
          titusLogo.style.cursor = "pointer";
          titusLogo.addEventListener("click", (event) => {
            event.preventDefault();
            event.stopPropagation();
            activate();
          });
          badges.appendChild(titusLogo);
          return;
        }
        if (visual.kind !== "badge") return;
        const badge = makeLineBadge(visual.label, visual.bg, visual.text, getStopBadgeSize(visual.label), visual.stripe);
        badge.classList.add("dbus-stop-line-badge");
        badge.style.cursor = "pointer";
        badge.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          const rawLabel = String(visual.label || "").trim();
          let forcedGroupUid = "";
          if (/^express\b/i.test(rawLabel)) {
            const expressPart = rawLabel.replace(/^express\b/i, "").trim() || "express";
            forcedGroupUid = `group:express:${normalizeBadgeToken(expressPart)}`;
          } else if (/^autocar\b/i.test(rawLabel)) {
            forcedGroupUid = "group:autocar";
          }
          activate({ groupUid: forcedGroupUid });
        });
        badges.appendChild(badge);
      });
      if (!badges.childNodes.length) {
        marker.closePopup();
        return;
      }
      content.appendChild(badges);

      map.closePopup();
      if (marker.getPopup()) marker.unbindPopup();
      marker.bindPopup(content, { maxWidth: 420, autoPan: false, className: "dbus-stop-lines-popup-wrap" });
      marker.openPopup();
    }
    function refreshDbusStopMarkerScale(){
      renderDbusStopsLayer();
    }
    function renderDbusStopsLayer(){
      if (!dbusStopsLayer) return;
      dbusStopsLayer.clearLayers();
      dbusStopMarkers = new Map();
      if (!DBUS_STOP_ICONS_ENABLED) return;
      dbusStopIconSizePx = getDbusStopIconSize();
      const visibleStops = [];
      DBUS_STOPS.forEach(stop => {
        if (!stop?.latlng) return;
        if (!Number.isFinite(stop.latlng.lat) || !Number.isFinite(stop.latlng.lng)) return;
        const visibleLines = getVisibleStopLineEntries(stop.id);
        if (!visibleLines.length) return;
        visibleStops.push(stop);
      });
      const clusters = clusterVisibleStops(visibleStops);
      const showClusterCount = shouldShowStopClusterCount();
      clusters.forEach(cluster => {
        const iconCount = stopClusterUniqueNameCount(cluster);
        const icon = getDbusStopIcon(dbusStopIconSizePx, iconCount, { showCount: showClusterCount });
        const marker = L.marker(cluster.latlng, {
          icon,
          interactive: true,
          keyboard: false,
          bubblingMouseEvents: false,
          riseOnHover: true
        });
        marker.on("click", (event) => {
          if (event) L.DomEvent.stopPropagation(event);
          openDbusStopLinesPopup(marker, cluster);
        });
        dbusStopsLayer.addLayer(marker);
        const key = cluster.stops.length === 1
          ? `s:${cluster.stops[0].id}`
          : `c:${cluster.stopIds.join(",")}`;
        dbusStopMarkers.set(key, marker);
      });
    }
    map.on("zoomend", refreshDbusStopMarkerScale);
    async function loadStops(){
      await tileInfoReady;
      const xml = await fetchXml(`${dbusRoot}/stops.xml`);
      const nodes = [...xml.querySelectorAll("busstops > busstop")];
      DBUS_STOPS = new Map(nodes.map(node=>{
        const id = parseInt(node.querySelector("id")?.textContent.trim()||"0",10);
        const name = (node.querySelector("name")?.textContent||"").trim();
        const locRaw = (node.querySelector("location")?.textContent||"").trim();
        const parts = locRaw.split(";").map(x=>parseFloat(x));

        const X = parts[0] ?? 0;
        const Y = parts[1] ?? 0;
        const Z = parts[2] ?? 0;
        const rotX = parts[3] ?? 0;
        const rotY = parts[4] ?? 0;

        const latlng = toLatLng(X, Z);
        return [id, {id, name, X, Y, Z, rotX, rotY, latlng}];
      }));
    }

    let DBUS_LINES = [];
    async function loadLines(){
      const xml = await fetchXml(`${dbusRoot}/lines.xml`);
      const seenLineUids = new Map();
      DBUS_LINES = [...xml.querySelectorAll("lines > line")].map((line, lineIndex) => {
        const rawUid = String(line.getAttribute("uid") || "").trim();
        const number  = line.getAttribute("number") || "?";
        const uidBase = rawUid || `line_${lineIndex}`;
        const seenCount = (seenLineUids.get(uidBase) || 0) + 1;
        seenLineUids.set(uidBase, seenCount);
        const safeNumber = String(number || "")
          .toLowerCase()
          .replace(/[^a-z0-9_-]+/g, "_")
          .replace(/^_+|_+$/g, "") || "line";
        // lines.xml can contain duplicated line uid values (e.g. 210/221), so build a collision-safe uid.
        const lineUid = seenCount === 1 ? uidBase : `${uidBase}__${safeNumber}__${lineIndex}`;

        const routes = [...line.querySelectorAll(":scope > route")].map(rt=>{
          const rUid  = rt.getAttribute("uid");
          const rName = rt.getAttribute("name") || "";
          const stops = [...rt.querySelectorAll(":scope > busstop")].map(b => {
            return {
              uid: parseInt(b.getAttribute("uid"), 10),
              nextStopTime: parseInt(b.getAttribute("nextStopTime") || "0", 10)
            };
          });

          const totalMinutes = stops.reduce((sum, s) => sum + (s.nextStopTime || 0), 0);

          return { uid: rUid, name: rName, stops, totalMinutes };
        });

        return { uid: lineUid, uidRaw: rawUid, number, routes };
      });
    }


    const BUS_COLORS = [getComputedStyle(document.documentElement).getPropertyValue('--busA').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busB').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busC').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busD').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busE').trim()];
    function colorFor(index){ return BUS_COLORS[index % BUS_COLORS.length] || "#3aa0ff"; }

    async function getTwoDominantColors(src){
      return new Promise(resolve => {
        const img = new Image(); img.crossOrigin = "anonymous"; img.src = src;
        img.onload = () => {
          const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
          canvas.width  = img.naturalWidth; canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          const counts = {}; let whiteCount = 0; let blackCount = 0;
          const STEP = 16, WHITE_LUM = 0.92, BLACK_LUM = 0.08;
          for (let i = 0; i < data.length; i += 4*STEP) {
            const a = data[i+3]; if (a < 128) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
            if (lum > WHITE_LUM) { whiteCount++; continue; }
            if (lum < BLACK_LUM) { blackCount++; continue; }
            const rq = r >> 4, gq = g >> 4, bq = b >> 4;
            const key = `${rq},${gq},${bq}`; counts[key] = (counts[key] || 0) + 1;
          }
          const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
          let bg = "#444"; if (entries.length) { const [rq,gq,bq] = entries[0][0].split(",").map(v => (parseInt(v,10) << 4) + 8); bg = `rgb(${rq},${gq},${bq})`; }
          const text = (whiteCount >= blackCount) ? "#fff" : "#000";
          resolve([bg, text]);
        };
        img.onerror = () => resolve(["#444","#fff"]);
      });
    }

    function isNoctilien2(input){
      const num = typeof input === 'string' ? input : input?.number;
      return /^N\d+$/.test(String(num || "").trim().toUpperCase());
    }

    function getLineStyleEntry(number){
      const n = String(number || "").trim();
      if (!n) return null;
      const STYLE_LC = getLineStyleEntry.STYLE_LC || (
        getLineStyleEntry.STYLE_LC = Object.fromEntries(
          Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
        )
      );
      return STYLE_LC[n.toLowerCase()] || null;
    }

    function getLineLink(line, route){
      const candidates = [];
      try {
        const { lineNumber } = parseRouteName(route?.name || "");
        if (lineNumber) candidates.push(lineNumber);
      } catch {}
      if (line?.number) candidates.push(line.number);
      try {
        const cat = getCategory(line);
        if (cat) candidates.push(cat);
        if (cat === "FlixBus") candidates.push("FLIXBUS");
      } catch {}

      const seen = new Set();
      for (const cand of candidates){
        const key = String(cand || "").trim();
        if (!key) continue;
        const lc = key.toLowerCase();
        if (seen.has(lc)) continue;
        seen.add(lc);
        const entry = getLineStyleEntry(key);
        if (entry) {
          const url = (typeof entry[2] === "string") ? entry[2].trim() : "";
          if (url) return url;
        }
      }
      return "";
    }

    const LINE_COLOR_CACHE = new Map();
    function getLineColors(number){
      const n = String(number || "").trim();
      if (isNoctilien2(n)) return Promise.resolve(["#080080", "#FFFFFF"]);

      const STYLE_LC = getLineColors.STYLE_LC || (
        getLineColors.STYLE_LC = Object.fromEntries(
          Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
        )
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return Promise.resolve(hit);

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";
      const text = (() => {
        const m = /^#?([0-9a-f]{6})$/i.exec(bg); if(!m) return "#fff";
        const x = parseInt(m[1],16);
        const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
        const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
        return L > 0.6 ? "#000" : "#fff";
      })();
      return Promise.resolve([bg, text]);
    }


    function noctilienStripeColor(number){
      const DEFAULT = "#080080";
      const n = String(number||"").trim();
      if (LINE_STYLES[n] && LINE_STYLES[n][0]) return LINE_STYLES[n][0];
      return DEFAULT;
    }

    function ensureStripe(badgeEl, color){
      badgeEl.style.position = "relative";
      const old = badgeEl.querySelector(".noctilien-stripe");
      if (old) old.remove();
      badgeEl.classList.add("has-noctilien-stripe");
      const stripe = document.createElement("div");
      stripe.className = "noctilien-stripe";
      stripe.style.position = "absolute";
      stripe.style.left = "0";
      stripe.style.right = "0";
      stripe.style.bottom = "0";
      stripe.style.height = "6px";
      stripe.style.borderBottomLeftRadius = "8px";
      stripe.style.borderBottomRightRadius = "8px";
      stripe.style.background = color;
      badgeEl.appendChild(stripe);
    }

    function parseRouteName(name){
      const raw = String(name || "").trim();

      const hasColon = raw.includes(":");
      const parts = hasColon ? raw.split(":") : [raw];

      let flag = null;
      const flagMatch = parts[0].match(/\(([^)]+)\)/);
      if (flagMatch) flag = flagMatch[1].trim();
      if (flag && /^fict/i.test(flag)) flag = null;

      let lineNumber = parts[0]
        .replace(/\s*\([^)]*\)/g, "")
        .trim();

      let routeTitle;
      if (hasColon) {
        routeTitle = raw.substring(raw.indexOf(":") + 1).trim();
      } else {
        routeTitle = raw;
      }

      return { lineNumber, routeTitle, flag };
    }

    function ensureFictiveStripe(badgeEl) {
      return badgeEl;
    }

    function ensureBadgeLabel(badgeEl, text){
      if (!badgeEl) return null;
      let label = badgeEl.querySelector(".badge-label");
      if (!label){
        label = document.createElement("span");
        label.className = "badge-label";
        badgeEl.appendChild(label);
      }
      if (typeof text === "string") {
        label.textContent = text;
      }
      return label;
    }

    function computeBadgeFontSize(labelText, widthPx, heightPx){
      const txt = String(labelText || "").trim();
      const chars = Math.max(txt.length, 1);
      const safeW = Math.max(Number(widthPx) || 0, 24);
      const safeH = Math.max(Number(heightPx) || 0, 16);
      const byHeight = Math.floor(safeH * 0.62);
      const byWidth = Math.floor((safeW - 10) / (chars * 0.62));
      return Math.max(8, Math.min(byHeight, byWidth));
    }

    function makeLineBadge(number, bg="#444", text="#fff", size="72x32", stripeColor=null, isFictive=false) {
      const [w,h] = size.split("x").map(v=>parseInt(v,10));
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.style.width = w+"px"; 
      badge.style.height = h+"px";
      badge.style.boxSizing = "border-box";
      badge.style.borderRadius = "8px";
      badge.style.display = "flex";
      badge.style.alignItems = "center";
      badge.style.justifyContent = "center";
      badge.style.flex = "0 0 auto";
      badge.style.overflow = "hidden";
      badge.style.fontWeight = "800";
      badge.style.fontVariantNumeric = "tabular-nums";
      badge.style.background = bg; 
      badge.style.color = text;
      badge.style.textShadow = "0 1px 2px rgba(0,0,0,.35)";
      badge.style.position = "relative";
      const rawLabel = String(number || "").trim();
      badge.dataset.badgeRaw = rawLabel;
      const labelText = translateBadgeToken(rawLabel);
      const labelSpan = ensureBadgeLabel(badge, labelText);
      labelSpan.style.fontSize = computeBadgeFontSize(labelText, w, h) + "px";

      if (stripeColor) ensureStripe(badge, stripeColor);
      if (isFictive) ensureFictiveStripe(badge);
      return badge;
    }

    function createNetworkBadgeElement({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const wrap = document.createElement("div");
      wrap.className = "network-badge";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = alt;
      if (invertLogo) img.classList.add("network-logo-invert");
      wrap.appendChild(img);

      const [bg, text] = getLineColorsSync(colorKey || label);
      const chip = document.createElement("div");
      chip.className = chipClass;
      chip.dataset.chipRole = "line";
      chip.dataset.networkBadge = "true";
      ensureBadgeLabel(chip, String(label ?? ""));
      chip.style.background = bg;
      chip.style.color = text;
      wrap.appendChild(chip);

      if (stripeColor) ensureStripe(chip, stripeColor);

      return { wrap, chip };
    }

    function networkBadgeHTML({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const [bg, text] = getLineColorsSync(colorKey || label);
      const stripe = stripeColor ? `<div class="noctilien-stripe" style="background:${stripeColor}"></div>` : "";
      return `
        <div class="network-badge">
          <img src="${imgSrc}" alt="${escapeHTML(alt)}" ${invertLogo ? 'class="network-logo-invert"' : ''}/>
          <div class="${chipClass}" data-chip-role="line" data-network-badge="true" style="background:${bg};color:${text};">
            ${escapeHTML(label)}
            ${stripe}
          </div>
        </div>
      `;
    }

    function trimByDash(s, mode){
      const txt = String(s || "").trim();
      const parts = txt.split(/\s*[---]\s*/).filter(Boolean);
      if (parts.length < 2) return txt;
      return (mode === 'start') ? parts[0].trim() : parts[parts.length - 1].trim();
    }

    function cleanRERLabel(label){
      return String(label ?? "").replace(/\s*[---]\s*RER\b/gi, " RER");
    }

    function withRERIconInStop(text){
      const esc = escapeHTML(text ?? "");
      return esc.replace(/\s*[---]?\s*RER\s*[---]?\s*/gi,
        ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(/\s*[---]?\s*M[ée]tro\s*[---]?\s*/gi,
        ' <span class="metro-ico" aria-label="Métro"></span> ');
    }

    const PROV_RE = /\bprovisoire\b/i;
    function hasProvisoire(text){
      return PROV_RE.test(String(text || ""));
    }
    function stripProvisoire(text){
      return String(text || "")
        .replace(/\s*\(\s*provisoire\s*\)\s*/i, " ")
        .replace(/\s*-\s*provisoire\b/i, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
    function getRouteTerminusLabel(route, titleEndFallback = ""){
      const stops = route?.stops || [];
      const lastStopId = stops.length ? stops[stops.length - 1].uid : undefined;
      const lastStop = (typeof lastStopId !== "undefined") ? DBUS_STOPS.get(lastStopId) : null;
      const rawStopName = lastStop?.name || "";
      const rawFallback = String(titleEndFallback || "").trim();
      const raw = rawStopName || rawFallback;
      if (!raw) return "";
      const isProvisoire = hasProvisoire(rawStopName) || hasProvisoire(rawFallback);
      const clean = stripProvisoire(raw);
      const translated = translateStopName(clean);
      return isProvisoire ? `${translated} (${t("temporary_stop")})` : translated;
    }

    function splitRouteEndpoints(routeTitle){
      const s = decodeHTML(String(routeTitle || "").trim());
      const parts = s.split(/\s*(?:>|→|↔|⇄|<->|->|\bvers\b|\bto\b)\s*/i).filter(Boolean);
      if (parts.length >= 2){ return [parts[0].trim(), parts[parts.length-1].trim()]; }
      return [s, s];
    }

    function translateRouteTitle(routeTitle){
      const raw = String(routeTitle || "").trim();
      if (!raw || !TRANSLATE_STOP_TYPES || LANG === "fr") return raw;
      const [start0, end0] = splitRouteEndpoints(raw);
      if (!start0 || !end0 || start0 === end0) return translateStopName(raw);
      const start = translateStopName(start0);
      const end = translateStopName(end0);
      return `${start} > ${end}`;
    }

    function getLineColorsSync(number){
      const n = String(number || "").trim();

      if (isNoctilien2(n)) return ["#080080", "#FFFFFF"];

      const STYLE_LC = Object.fromEntries(
        Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return hit;

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";

      const m = /^#?([0-9a-f]{6})$/i.exec(bg);
      if (!m) return [bg, "#fff"];
      const x = parseInt(m[1],16);
      const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
      const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      const text = L > 0.6 ? "#000" : "#fff";

      return [bg, text];
    }


    function drawRoute(lineIdx, line, route){
      const key = `${line.uid}:${route.uid}`;
      if(dbusRouteLayers.has(key)) return dbusRouteLayers.get(key);

      const group = L.layerGroup().addTo(dbusLayers);
      const poly  = L.polyline([], {
        color: colorFor(lineIdx),
        weight: 8,
        opacity: 1,
        interactive: false,
        pane: "dbusRoutePane"
      }).addTo(group);

      const latlngs = route.stops.map(s => DBUS_STOPS.get(s.uid)?.latlng).filter(Boolean);

      if (latlngs.length >= 2){
        poly.setLatLngs(latlngs);
        startLineAnim(key, poly);
      }

      const effNum = getLineNumber(line, route);
      getLineColors(effNum).then(([bg])=>{ if(bg) poly.setStyle({color:bg}); });

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const { titleStart, titleEnd } = getRouteEndpoints(route);

      const lineCategory = getCategory(line);
      const stops = route.stops.map((s, idx, arr)=> {
        const id = s.uid;
        const st = DBUS_STOPS.get(id);
        const isFirst = (idx===0), isLast=(idx===arr.length-1);
        const n = String(line.number||"").trim();

        if (!st) return null;
        const rawStopName = st.name || "";
        let displayName = rawStopName;

        if (isFirst) displayName = titleStart;
        if (isLast)  displayName = titleEnd;

        const isProvisoireStop = hasProvisoire(rawStopName) || hasProvisoire(displayName);
        const cleanDisplayName = stripProvisoire(displayName);
        const translatedDisplayName = translateStopName(cleanDisplayName);
        const stopNameHTML = withRERIconInStop(translatedDisplayName);
        const coordParts = [st.X, st.Y, st.Z].map(v => Number(v).toFixed(2));
        const coordsDisplay = escapeHTML(coordParts.join(", "));
        const gotoCmd = `goto ${st.X.toFixed(2)};${st.Y.toFixed(2)};${st.Z.toFixed(2)};${st.rotX.toFixed(6)};${st.rotY.toFixed(6)}`;

        const { lineNumber } = parseRouteName(route.name || "");
        let cleanNum = String(lineNumber || "").trim();
        cleanNum = cleanNum.replace(/\s*\([^)]*\)/, "").trim();

        const [bg, text] = getLineColorsSync(cleanNum);
        getLineColors(cleanNum).then(([bg])=>{
          if(bg) poly.setStyle({color:bg});
        });
        
        const stopOrderLabel = `${idx+1} / ${arr.length}`;
        const temporaryStopLabel = escapeHTML(t("temporary_stop"));
        const coordinatesLabel = escapeHTML(t("coordinates"));
        const html = `
          <div class="stop-popup">
            <div class="sp-header">
              <div class="sp-title">${stopNameHTML}${isProvisoireStop ? ` <span class="stop-flag" aria-label="${temporaryStopLabel}">${temporaryStopLabel}</span>` : ''}</div>
              <div class="sp-index">${stopOrderLabel}</div>
            </div>
            <div class="sp-body">
              <div class="sp-coords">
                <span>${coordinatesLabel}</span>
                <div class="sp-coords-code">${coordsDisplay}</div>
              </div>
            </div>
          </div>`;

        const marker = L.marker(st.latlng, {
          pane: "dbusRouteMarkerPane",
          interactive: false,
          keyboard: false,
          bubblingMouseEvents: false,
          icon: L.divIcon({
            className: "stop-number",
            html: `<div style="
              width:${isFirst || isLast ? 26 : 22}px;
              height:${isFirst || isLast ? 26 : 22}px;
              border-radius:50%;
              background:#fff;
              border:2px solid #000;
              display:flex;
              align-items:center;
              justify-content:center;
              font-size:12px;
              font-weight:700;
              color:#000;
            ">${idx+1}</div>`,
            iconSize: [isFirst || isLast ? 26 : 22, isFirst || isLast ? 26 : 22],
            iconAnchor: [(isFirst || isLast ? 26 : 22)/2, (isFirst || isLast ? 26 : 22)/2]
          })
        }).addTo(group).bindPopup(
          L.popup({ maxWidth: 420, autoPan: true }).setContent(html)
        );

        marker._routeKey = key;
        marker._stopId = id;

        marker.on('popupopen', (e) => {
          setActiveStopById(id);
          if (marker._routeKey !== currentSelectedKey) {
            e.popup.remove();
            return;
          }
          const el = e.popup.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          const { cleanNum } = parseRouteName(route.name || "")
           getLineColors(cleanNum).then(([bg, text]) => {
              const pop = marker.getPopup();
              if (!pop) return;
              const el = pop.getElement();
              if (!el) return;
              const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
              if (!chip) return;
              const isNetworkChip = chip.dataset?.networkBadge === "true";

              if (isNetworkChip) return;

              if (isNoctilien2(n)) {
                chip.style.background = "#080080";
                chip.style.color = text;
                if (!el.querySelector('.noctilien-stripe')) {
                  ensureStripe(chip, noctilienStripeColor(n));
                }
              } else {
                chip.style.background = bg;
                chip.style.color = text;
              }
            });

        });

        marker.on('popupclose', ()=>{
          if (currentActiveStopId === id) clearActiveStop();
        });

        getLineColors(cleanNum).then(([bg, text]) => {
          const pop = marker.getPopup();
          if (!pop) return;
          const el = pop.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          if (isNoctilien2(n)) {
            chip.style.background = "#080080";
            chip.style.color = text;
            ensureStripe(chip, noctilienStripeColor(n));
          } else {
            chip.style.background = bg;
            chip.style.color = text;
          }
        });


        return marker;
      }).filter(Boolean);

      const bundle = { group, poly, stops };
      dbusRouteLayers.set(key, bundle);
      return bundle;
    }

    function hideAllRoutes(){
      dbusLayers.clearLayers();
      routeAnimHandles.forEach(h => h.stop());
      routeAnimHandles.clear();
      hideLinePreview();
      clearActiveStop()
    }
    function forceRouteBundlePassive(bundle){
      if (!bundle) return;
      try {
        if (bundle.poly && typeof bundle.poly.setStyle === "function") {
          bundle.poly.setStyle({ interactive: false, pane: "dbusRoutePane" });
        }
        const polyEl = bundle.poly?._path;
        if (polyEl) polyEl.style.pointerEvents = "none";
      } catch {}
      (bundle.stops || []).forEach(marker => {
        if (!marker) return;
        try {
          marker.options.interactive = false;
          marker.options.keyboard = false;
          marker.options.bubblingMouseEvents = false;
          marker.options.pane = "dbusRouteMarkerPane";
        } catch {}
        try {
          const el = marker.getElement?.();
          if (el) el.style.pointerEvents = "none";
        } catch {}
      });
    }

    function showOnlyRoute(lineIdx, line, route){
      hideAllRoutes();
      const key = `${line.uid}:${route.uid}`;
      const existing = dbusRouteLayers.get(key);
      let bundle;

      if (existing) {
        dbusLayers.addLayer(existing.group);
        bundle = existing;
        if (existing.poly?._path) startLineAnim(key, existing.poly);
        else existing.poly.once('add', () => startLineAnim(key, existing.poly));
      } else {
        bundle = drawRoute(lineIdx, line, route);
      }
      forceRouteBundlePassive(bundle);
      requestAnimationFrame(() => forceRouteBundlePassive(bundle));

      if (CENTER_ON_LINE_SELECT && route.stops && route.stops.length){
        const first = DBUS_STOPS.get(route.stops[0].uid);
        const marker = bundle.stops[0];
        centerMarkerWithPreview(marker, first?.latlng, { zoom: map.getZoom(), openPopup: true });
      }

      renderLinePreview(line, route);
      bringPoiOverlaysToFront();

      return bundle;
    }

    function getRouteEndpoints(route){
      const routeTitleRaw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const rawStart = trimAroundRER(titleStart0, 'start');
      const rawEnd   = trimAroundRER(titleEnd0,   'end');
      const titleStart = translateStopName(rawStart);
      const titleEnd   = translateStopName(rawEnd);
      return { routeTitleRaw, titleStart, titleEnd, rawStart, rawEnd };
    }

    let PREVIEW_STOP_ELEMS = new Map();

    function setActiveStopById(stopId){
      if (!isLinePreviewHorizontal()) {
        PREVIEW_STOP_ELEMS.forEach(({el, routeKey}) => {
          if (routeKey === currentSelectedKey) el.classList.remove('active');
        });
        currentActiveStopId = stopId;
        return;
      }
      PREVIEW_STOP_ELEMS.forEach(({el, routeKey}) => {
        if (routeKey === currentSelectedKey) el.classList.remove('active');
      });
      const rec = PREVIEW_STOP_ELEMS.get(stopId);
      if (rec && rec.routeKey === currentSelectedKey) {
        rec.el.classList.add('active');
        currentActiveStopId = stopId;
      }
    }

    function centerWithPreview(latlng, { zoom = null } = {}) {
      const targetZoom = zoom ?? map.getZoom();
      const paneH = document.getElementById('linePreview')?.offsetHeight || 0;
      const offsetY = Math.round(paneH / 2);
      const p = map.project(latlng, targetZoom);
      const targetPt = L.point(p.x, p.y + offsetY);
      const targetLL = map.unproject(targetPt, targetZoom);
      map.setView(targetLL, targetZoom, { animate: UI_ANIMATIONS });
    }
    function centerWithPreviewAndThen(latlng, { zoom = null, onDone = null, timeoutMs = null } = {}) {
      if (!latlng) {
        if (typeof onDone === "function") onDone();
        return;
      }
      let done = false;
      const finish = () => {
        if (done) return;
        done = true;
        map.off("moveend", onMoveEnd);
        if (typeof onDone === "function") {
          try { onDone(); } catch {}
        }
      };
      const onMoveEnd = () => finish();
      map.once("moveend", onMoveEnd);
      centerWithPreview(latlng, { zoom });
      const wait = Number.isFinite(timeoutMs) ? timeoutMs : Math.max(140, menuAnimDurationMs() + 80);
      setTimeout(finish, wait);
    }
    function centerMarkerWithPreview(marker, latlng, { zoom = null, openPopup = true } = {}) {
      if (!latlng) {
        if (openPopup && marker?.openPopup) marker.openPopup();
        return;
      }
      const popup = marker?.getPopup?.();
      const hadPopup = !!popup;
      const prevAutoPan = hadPopup ? popup.options.autoPan : null;
      if (hadPopup) popup.options.autoPan = false;
      centerWithPreviewAndThen(latlng, {
        zoom,
        onDone: () => {
          if (openPopup && marker?.openPopup) marker.openPopup();
          if (hadPopup) popup.options.autoPan = prevAutoPan;
        }
      });
    }

    function getLineNumber(line, route) {
      if (line.number && line.number !== "?") {
        return line.number;
      }
      const { lineNumber } = parseRouteName(route.name || "");
      return lineNumber || "?";
    }

    function refreshLinePreviewRail(){
      const transit = document.getElementById("lpTransit");
      if (!transit) return;
      const rail = transit.querySelector(".transit-main-line");
      if (!rail) return;
      const stops = [...transit.querySelectorAll(".stop")];
      if (stops.length < 2) {
        rail.style.width = "0px";
        rail.style.height = "0px";
        return;
      }
      const firstStop = stops[0];
      const lastStop = stops[stops.length - 1];
      const firstDot = firstStop.querySelector(".dot");
      const lastDot = lastStop.querySelector(".dot");
      if (!firstDot || !lastDot) return;

      const transitRect = transit.getBoundingClientRect();
      const firstRect = firstDot.getBoundingClientRect();
      const firstX = (firstRect.left - transitRect.left) + (firstRect.width / 2);
      const firstY = (firstRect.top - transitRect.top) + (firstRect.height / 2);
      const trimEndPx = 1;
      if (isLinePreviewHorizontal()) {
        const lastRect = lastDot.getBoundingClientRect();
        const lastX = (lastRect.left - transitRect.left) + (lastRect.width / 2);
        const railHeight = Math.max(1, rail.offsetHeight || 4);
        const goesRight = lastX >= firstX;
        const left = goesRight ? firstX : (lastX + trimEndPx);
        const width = Math.max(0, Math.abs(lastX - firstX) - trimEndPx);
        const top = firstY - (railHeight / 2);
        rail.style.left = `${left}px`;
        rail.style.top = `${top}px`;
        rail.style.width = `${width}px`;
        rail.style.height = `${railHeight}px`;
        return;
      }
      const lastRect = lastDot.getBoundingClientRect();
      const lastY = (lastRect.top - transitRect.top) + (lastRect.height / 2);
      const railWidth = Math.max(1, rail.offsetWidth || 4);
      const goesDown = lastY >= firstY;
      const top = goesDown ? firstY : (lastY + trimEndPx);
      const height = Math.max(0, Math.abs(lastY - firstY) - trimEndPx);
      const left = firstX - (railWidth / 2);
      rail.style.left = `${left}px`;
      rail.style.top = `${top}px`;
      rail.style.width = `${railWidth}px`;
      rail.style.height = `${height}px`;
    }

    function renderLinePreview(line, route){
      PREVIEW_STOP_ELEMS = new Map();

      const wrap = document.getElementById("linePreviewWrap");
      const badge = document.getElementById("lpBadge");
      const title = document.getElementById("lpRouteTitle");
      const meta = document.getElementById("lpRouteMeta");
      const transit = document.getElementById("lpTransit");
      if(!wrap || !badge || !title || !transit || !meta) return;

      const { titleStart, titleEnd, rawStart, rawEnd } = getRouteEndpoints(route);
      const cleanedStart = withRERIcon(titleStart);
      const cleanedEnd   = withRERIcon(titleEnd);
      const { lineNumber } = parseRouteName(route.name || "");
      const lineCategory = getCategory(line);

      const stopCount = route.stops.length;

      let durationText;
      if (route.totalMinutes >= 60) {
        const h = Math.floor(route.totalMinutes / 60);
        const m = route.totalMinutes % 60;
          if (m > 0) {
            durationText = `${h} h ${m} ${minuteShortLabel()}`;
          } else {
            durationText = `${h} h`;
          }
        } else {
          durationText = `${route.totalMinutes} ${minuteShortLabel()}`;
        }
      
      title.innerHTML = `${cleanedStart} &gt; ${cleanedEnd}`;
      title.dataset.rawStart = rawStart || "";
      title.dataset.rawEnd = rawEnd || "";
      setStopDurationText(meta, stopCount, durationText, "dash");
      const isExpressLinePreview = isExpress(line) || isExpressNumber(lineNumber) || isFlix(line) || lineCategory === "FlixBus" || isAutocar(line) || isFictive(line);
      const linePreviewChipClass = isExpressLinePreview
        ? "dbus-badge network-chip network-chip-express"
        : "dbus-badge network-chip";
      const mTitusLP = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const isNoctLinePreview = isNoctilien2(lineNumber);
      let previewBadgeChip = null;

      const lpLink = document.getElementById("lpLink");
      if (lpLink){
        const url = getLineLink(line, route);
        const hasUrl = !!url;
        if (hasUrl) {
          lpLink.href = url;
          lpLink.hidden = false;
          lpLink.style.display = "";
        } else {
          lpLink.removeAttribute("href");
          lpLink.hidden = true;
          lpLink.style.display = "none";
        }
      }

      function applyNetworkBadgeToPreview(opts){
        badge.innerHTML = "";
        badge.className = "lp-badge-wrapper";
        badge.style.background = "transparent";
        badge.style.color = "#fff";
        delete badge.dataset.networkBadge;
        delete badge.dataset.badgeRaw;
        const { wrap, chip } = createNetworkBadgeElement(opts);
        badge.appendChild(wrap);
        previewBadgeChip = chip;
      }

      function applyDefaultBadgeToPreview(extraClass = ""){
        const safeExtra = String(extraClass || "").trim();
        badge.className = `dbus-badge${safeExtra ? ` ${safeExtra}` : ""}`;
        badge.innerHTML = "";
        delete badge.dataset.networkBadge;
        badge.dataset.badgeRaw = String(lineNumber || "").trim();
        ensureBadgeLabel(badge, translateBadgeToken(lineNumber));
        badge.style.background = "#444";
        badge.style.color = "#fff";
        previewBadgeChip = badge;
      }

      function applySchoolBadgeToPreview(){
        badge.innerHTML = "";
        badge.className = "lp-badge-wrapper";
        badge.style.background = "transparent";
        badge.style.color = "#fff";
        badge.dataset.networkBadge = "true";
        delete badge.dataset.badgeRaw;
        const wrap = document.createElement("div");
        wrap.className = "network-badge";
        const school = document.createElement("img");
        school.src = overlayPath("bus_school.png");
        school.alt = t("dbus_school_toggle");
        wrap.appendChild(school);
        badge.appendChild(wrap);
        previewBadgeChip = badge;
      }

      if (mTitusLP) {
        applyNetworkBadgeToPreview({
          label: mTitusLP[1],
          imgSrc: overlayPath("reseau_titus.png"),
          alt: "Reseau Titus",
          colorKey: lineNumber,
          chipClass: "dbus-badge titus-chip"
        });
      } else if (isNoctLinePreview) {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: overlayPath("noctilien_logo_idfm.png"),
          alt: "Noctilien",
          stripeColor: noctilienStripeColor(lineNumber)
        });
      } else if (lineCategory === "Scolaire") {
        applySchoolBadgeToPreview();
      } else if (lineCategory === "FlixBus") {
        applyDefaultBadgeToPreview("network-chip network-chip-express");
      } else if (lineCategory === "Urbain") {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: overlayPath("bus_logo_idfm.png"),
          alt: "Reseau urbain Ile-de-France Mobilites",
          chipClass: linePreviewChipClass
        });
      } else if (lineCategory === "Autres") {
        const previewChipClassOnly = linePreviewChipClass.replace(/\bdbus-badge\b/g, "").trim();
        applyDefaultBadgeToPreview(previewChipClassOnly);
      } else {
        applyDefaultBadgeToPreview();
      }

      if (transit) transit.style.setProperty('--lineColor', '#8a8a8a');
      if (linePreviewStopsBox) linePreviewStopsBox.style.setProperty('--lineColor', '#8a8a8a');

      const previewBadgeTarget = previewBadgeChip || badge;
      const isPreviewNetwork = previewBadgeTarget?.dataset?.networkBadge === "true";
      if (!isPreviewNetwork && isNoctilien2(line.number)) {
        ensureStripe(previewBadgeTarget, noctilienStripeColor(line.number));
      }

      const colorKeyLP = lineNumber || getLineNumber(line, route);
      getLineColors(colorKeyLP).then(([bg, text])=>{
        if (previewBadgeTarget && !isPreviewNetwork){
          previewBadgeTarget.style.background = bg;
          previewBadgeTarget.style.color = text;
        }
        if (transit) transit.style.setProperty('--lineColor', bg);
        if (linePreviewStopsBox) linePreviewStopsBox.style.setProperty('--lineColor', bg);
        if (!isPreviewNetwork && isNoctilien2(colorKeyLP)) {
          ensureStripe(previewBadgeTarget, noctilienStripeColor(colorKeyLP));
        }
      });

      transit.innerHTML = "";
      if (transitScroll) transitScroll.scrollTop = 0;
      const rail = document.createElement("div");
      rail.className = "transit-main-line";
      transit.appendChild(rail);
      const temporaryStopLabel = escapeHTML(t("temporary_stop"));
      const ids = route.stops.map(s => s.uid);
      ids.forEach((id, idx) => {
        const st = DBUS_STOPS.get(id); if(!st) return;
        const rawStopName = st.name || "";
        let label = rawStopName;
        if (idx === 0) label = titleStart;
        else if (idx === ids.length-1) label = titleEnd;

        const stopEl = document.createElement("div");
        stopEl.className = "stop" + (idx===0 ? " first" : (idx===ids.length-1 ? " last" : ""));
        stopEl.dataset.stopId = String(id);
        const isProvisoire = hasProvisoire(rawStopName) || hasProvisoire(label);
        const cleanLabel = stripProvisoire(label);
        const translatedLabel = translateStopName(cleanLabel);
        stopEl.dataset.rawLabel = cleanLabel;
        stopEl.dataset.provisoire = isProvisoire ? "1" : "0";
        stopEl.innerHTML = `
          <div class="dot"></div>
          <div class="name">${withRERIcon(translatedLabel)}${isProvisoire ? ` <span class="stop-flag" aria-label="${temporaryStopLabel}">${temporaryStopLabel}</span>` : ''}</div>
        `;
        
        stopEl.addEventListener('click', ()=>{
          const bundle = dbusRouteLayers.get(currentSelectedKey);
          const mk  = bundle?.stops?.[idx];
          const stObj = DBUS_STOPS.get(id);
          centerMarkerWithPreview(mk, stObj?.latlng, { zoom: map.getZoom(), openPopup: true });
          setActiveStopById(id);
        });
        PREVIEW_STOP_ELEMS.set(id, { el: stopEl, idx, routeKey: currentSelectedKey });

        transit.appendChild(stopEl);
      });
      const firstId = route.stops[0]?.uid;
      if (typeof firstId !== 'undefined') setActiveStopById(firstId);

      if (typeof closeSearchUI === "function" && typeof isSearchOpen === "function" && isSearchOpen()) {
        closeSearchUI({ reset: true });
      }
      clearPanelCloseTimer(wrap);
      wrap.style.display = "block";
      wrap.classList.add("is-open");
      wrap.classList.remove("is-closing");
      refreshLinePreviewRail();
      requestAnimationFrame(() => {
        refreshLinePreviewRail();
        updateLinePreviewScrollCues();
      });
      updateUiOverlays();
      applyI18N();
    }

    function restoreLinePreview(key){
      const routeKey = key || currentSelectedKey;
      if (!routeKey) return;
      const [lineUid, routeUid] = routeKey.split(":");
      const line = (DBUS_LINES || []).find(l => String(l.uid) === String(lineUid));
      const route = line?.routes?.find(r => String(r.uid) === String(routeUid));
      if (line && route) renderLinePreview(line, route);
    }
    window.restoreLinePreview = restoreLinePreview;

    function hideLinePreview(){
      const wrap = document.getElementById("linePreviewWrap");
      if (wrap) {
        wrap.classList.remove("is-open");
        clearPanelCloseTimer(wrap);
        if (UI_ANIMATIONS) {
          wrap.classList.add("is-closing");
          const timer = setTimeout(() => {
            if (PANEL_CLOSE_TIMERS.get(wrap) !== timer) return;
            PANEL_CLOSE_TIMERS.delete(wrap);
            wrap.classList.remove("is-closing");
            wrap.style.display = "none";
            updateUiOverlays();
          }, previewAnimDurationMs());
          PANEL_CLOSE_TIMERS.set(wrap, timer);
        } else {
          wrap.classList.remove("is-closing");
          wrap.style.display = "none";
        }
      }
      if (linePreviewStopsBox) {
        linePreviewStopsBox.classList.remove("can-scroll-up", "can-scroll-down");
      }
      clearActiveStop()
      updateUiOverlays();
    }

    document.getElementById("lpClose")?.addEventListener("click", () => {
      currentSelectedKey = "";
      hideAllRoutes();
      document.getElementById("dbusPanel")?.querySelectorAll(".dbus-item")?.forEach(it => {
        it.classList.remove("active");
        it.style.outline = "none";
      });
      renderSelectedChip();
      updateDbusModeUI();
    });

    function openSettingsPanel() {
      closeSearchUI({ reset: true });
      closeDbusPanel();
      resetDbusSelection();
      closeLangMenu();
      if (!$panelSettings) return;
      openPanel($panelSettings, { display: "flex", ariaHidden: false });
      $btnSettings?.setAttribute("aria-expanded", "true");
      updateUiOverlays();
    }
    function closeSettingsPanel() {
      if (!$panelSettings) return;
      closePanel($panelSettings, { durationMs: menuAnimDurationMs(), ariaHidden: true });
      $btnSettings?.setAttribute("aria-expanded", "false");
      updateUiOverlays();
    }
    function isSettingsOpen() {
      return !!$panelSettings && getComputedStyle($panelSettings).display !== "none" && !$panelSettings.classList.contains("is-closing");
    }

    function isDbusDisplayModeForced(){
      return dbusDisplayMode === "dbus";
    }
    function applyDbusDisplayMode(forceRender = false){
      if (isDbusDisplayModeForced()) {
        dbusDepartPreviewActive = true;
        if (currentDbusMode === DBUS_MODES.DEPARTS) currentDbusMode = DBUS_MODES.LINES;
        updateDbusModeUI();
        if (forceRender || !dbusDepartGroups.length) refreshDbusDepartures(true);
        else showDbusDepartures();
      } else {
        if (currentDbusMode === DBUS_MODES.DEPARTS) currentDbusMode = DBUS_MODES.LINES;
        dbusDepartPreviewActive = false;
        hideDbusDepartures();
        closeDbusStopPanel();
        updateDbusModeUI();
        if (typeof renderDbusLinesList === "function") renderDbusLinesList(currentDbusMode);
      }
      updateDbusDepartIndicator();
    }

    function openDbusPanel() {
      if (!isDbusDisplayModeForced() && dbusDepartPreviewActive) {
        dbusDepartPreviewActive = false;
        hideDbusDepartures();
      }
      closeLangMenu();
      closeSearchUI({ reset: true });
      closeSettingsPanel();
      closeDbusStopPanel();
      updateDbusModeUI();
      if (typeof renderDbusLinesList === "function" && currentDbusMode !== DBUS_MODES.DEPARTS) {
        renderDbusLinesList(currentDbusMode);
      }
      openPanel($panelDbus, { display: "flex" });
      $btnDbus?.setAttribute('aria-expanded','true');
      updateDbusDepartIndicator();
      updateUiOverlays();
    }
    function shouldKeepDbusSelectionOnClose() {
      return window.matchMedia("(max-width: 980px), (max-height: 700px)").matches;
    }
    function closeDbusPanel() {
      closePanel($panelDbus, { durationMs: menuAnimDurationMs() });
      $btnDbus?.setAttribute('aria-expanded','false');
      dbusRoutesClosedByPanel = true;
      applyDbusDisplayMode(true);
      closeDbusStopPanel();
      updateDbusDepartIndicator();
      updateUiOverlays();
    }
    document.getElementById("dbusPanelClose")?.addEventListener("click", closeDbusPanel);
    document.getElementById("dbusStopClose")?.addEventListener("click", closeDbusStopPanel);
    $settingsPanelClose?.addEventListener("click", closeSettingsPanel);
    function parseCssDurationMs(value, fallbackMs = 0){
      const raw = String(value || "").trim();
      const m = raw.match(/^(-?\d*\.?\d+)(ms|s)$/i);
      if (!m) return fallbackMs;
      const amount = parseFloat(m[1]);
      if (!Number.isFinite(amount)) return fallbackMs;
      return m[2].toLowerCase() === "s" ? Math.max(0, Math.round(amount * 1000)) : Math.max(0, Math.round(amount));
    }
    function readDurationVarMs(varName, fallbackMs){
      const raw = getComputedStyle(document.documentElement).getPropertyValue(varName);
      return parseCssDurationMs(raw, fallbackMs);
    }
    function menuAnimDurationMs(){
      return readDurationVarMs("--anim-med", 240);
    }
    function previewAnimDurationMs(){
      return readDurationVarMs("--anim-slow", 340);
    }
    const PANEL_CLOSE_TIMERS = new WeakMap();
    function clearPanelCloseTimer(el){
      if (!el) return;
      const t = PANEL_CLOSE_TIMERS.get(el);
      if (t) {
        clearTimeout(t);
        PANEL_CLOSE_TIMERS.delete(el);
      }
      el.classList.remove("is-closing");
    }
    function finishPanelClose(el, { ariaHidden } = {}){
      if (!el) return;
      clearPanelCloseTimer(el);
      el.style.display = "none";
      if (typeof ariaHidden === "boolean") {
        el.setAttribute("aria-hidden", ariaHidden ? "true" : "false");
      }
    }
    function openPanel(el, { display = "flex", ariaHidden } = {}){
      if (!el) return;
      clearPanelCloseTimer(el);
      el.style.display = display;
      if (typeof ariaHidden === "boolean") {
        el.setAttribute("aria-hidden", ariaHidden ? "true" : "false");
      }
      setMenuOpen(el, true);
    }
    function closePanel(el, { durationMs = 0, ariaHidden } = {}){
      if (!el) return;
      clearPanelCloseTimer(el);
      setMenuOpen(el, false);
      if (typeof ariaHidden === "boolean") {
        el.setAttribute("aria-hidden", ariaHidden ? "true" : "false");
      }
      if (!UI_ANIMATIONS || durationMs <= 0) {
        finishPanelClose(el, { ariaHidden });
        return;
      }
      el.classList.add("is-closing");
      const timer = setTimeout(() => {
        if (PANEL_CLOSE_TIMERS.get(el) !== timer) return;
        PANEL_CLOSE_TIMERS.delete(el);
        finishPanelClose(el, { ariaHidden });
      }, durationMs);
      PANEL_CLOSE_TIMERS.set(el, timer);
    }
    function isDbusOpen() {
      return !!$panelDbus && getComputedStyle($panelDbus).display !== "none" && !$panelDbus.classList.contains("is-closing");
    }
    function isDbusStopOpen() {
      return !!$dbusStopPanel && getComputedStyle($dbusStopPanel).display !== "none" && !$dbusStopPanel.classList.contains("is-closing");
    }
    function isLinePreviewOpen() {
      const wrap = document.getElementById("linePreviewWrap");
      return !!wrap && getComputedStyle(wrap).display !== "none" && !wrap.classList.contains("is-closing");
    }
    function isButtonDisabled(btn){
      return !!btn && (btn.classList.contains("is-disabled") || btn.getAttribute("aria-disabled") === "true");
    }
    function setButtonDisabled(btn, disabled){
      if (!btn) return;
      btn.classList.toggle("is-disabled", disabled);
      if (disabled) btn.setAttribute("aria-disabled", "true");
      else btn.removeAttribute("aria-disabled");
    }
    function setMenuOpen(el, open){
      if (!el) return;
      if (open) el.classList.remove("is-closing");
      el.classList.toggle("is-open", !!open);
    }
    function closeAllMenus({ resetSearch = true } = {}){
      closeSearchUI({ reset: resetSearch });
      closeDbusPanel();
      closeSettingsPanel();
      closeDbusStopPanel();
      hideLinePreview();
      try { resetDbusSelection(); } catch {}
      try { closeLangMenu(); } catch {}
    }
    function syncMapIconInteractivity(disabled){
      const isDisabled = !!disabled;
      if (MAP_POI_OVERLAYS_HIDDEN !== isDisabled) {
        MAP_POI_OVERLAYS_HIDDEN = isDisabled;
        ZOOM_SIZED_IMAGE_OVERLAYS.forEach(rec => {
          const overlay = rec?.overlay;
          if (!overlay) return;
          if (isDisabled) {
            try { if (map.hasLayer(overlay)) map.removeLayer(overlay); } catch {}
            return;
          }
          try {
            if (!map.hasLayer(overlay)) overlay.addTo(map);
            applyZoomSizedOverlayBounds(rec);
          } catch {}
        });
      }
      document.querySelectorAll(".leaflet-image-layer.leaflet-zoom-animated.leaflet-interactive").forEach(el => {
        el.style.pointerEvents = isDisabled ? "none" : "auto";
        el.style.visibility = isDisabled ? "hidden" : "visible";
      });
      document.querySelectorAll(".leaflet-marker-icon.dbus-stop-marker-host").forEach(el => {
        el.style.pointerEvents = isDisabled ? "none" : "auto";
        el.style.visibility = isDisabled ? "hidden" : "visible";
      });
    }
    function updateUiOverlays() {
      refreshHeaderMetrics();
      const hasSelectedRoute = !!String(currentSelectedKey || "").trim();
      document.body.classList.toggle("route-selected", hasSelectedRoute);
      const isDbusMenuOpen = isDbusOpen() || isDbusStopOpen();
      const isSettingsPanelOpen = isSettingsOpen();
      const isMenuOpen = isDbusMenuOpen || isSettingsPanelOpen;
      const isRightSidePanelOpen = isDbusOpen() || isSettingsPanelOpen;
      const activeRightPanelWidth = isRightSidePanelOpen ? getActiveRightPanelWidth() : 0;
      if (activeRightPanelWidth > 0) {
        document.documentElement.style.setProperty("--activePanelShift", `${activeRightPanelWidth}px`);
      } else {
        document.documentElement.style.removeProperty("--activePanelShift");
      }
      const shouldHideMapTopbarControls = isRightSidePanelOpen && isCompactViewportForOpenPanels();
      document.body.classList.toggle("compact-open-ui", shouldHideMapTopbarControls);
      const isPreviewOpen = isLinePreviewOpen();
      document.body.classList.toggle("preview-open", isPreviewOpen);
      document.body.classList.remove("map-icons-disabled");
      syncMapIconInteractivity(false);
      const lockSearch = isPreviewOpen;
      const isDepartIndicatorOpen = !!$dbusDepartIndicatorWrap && !$dbusDepartIndicatorWrap.hidden;
      const isSearchPanelOpen = isSearchOpen();
      if (lockSearch && isSearchPanelOpen && typeof closeSearchUI === "function") {
        closeSearchUI({ reset: true });
      }
      if ($btnSearch) $btnSearch.classList.toggle("is-open", isSearchPanelOpen);
      if ($btnDbus) $btnDbus.classList.toggle("is-open", isDbusMenuOpen || isPreviewOpen || isDepartIndicatorOpen);
      if ($btnLang) $btnLang.classList.toggle("is-open", isLangMenuOpen());
      if ($btnSettings) $btnSettings.classList.toggle("is-open", isSettingsPanelOpen);
      if ($topBar) $topBar.classList.toggle("dbus-open", isRightSidePanelOpen);
      if ($topActions) $topActions.classList.toggle("dbus-open", isRightSidePanelOpen);
      if ($searchPanelHost) $searchPanelHost.classList.toggle("dbus-open", isRightSidePanelOpen);
      if ($watermark) $watermark.classList.toggle("dbus-open", isMenuOpen);
      const linePreviewWrapEl = document.getElementById("linePreviewWrap");
      if (linePreviewWrapEl) {
        const canOffsetPreview = window.matchMedia("(min-width: 981px)").matches;
        linePreviewWrapEl.classList.toggle("with-side-panel", isRightSidePanelOpen && canOffsetPreview);
      }
      if (isPreviewOpen) {
        refreshLinePreviewRail();
        updateLinePreviewScrollCues();
      }
      setButtonDisabled($btnSearch, lockSearch);
      setButtonDisabled($btnDbus, false);
      setButtonDisabled($btnSettings, false);
      if ($search) {
        $search.disabled = lockSearch;
        if (lockSearch) $search.setAttribute("aria-disabled", "true");
        else $search.removeAttribute("aria-disabled");
      }
      const scaleEl = document.getElementById("custom-scale");
      if (scaleEl) scaleEl.hidden = isPreviewOpen;
    }
    function updateDbusDepartIndicator(){
      if (!$dbusDepartIndicatorWrap) return;
      $dbusDepartIndicatorWrap.hidden = true;
      updateUiOverlays();
    }
    function refreshDbusDepartures(showOnMap){
      const needsBuild = !dbusDepartGroups.length || dbusDepartFilterKey !== `${showSchoolLines}-${showFictiveLines}`;
      if (needsBuild) buildDbusDepartures();
      else renderDbusDepartList();
      if (showOnMap) showDbusDepartures();
      else hideDbusDepartures();
    }
    function openSearchUI({ focus = false, refresh = false } = {}) {
      if (isButtonDisabled($btnSearch)) return;
      closeLangMenu();
      closeDbusPanel();
      closeSettingsPanel();
      if ($searchPanel) {
        openPanel($searchPanel, { display: "flex", ariaHidden: false });
      }
      $btnSearch?.setAttribute("aria-expanded", "true");
      if (refresh) doSearch($search.value);
      $results.hidden = false;
      if (focus) setTimeout(() => $search?.focus(), 0);
      updateUiOverlays();
    }
    function closeSearchUI({ reset = false } = {}) {
      if (reset) $search.value = '';
      renderResults([]); 
      $results.hidden = true;
      $search.blur();
      if ($searchPanel) {
        closePanel($searchPanel, { durationMs: menuAnimDurationMs(), ariaHidden: true });
      }
      $btnSearch?.setAttribute("aria-expanded", "false");
      updateUiOverlays();
    }
    function isSearchOpen(){
      return !!$searchPanel && getComputedStyle($searchPanel).display !== 'none' && !$searchPanel.classList.contains("is-closing");
    }

    if ($btnSearch) {
      $btnSearch.addEventListener("click", () => {
        if (isButtonDisabled($btnSearch)) {
          closeAllMenus({ resetSearch: true });
          return;
        }
        if (isSearchOpen()) closeSearchUI({ reset: true });
        else {
          setActiveSearchCategory(SEARCH_CATEGORY_ALL);
          $search.value = "";
          openSearchUI({ focus: true, refresh: true });
        }
      });
    }
    $searchPanelClose?.addEventListener("click", () => closeSearchUI({ reset: true }));

    $dbusModeButtons.forEach(btn => {
      btn.addEventListener("click", () => setDbusMode(btn.dataset.mode));
    });
    updateDbusModeUI();
    function onDbusFilterChange() {
      dbusRoutesClosedByPanel = true;
      updateDbusModeUI();
      const selectedLineUid = (() => {
        if (currentSelectedKey) {
          const [uid] = String(currentSelectedKey).split(":");
          return uid || "";
        }
        return currentSelectedLineUid || "";
      })();
      if ((!showSchoolLines || !showFictiveLines) && selectedLineUid) {
        try {
          const line = DBUS_LINES.find(l => String(l.uid) === String(selectedLineUid));
          const cat = line ? getCategory(line) : "";
          if (!showSchoolLines && cat === "Scolaire") clearDbusSelection();
          if (!showFictiveLines && cat === "Autres") clearDbusSelection();
        } catch {}
      }
      if (isDbusDisplayModeForced()) {
        closeDbusStopPanel();
        refreshDbusDepartures(true);
        if (typeof renderDbusLinesList === "function") renderDbusLinesList(currentDbusMode);
        renderDbusStopsLayer();
        return;
      }
      if (currentDbusMode === DBUS_MODES.DEPARTS) {
        closeDbusStopPanel();
        refreshDbusDepartures(dbusDepartPreviewActive);
        renderDbusStopsLayer();
        return;
      }
      if (typeof renderDbusLinesList === "function") renderDbusLinesList(currentDbusMode);
      renderDbusStopsLayer();
    }
    function syncFilterTogglesUI() {
      if ($dbusSchoolToggle) $dbusSchoolToggle.checked = !!showSchoolLines;
      if ($settingsSchoolToggle) $settingsSchoolToggle.checked = !!showSchoolLines;
      if ($dbusFictiveToggle) $dbusFictiveToggle.checked = !!showFictiveLines;
      if ($settingsFictiveToggle) $settingsFictiveToggle.checked = !!showFictiveLines;
    }
    function setSchoolFilter(next, { apply = true } = {}) {
      showSchoolLines = !!next;
      syncFilterTogglesUI();
      if (apply) onDbusFilterChange();
    }
    function setFictiveFilter(next, { apply = true } = {}) {
      showFictiveLines = !!next;
      syncFilterTogglesUI();
      if (apply) onDbusFilterChange();
    }
    if ($dbusSchoolToggle) setSchoolFilter($dbusSchoolToggle.checked, { apply: false });
    else if ($settingsSchoolToggle) setSchoolFilter($settingsSchoolToggle.checked, { apply: false });
    if ($dbusFictiveToggle) setFictiveFilter($dbusFictiveToggle.checked, { apply: false });
    else if ($settingsFictiveToggle) setFictiveFilter($settingsFictiveToggle.checked, { apply: false });

    $dbusSchoolToggle?.addEventListener("change", () => setSchoolFilter($dbusSchoolToggle.checked));
    $settingsSchoolToggle?.addEventListener("change", () => setSchoolFilter($settingsSchoolToggle.checked));
    $dbusFictiveToggle?.addEventListener("change", () => setFictiveFilter($dbusFictiveToggle.checked));
    $settingsFictiveToggle?.addEventListener("change", () => setFictiveFilter($settingsFictiveToggle.checked));

    $btnDbus.addEventListener('click', () => {
      if (isButtonDisabled($btnDbus)) {
        closeAllMenus({ resetSearch: true });
        return;
      }
      if (isDbusOpen()) closeDbusPanel();
      else openDbusPanel();
      renderSelectedChip();
    });
    $dbusRoutesClear?.addEventListener("click", () => {
      clearDbusSelection($panelDbus);
    });

    $dbusDepartIndicatorClose?.addEventListener("click", () => {
      dbusDepartPreviewActive = false;
      if (isDbusDisplayModeForced()) {
        dbusDisplayMode = "normal";
      }
      setDbusMode(DBUS_MODES.LINES);
      updateDbusDepartIndicator();
    });
    $dbusDepartMapBtn?.addEventListener("click", () => {
      dbusDepartPreviewActive = true;
      if (currentDbusMode !== DBUS_MODES.DEPARTS) setDbusMode(DBUS_MODES.DEPARTS);
      else refreshDbusDepartures(true);
      closeDbusPanel();
    });


    function renderSelectedChip(){
      const host = $selectedChip;
      if (!currentSelectedKey) { host.style.display="none"; host.innerHTML=""; return; }
      host.style.display = "none";
      host.innerHTML = "";
    }

    function createDbusNoneAction(onActivate){
      const empty = document.createElement("div");
      empty.className = "dbus-none";
      empty.textContent = t("none");
      empty.tabIndex = 0;
      empty.setAttribute("role", "button");
      const activate = () => {
        if (typeof onActivate === "function") onActivate();
      };
      empty.addEventListener("click", activate);
      empty.addEventListener("keydown", (event) => {
        if (event.key !== "Enter" && event.key !== " ") return;
        event.preventDefault();
        activate();
      });
      return empty;
    }

    function showDbusRoutesPlaceholder(){
      if (!$dbusRoutesList) return;
      $dbusRoutesList.innerHTML = "";
      const empty = createDbusNoneAction(() => {
        if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === "function") {
          try { window.__DBUS_GRID_OPEN.clear(); } catch {}
          window.__DBUS_GRID_OPEN = null;
          return;
        }
        resetDbusSelection();
      });
      $dbusRoutesList.appendChild(empty);
      setDbusRoutesTitleCount(null);
    }
    function setDbusRoutesTitleCount(count = null){
      if (!$dbusRoutesTitleLabel) return;
      const n = Number(count);
      if (Number.isFinite(n) && n >= 0) {
        $dbusRoutesTitleLabel.dataset.routeCount = String(Math.round(n));
        $dbusRoutesTitleLabel.textContent = `${t("dbus_routes_title")} (${Math.round(n)})`;
        return;
      }
      delete $dbusRoutesTitleLabel.dataset.routeCount;
      $dbusRoutesTitleLabel.textContent = t("dbus_routes_title");
    }

    function resetDbusSelection(){
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item.active")?.forEach(item => {
        item.classList.remove("active");
        item.style.outline = "none";
      });
      currentSelectedKey = "";
      currentSelectedLineUid = "";
      dbusRoutesClosedByPanel = false;
      hideAllRoutes();
      hideLinePreview();
      renderSelectedChip();
      if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === "function") {
        try { window.__DBUS_GRID_OPEN.clear(); } catch {}
        window.__DBUS_GRID_OPEN = null;
      }
      showDbusRoutesPlaceholder();
      updateDbusModeUI();
    }
    var dbusSelectionScrollTimer = 0;
    function clearDbusSelectionScrollTimer(){
      if (!dbusSelectionScrollTimer) return;
      clearTimeout(dbusSelectionScrollTimer);
      dbusSelectionScrollTimer = 0;
    }
    function keepDbusSelectionVisible({ smooth = false } = {}){
      const container = $dbusLinesContent || $dbusList?.closest(".dbus-content");
      if (!container || container.offsetParent === null) return;
      const target =
        $dbusList?.querySelector(".dbus-item.active") ||
        $dbusList?.querySelector(".dbus-logo.sel");
      if (!target || target.offsetParent === null) return;

      const cRect = container.getBoundingClientRect();
      const tRect = target.getBoundingClientRect();
      const pad = 10;
      let nextTop = container.scrollTop;
      if (tRect.top < (cRect.top + pad)) {
        nextTop += (tRect.top - (cRect.top + pad));
      } else if (tRect.bottom > (cRect.bottom - pad)) {
        nextTop += (tRect.bottom - (cRect.bottom - pad));
      } else {
        return;
      }
      const maxTop = Math.max(0, container.scrollHeight - container.clientHeight);
      const clamped = Math.max(0, Math.min(maxTop, nextTop));
      container.scrollTo({ top: clamped, behavior: (smooth && UI_ANIMATIONS) ? "smooth" : "auto" });
    }
    function scheduleKeepDbusSelectionVisible(){
      clearDbusSelectionScrollTimer();
      requestAnimationFrame(() => keepDbusSelectionVisible({ smooth: false }));
      if (!UI_ANIMATIONS) return;
      dbusSelectionScrollTimer = setTimeout(() => {
        dbusSelectionScrollTimer = 0;
        keepDbusSelectionVisible({ smooth: true });
      }, 120);
    }

    function updateDbusModeUI(){
      $dbusModeButtons.forEach(btn => {
        const active = btn.dataset.mode === currentDbusMode;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
        btn.disabled = false;
      });
      const isDepartMode = currentDbusMode === DBUS_MODES.DEPARTS;
      const isListMode = (currentDbusMode === DBUS_MODES.LINES || currentDbusMode === DBUS_MODES.LENGTH);
      const hasLineSelection = !!currentSelectedKey || !!currentSelectedLineUid;
      const showRoutesBox = currentDbusMode === DBUS_MODES.LINES && hasLineSelection && !dbusRoutesClosedByPanel;
      if ($dbusList) $dbusList.style.display = isListMode ? "" : "none";
      if ($dbusDepartActions) $dbusDepartActions.hidden = !isDepartMode;
      if ($dbusDepartList) $dbusDepartList.style.display = isDepartMode ? "" : "none";
      if ($dbusRoutesBox) {
        $dbusRoutesBox.hidden = !showRoutesBox;
        $dbusRoutesBox.style.display = showRoutesBox ? "flex" : "none";
      }
      if ($dbusLinesBox) {
        $dbusLinesBox.style.flex = showRoutesBox ? "0 0 43vh" : "1 1 auto";
        $dbusLinesBox.style.minHeight = "0";
        $dbusLinesBox.style.maxHeight = showRoutesBox ? "43vh" : "";
      }
      if ($dbusRoutesBox && showRoutesBox) {
        $dbusRoutesBox.style.flex = "1 1 0";
        $dbusRoutesBox.style.minHeight = "0";
      } else if ($dbusRoutesBox) {
        $dbusRoutesBox.style.flex = "";
        $dbusRoutesBox.style.minHeight = "";
      }
      if ($dbusLinesContent) $dbusLinesContent.style.maxHeight = "";
      if (!showRoutesBox) showDbusRoutesPlaceholder();
      if ($dbusRoutesClear) $dbusRoutesClear.hidden = !hasLineSelection;
      if (showRoutesBox && hasLineSelection) scheduleKeepDbusSelectionVisible();
      else clearDbusSelectionScrollTimer();
      if (typeof updateDbusPanelTitles === "function") updateDbusPanelTitles();
      updateUiOverlays();
    }

    function setDbusMode(mode){
      if (!mode || currentDbusMode === mode) return;
      currentDbusMode = mode;
      updateDbusModeUI();
      const forced = isDbusDisplayModeForced();
      if (mode === DBUS_MODES.DEPARTS) {
        resetDbusSelection();
        refreshDbusDepartures(dbusDepartPreviewActive || forced);
      } else {
        resetDbusSelection();
        if (typeof renderDbusLinesList === "function") renderDbusLinesList(mode);
        if (forced) {
          dbusDepartPreviewActive = true;
          refreshDbusDepartures(true);
        } else {
          dbusDepartPreviewActive = false;
          hideDbusDepartures();
          closeDbusStopPanel();
        }
      }
      updateDbusDepartIndicator();
    }

    function clearDbusSelection(scope = $dbusList){
      const activeItems = scope ? scope.querySelectorAll(".dbus-item.active") : [];
      activeItems.forEach(item => {
        item.classList.remove("active");
        item.style.outline = "none";
      });
      currentSelectedKey = "";
      currentSelectedLineUid = "";
      dbusRoutesClosedByPanel = false;
      hideAllRoutes();
      hideLinePreview();
      renderSelectedChip();
      if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === "function") {
        try { window.__DBUS_GRID_OPEN.clear(); } catch {}
        window.__DBUS_GRID_OPEN = null;
      }
      showDbusRoutesPlaceholder();
      updateDbusModeUI();
    }
    function selectDbusLineRouteFromStopEntry(entry, opts = {}){
      const lineUid = String(entry?.line?.uid || "");
      if (!lineUid) return;
      const forcedGroupUid = String(opts?.groupUid || "").trim();
      const routeRaw = String(entry?.route?.name || "").trim();
      const lineRaw = String(entry?.line?.number || "").trim();
      const parsedLineRaw = String(parseRouteName(routeRaw || "").lineNumber || "").trim();
      const entryLooksExpress =
        /^express\b/i.test(routeRaw) ||
        /^express\b/i.test(parsedLineRaw) ||
        /^express\b/i.test(lineRaw);
      const entryLooksAutocar =
        /^autocar\b/i.test(routeRaw) ||
        /^fict/i.test(routeRaw) ||
        /^autocar\b/i.test(parsedLineRaw) ||
        /^fict/i.test(parsedLineRaw) ||
        /^autocar\b/i.test(lineRaw) ||
        /^fict/i.test(lineRaw);

      openDbusPanel();
      if (currentDbusMode !== DBUS_MODES.LINES) setDbusMode(DBUS_MODES.LINES);
      dbusRoutesClosedByPanel = false;
      if (typeof renderDbusLinesList === "function") renderDbusLinesList(DBUS_MODES.LINES);
      updateDbusModeUI();

      const findLineLogo = () => {
        const all = $dbusList ? [...$dbusList.querySelectorAll(".dbus-logo[data-line-uid]")] : [];
        return all.find(el => String(el.dataset.lineUid || "") === lineUid) || null;
      };
      const findGroupedLineLogo = () => {
        let groupUid = forcedGroupUid;
        if (!groupUid && entryLooksExpress) {
          try {
            groupUid = getExpressGroupMeta(entry?.line, entry?.route).uid || "";
          } catch {
            groupUid = "";
          }
        } else if (!groupUid && entryLooksAutocar) {
          groupUid = "group:autocar";
        }
        if (!groupUid) return null;
        const all = $dbusList ? [...$dbusList.querySelectorAll(".dbus-logo[data-line-uid]")] : [];
        return all.find(el => String(el.dataset.lineUid || "") === groupUid) || null;
      };

      const lineLogo = findLineLogo();
      const groupLogo = findGroupedLineLogo();
      const targetLogo = (entryLooksExpress || entryLooksAutocar)
        ? (groupLogo || lineLogo)
        : (lineLogo || groupLogo);
      if (targetLogo) {
        targetLogo.click();
        return;
      }

      const lineIdx = DBUS_LINES.findIndex(l => String(l.uid || "") === lineUid);
      const line = lineIdx >= 0 ? DBUS_LINES[lineIdx] : null;
      if (!line) return;
      currentSelectedKey = "";
      currentSelectedLineUid = line.uid;
      dbusRoutesClosedByPanel = false;
      hideAllRoutes();
      hideLinePreview();
      renderSelectedChip();
      updateDbusModeUI();
      requestAnimationFrame(() => {
        const retryLogo = findLineLogo() || findGroupedLineLogo();
        if (retryLogo) retryLogo.click();
      });
    }

    function isNumericOnly(s){ return /^\d+$/.test(String(s||"").trim()); }
    function isFlix(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("flix")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("flix"));
    }
    function isNoctilien(line){
      const num = String(line.number||"").trim().toUpperCase();
      return /^N\d+$/.test(num);
    }
    function isAutocar(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("autocar")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("autocar"));
    }
    function isFictive(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("fictive")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("fictive"));
    }
    function isExpress(line){
      const num = String(line.number||"").trim().toLowerCase();
      if (/^express\b/.test(num)) return true;
      return (line.routes||[]).some(r => /^express\b/i.test(String(r.name||"").trim()));
    }
    function isExpressNumber(value){
      return /^express\b/i.test(String(value || "").trim());
    }
    function routeBadgeSizeFor(value){
      return isExpressNumber(value) ? "116x32" : "92x32";
    }
    function routeColorKey(line, route, parsedLineNumber){
      const routeName = String(route?.name || "").trim();
      const parsed = String(parsedLineNumber || "").trim();
      const routeIsExpressLike =
        /^express\b/i.test(routeName) ||
        /^express\b/i.test(parsed);
      if (routeIsExpressLike) {
        if (parsed) return parsed;
        const m = routeName.match(/\bexpress\b\s*([0-9a-z]+)/i);
        if (m && m[1]) return `Express ${m[1]}`;
        return "Express";
      }
      const routeIsAutocarLike =
        /^autocar\b/i.test(routeName) ||
        /^fict/i.test(routeName) ||
        /^autocar\b/i.test(parsed) ||
        /^fict/i.test(parsed);
      if (routeIsAutocarLike || (!routeIsExpressLike && (isAutocar(line) || isFictive(line)))) {
        return "Autocar";
      }
      if (parsed) return parsed;
      return getLineNumber(line, route);
    }
    function isTitusLine(line){
      const num = String(line.number||"").trim().toLowerCase();
      return /titus/i.test(num);
    }
    function getCategory(line){
      if (isNoctilien(line))          return "Noctilien";
      if (isFlix(line))               return "FlixBus";
      if (isAutocar(line))            return "Autres";
      if (isExpress(line))            return "Urbain";
      if (isNumericOnly(line.number)) return "Urbain";
      if (isTitusLine(line))          return "Urbain";
      if (/^scolaire/i.test(line.number)) return "Scolaire";
      return "Autres";
    }

    function compareDepartRoutes(a, b) {
      const numA = String(getLineNumber(a.line, a.route) || "").trim();
      const numB = String(getLineNumber(b.line, b.route) || "").trim();
      const aNum = isNumericOnly(numA);
      const bNum = isNumericOnly(numB);
      if (aNum !== bNum) return aNum ? -1 : 1;
      const cmp = numA.localeCompare(numB, 'fr', { numeric: true, sensitivity: "base" });
      if (cmp !== 0) return cmp;
      const uidCmp = String(a.line?.uid || "").localeCompare(String(b.line?.uid || ""), 'fr', { numeric: true, sensitivity: "base" });
      if (uidCmp !== 0) return uidCmp;
      const durDiff = (b.route?.totalMinutes || 0) - (a.route?.totalMinutes || 0);
      if (durDiff !== 0) return durDiff;
      return String(a.route?.name || "").localeCompare(String(b.route?.name || ""), 'fr', { numeric: true, sensitivity: "base" });
    }

    function countDepartEntries(entries) {
      let total = 0;
      const scolaireLines = new Set();
      entries.forEach(entry => {
        if (getCategory(entry.line) === "Scolaire") {
          scolaireLines.add(entry.line.uid);
        } else {
          total += 1;
        }
      });
      return total + scolaireLines.size;
    }

    const DEPART_CATEGORY_ORDER = ["Urbain", "Noctilien", "FlixBus", "Scolaire", "Autres"];
    function dbusSectionHeadHTML(key, count){
      const safeCount = Number.isFinite(Number(count)) ? Number(count) : 0;
      if (key === "Scolaire") {
        return `
          <span style="display:inline-flex;align-items:center;gap:8px;">
            <img class="dbus-sechead-logo" src="${overlayPath("bus_school.png")}" alt="${escapeHTML(t("dbus_school_toggle"))}"/>
            <span>(${safeCount})</span>
          </span>
          <span class="chev" style="margin-left:auto">▼</span>
        `;
      }
      const title = dbusCategoryTitle(key);
      return `<span>${title} (${safeCount})</span><span class="chev" style="margin-left:auto">▼</span>`;
    }

    function buildDepartBuckets(entries) {
      const buckets = {
        "Urbain": [],
        "Noctilien": [],
        "FlixBus": [],
        "Scolaire": [],
        "Autres": []
      };
      entries.forEach(entry => {
        const cat = getCategory(entry.line);
        if (buckets[cat]) buckets[cat].push(entry);
      });
      return buckets;
    }

    function renderDepartCategorySection(key, entries, container, isOpenByDefault = false) {
      if (!entries.length) return;
      const sec = document.createElement("div");
      sec.className = "dbus-sec";
      container.appendChild(sec);

      const head = document.createElement("div");
      head.className = "dbus-sechead";
      head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
      head.dataset.cat = key;
      head.dataset.count = String(entries.length);
      head.innerHTML = dbusSectionHeadHTML(key, entries.length);
      sec.appendChild(head);

      const body = document.createElement("div");
      body.className = "dbus-secbody";
      body.hidden = !isOpenByDefault;
      sec.appendChild(body);

      const sorted = [...entries].sort(compareDepartRoutes);
      sorted.forEach(({ line, route }) => renderDepartLineItem(line, route, body));

      head.addEventListener("click", () => {
        const expanded = head.getAttribute("aria-expanded") === "true";
        head.setAttribute("aria-expanded", expanded ? "false" : "true");
        body.hidden = expanded;
      });
    }

    function renderDepartCategories(entries, container) {
      if (!entries.length) {
        const empty = document.createElement("div");
        empty.className = "dbus-none";
        empty.textContent = t("none");
        container.appendChild(empty);
        return;
      }

      const buckets = buildDepartBuckets(entries);
      DEPART_CATEGORY_ORDER.forEach((key) => {
        const list = buckets[key] || [];
        if (!list.length) return;
        renderDepartCategorySection(key, list, container, true);
      });
    }

    function appendRouteLogo(item, line, lineNumber, showLogo) {
      if (!showLogo) return;
      const rawLineNumber = String(lineNumber || line.number || "").trim();
      const isNoct = isNoctilien2(rawLineNumber);
      const isTitusLogo = /^titus\s*(\d+)/i.test(rawLineNumber) || isTitusLine(line);
      const cat = getCategory(line);
      const logos = [];
      if (isTitusLogo) {
        logos.push({ src: overlayPath("reseau_titus.png"), alt: "Reseau Titus" });
      } else if (isNoct) {
        logos.push({ src: overlayPath("noctilien_logo_idfm.png"), alt: "Noctilien" });
      } else if (cat === "Scolaire") {
        logos.push({ src: overlayPath("bus_school.png"), alt: "Scolaire" });
      } else if (cat === "Urbain") {
        logos.push({ src: overlayPath("bus_logo_idfm.png"), alt: "IDFM" });
      }
      if (!logos.length) return;
      logos.forEach(({ src, alt }) => {
        const logo = document.createElement("img");
        logo.className = "dbus-route-logo";
        logo.src = src;
        logo.alt = alt;
        item.appendChild(logo);
      });
    }

    function renderDepartLineItem(line, route, container) {
      const item = document.createElement("div");
      item.className = "dbus-item";

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const { titleEnd } = getRouteEndpoints(route);
      const mTitus = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const displayNumber = mTitus ? mTitus[1] : lineNumber;
      const isScolaire = getCategory(line) === "Scolaire";
      const badge = isScolaire ? null : makeLineBadge(displayNumber, "#444", "#fff", routeBadgeSizeFor(lineNumber));
      appendRouteLogo(item, line, lineNumber, true);

      const titleEl = document.createElement("div");
      titleEl.className = "rname";
      titleEl.style.flex = "1 1 auto";
      const dirName = getRouteTerminusLabel(route, titleEnd) || String(titleEnd || routeTitle || "").trim();
      const dirLabel = t("destination");
      const dirText = dirName || routeTitle || "?";
      titleEl.dataset.routeKind = "depart";
      titleEl.dataset.routeTitle = routeTitle || "";
      titleEl.dataset.routeEnd = titleEnd || "";
      if (flag) titleEl.dataset.routeFlag = flag;
      let titleHtml = `${dirLabel} : ${withRERIcon(dirText)}`;
      if (flag) titleHtml = titleHtml + ` <span class="route-flag">${flag}</span>`;
      titleEl.innerHTML = titleHtml; 

      const duration = document.createElement("div");
      duration.className = "dbus-duration";

      const stopCount = route.stops.length;
      let durationText;
      if (route.totalMinutes >= 60) {
        const h = Math.floor(route.totalMinutes / 60);
        const m = route.totalMinutes % 60;
          if (m > 0) {
            durationText = `${h} h ${m} ${minuteShortLabel()}`;
          } else {
            durationText = `${h} h`;
          }
        } else {
          durationText = `${route.totalMinutes} ${minuteShortLabel()}`;
        }
      setStopDurationText(duration, stopCount, durationText, "paren");

      if (badge) item.appendChild(badge);
      item.appendChild(titleEl);
      item.appendChild(duration);

      const colorKey = routeColorKey(line, route, lineNumber);
      if (badge) {
        getLineColors(colorKey).then(([bg,text])=>{
          badge.style.background = bg;
          badge.style.color = text;
          if (isNoctilien2(colorKey)) {
            ensureStripe(badge, noctilienStripeColor(colorKey));
          }
        });
      }

      item.addEventListener("click", () => {
        const lineIdx = DBUS_LINES.indexOf(line);
        setDbusMode(DBUS_MODES.LINES);
        currentSelectedKey = `${line.uid}:${route.uid}`;
        currentSelectedLineUid = line.uid;
        dbusRoutesClosedByPanel = false;
        showOnlyRoute(lineIdx >= 0 ? lineIdx : 0, line, route);
        renderSelectedChip();
        closeDbusStopPanel();
        closeDbusPanel();
      });

      container.appendChild(item);
    }

    function updateDepartMarkerClasses(marker, { hover = false, selected = false } = {}) {
      const el = marker?.getElement?.();
      if (!el) return;
      const dot = el.querySelector(".dbus-depart-dot");
      if (!dot) return;
      dot.classList.toggle("is-hover", hover);
      dot.classList.toggle("is-selected", selected);
    }

    function setDepartMarkerHover(marker, isHover) {
      if (!marker) return;
      marker._departHover = !!isHover;
      updateDepartMarkerClasses(marker, {
        hover: marker._departHover,
        selected: marker === selectedDepartMarker
      });
    }

    function clearDepartMarkerSelection() {
      if (!selectedDepartMarker) return;
      updateDepartMarkerClasses(selectedDepartMarker, { hover: !!selectedDepartMarker._departHover, selected: false });
      selectedDepartMarker = null;
    }

    function setSelectedDepartMarker(marker) {
      if (!marker) return;
      if (selectedDepartMarker && selectedDepartMarker !== marker) {
        updateDepartMarkerClasses(selectedDepartMarker, { hover: !!selectedDepartMarker._departHover, selected: false });
      }
      selectedDepartMarker = marker;
      updateDepartMarkerClasses(marker, { hover: !!marker._departHover, selected: true });
    }

    function closeDbusStopPanel() {
      closePanel($dbusStopPanel, { durationMs: menuAnimDurationMs() });
      clearDepartMarkerSelection();
      updateUiOverlays();
    }

    function normalizeDepartName(name) {
      const txt = String(name || "").trim();
      return txt || t("stop");
    }

    function getDepartGroupNames(group) {
      const names = [...group.nameMap.keys()].map(n => String(n || "").trim()).filter(Boolean);
      const translated = names.map(n => translateStopName(n));
      translated.sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: "base" }));
      if (!translated.length) return [t("stop")];
      return translated;
    }

    function renderDepartStopSection(nameRec, container) {
      const sec = document.createElement("div");
      sec.className = "dbus-sec";
      const h = document.createElement("h4");
      const displayName = translateStopName(nameRec.name);
      h.dataset.stopName = nameRec.name;
      const stopCount = countDepartEntries(nameRec.routes);
      h.dataset.stopCount = String(stopCount);
      h.innerHTML = `${withRERIcon(displayName)} (${stopCount})`;
      sec.appendChild(h);

      const body = document.createElement("div");
      sec.appendChild(body);
      renderDepartCategories(nameRec.routes, body);

      container.appendChild(sec);
    }

    function openDbusStopPanelForGroup(group) {
      if (!$dbusStopPanel || !$dbusStopTitle || !$dbusStopList) return;
      const rawNames = [...group.nameMap.keys()].map(n => String(n || "").trim()).filter(Boolean);
      const nameList = rawNames.map(n => translateStopName(n));
      $dbusStopTitle.innerHTML = nameList.map(n => withRERIcon(n)).join(" / ");
      $dbusStopTitle.dataset.stopMode = "group";
      $dbusStopTitle.dataset.stopNames = JSON.stringify(rawNames);
      delete $dbusStopTitle.dataset.stopName;
      $dbusStopList.innerHTML = "";

      const sections = [...group.nameMap.values()].sort((a, b) => {
        const countA = countDepartEntries(a.routes);
        const countB = countDepartEntries(b.routes);
        if (countB !== countA) return countB - countA;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: "base" });
      });
      if (sections.length <= 1) {
        const routes = sections[0]?.routes ? [...sections[0].routes] : [];
        renderDepartCategories(routes, $dbusStopList);
      } else {
        sections.forEach(section => renderDepartStopSection(section, $dbusStopList));
      }
      openPanel($dbusStopPanel, { display: "flex" });
      updateUiOverlays();
    }

    function openDbusStopPanelForName(nameRec) {
      if (!$dbusStopPanel || !$dbusStopTitle || !$dbusStopList) return;
      $dbusStopTitle.dataset.stopMode = "single";
      $dbusStopTitle.dataset.stopName = nameRec.name;
      $dbusStopTitle.innerHTML = `${t("stop")} : ${withRERIcon(translateStopName(nameRec.name))}`;
      $dbusStopList.innerHTML = "";

      renderDepartCategories(nameRec.routes, $dbusStopList);

      openPanel($dbusStopPanel, { display: "flex" });
      updateUiOverlays();
    }

    function renderDbusDepartList() {
      if (!$dbusDepartList) return;
      $dbusDepartList.innerHTML = "";
      const items = [...dbusDepartNameIndex.values()];
      items.sort((a, b) => {
        const countA = countDepartEntries(a.routes);
        const countB = countDepartEntries(b.routes);
        if (countB !== countA) return countB - countA;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: "base" });
      });

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "dbus-none";
        empty.textContent = t("none");
        $dbusDepartList.appendChild(empty);
        return;
      }

      items.forEach(rec => {
        const item = document.createElement("div");
        item.className = "dbus-item";

        const count = document.createElement("div");
        count.className = "dbus-stop-count";
        count.textContent = String(countDepartEntries(rec.routes));

        const titleEl = document.createElement("div");
        titleEl.className = "rname";
        titleEl.style.flex = "1 1 auto";
        titleEl.dataset.rawName = rec.name || "";
        titleEl.innerHTML = withRERIcon(translateStopName(rec.name));

        item.appendChild(count);
        item.appendChild(titleEl);

        item.addEventListener("click", () => {
          openDbusStopPanelForName(rec);
          if (rec.centerLatLng) centerWithPreview(rec.centerLatLng, { zoom: map.getZoom() });
          let bestGroupId = null;
          let bestCount = -1;
          rec.groupIds?.forEach(id => {
            const group = dbusDepartGroups.find(g => g.id === id);
            if (group && group.lineCount > bestCount) {
              bestCount = group.lineCount;
              bestGroupId = id;
            }
          });
          if (bestGroupId && dbusDepartMarkers.has(bestGroupId)) {
            setSelectedDepartMarker(dbusDepartMarkers.get(bestGroupId));
          }
        });

        $dbusDepartList.appendChild(item);
      });
    }

    function buildDbusDepartures() {
      dbusDepartGroups = [];
      dbusDepartMarkers = new Map();
      dbusDepartNameIndex = new Map();
      dbusDepartLayers.clearLayers();

      const entries = [];
      DBUS_LINES.forEach((line, lineIdx) => {
        const cat = getCategory(line);
        if (!showSchoolLines && cat === "Scolaire") return;
        if (!showFictiveLines && cat === "Autres") return;
        line.routes.forEach(route => {
          const firstStopId = route.stops[0]?.uid;
          if (typeof firstStopId === "undefined") return;
          const stop = DBUS_STOPS.get(firstStopId);
          if (!stop?.latlng) return;
          const pt = map.project(stop.latlng, maxNativeZoom);
          const { titleStart } = getRouteEndpoints(route);
          const rawStartName = titleStart || stop.name || "";
          const isProvisoireStart = hasProvisoire(stop.name) || hasProvisoire(titleStart);
          const cleanStartName = stripProvisoire(rawStartName);
          const startName = normalizeDepartName(isProvisoireStart ? `${cleanStartName} (Provisoire)` : cleanStartName);
          const entry = { line, lineIdx, route, stop, pt, startName };
          entries.push(entry);

          let nameRec = dbusDepartNameIndex.get(startName);
          if (!nameRec) {
            nameRec = { name: startName, routes: [], lineIds: new Set(), stopIds: new Set(), latlngs: [], groupIds: new Set() };
            dbusDepartNameIndex.set(startName, nameRec);
          }
          nameRec.routes.push(entry);
          nameRec.lineIds.add(line.uid);
          if (!nameRec.stopIds.has(stop.id)) {
            nameRec.stopIds.add(stop.id);
            if (stop.latlng) nameRec.latlngs.push(stop.latlng);
          }
        });
      });

      const groups = [];
      const distSq = DBUS_DEPART_MERGE_PX * DBUS_DEPART_MERGE_PX;

      entries.forEach(entry => {
        const { stop, pt } = entry;
        let target = null;
        for (const g of groups) {
          const dx = pt.x - g.centerPt.x;
          const dy = pt.y - g.centerPt.y;
          if ((dx * dx + dy * dy) <= distSq) { target = g; break; }
        }
        if (!target) {
          target = {
            id: groups.length + 1,
            centerPt: { x: pt.x, y: pt.y },
            stopIds: new Set(),
            stops: [],
            routes: [],
            lineIds: new Set(),
            nameMap: new Map()
          };
          groups.push(target);
        }
        target.routes.push(entry);
        target.lineIds.add(entry.line.uid);

        let nameRec = target.nameMap.get(entry.startName);
        if (!nameRec) {
          nameRec = { name: entry.startName, routes: [], lineIds: new Set(), stopIds: new Set() };
          target.nameMap.set(entry.startName, nameRec);
        }
        nameRec.routes.push(entry);
        nameRec.lineIds.add(entry.line.uid);
        nameRec.stopIds.add(stop.id);

        if (!target.stopIds.has(stop.id)) {
          target.stopIds.add(stop.id);
          target.stops.push(stop);
          const count = target.stops.length;
          target.centerPt.x = target.centerPt.x + (pt.x - target.centerPt.x) / count;
          target.centerPt.y = target.centerPt.y + (pt.y - target.centerPt.y) / count;
        }
      });

      groups.forEach(group => {
        const nameList = getDepartGroupNames(group);
        group.displayName = nameList.join(" / ");
        group.latlng = map.unproject(L.point(group.centerPt.x, group.centerPt.y), maxNativeZoom);
        group.lineCount = countDepartEntries(group.routes);
        group.nameMap.forEach((rec, nameKey) => {
          const nameRec = dbusDepartNameIndex.get(nameKey);
          if (nameRec) nameRec.groupIds.add(group.id);
        });
      });

      dbusDepartNameIndex.forEach(rec => {
        if (!rec.latlngs.length) return;
        let lat = 0, lng = 0;
        rec.latlngs.forEach(ll => { lat += ll.lat; lng += ll.lng; });
        rec.centerLatLng = L.latLng(lat / rec.latlngs.length, lng / rec.latlngs.length);
      });

      dbusDepartGroups = groups;

      groups.forEach(group => {
        const icon = L.divIcon({
          className: "dbus-depart-icon",
          html: `<div class="dbus-depart-dot">${group.lineCount}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        const marker = L.marker(group.latlng, { icon, riseOnHover: true });
        marker._departGroupId = group.id;
        marker._departHover = false;
        marker.on("click", () => {
          openDbusStopPanelForGroup(group);
          setSelectedDepartMarker(marker);
        });
        marker.on("mouseover", () => setDepartMarkerHover(marker, true));
        marker.on("mouseout", () => setDepartMarkerHover(marker, false));

        const tooltipHtml = escapeHTML(group.displayName);
        const tooltipOpts = { direction: "top", className: "dbus-depart-tooltip", offset: [0, -10] };
        marker.bindTooltip(tooltipHtml, tooltipOpts);

        dbusDepartMarkers.set(group.id, marker);
        dbusDepartLayers.addLayer(marker);
      });

      dbusDepartFilterKey = `${showSchoolLines}-${showFictiveLines}`;
      renderDbusDepartList();
    }

    function showDbusDepartures() {
      if (!DBUS_LINES.length || !DBUS_STOPS.size) return;
      if (!dbusDepartGroups.length || dbusDepartFilterKey !== `${showSchoolLines}-${showFictiveLines}`) buildDbusDepartures();
      if (!map.hasLayer(dbusDepartLayers)) dbusDepartLayers.addTo(map);
    }

    function hideDbusDepartures() {
      if (map.hasLayer(dbusDepartLayers)) map.removeLayer(dbusDepartLayers);
      clearDepartMarkerSelection();
    }

    async function initDbusUI(){
      try{
        await loadStops();
        await loadLines();
        buildDbusStopLineEntries();
        renderDbusStopsLayer();
      }catch(err){
        console.error("DBus: chargement échoué", err);
        return;
      }

      $dbusList.innerHTML = "";

      function compareUrbainLines(a,b){

        const aNum = isNumericOnly(a.number);
        const bNum = isNumericOnly(b.number);
        if (aNum && !bNum) return -1;
        if (!aNum && bNum) return 1;
        if (aNum && bNum) return (parseInt(a.number,10)||0) - (parseInt(b.number,10)||0);

        return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
      }

      function buildLineBuckets(){
        const buckets = { "Urbain": [], "FlixBus": [], "Noctilien": [], "Autres": [], "Scolaire": [] };
        DBUS_LINES.forEach(line => {
          const cat = getCategory(line);
          if (!showSchoolLines && cat === "Scolaire") return;
          if (!showFictiveLines && cat === "Autres") return;
          buckets[cat].push(line);
        });

        buckets["Urbain"].sort(compareUrbainLines);
        buckets["Noctilien"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["FlixBus"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["Autres"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["Scolaire"].sort((a, b) => {
          return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
        });
        return buckets;
      }

      function buildRouteBuckets(){
        const buckets = { "Urbain": [], "FlixBus": [], "Noctilien": [], "Autres": [], "Scolaire": [] };
        DBUS_LINES.forEach(line => {
          const cat = getCategory(line);
          if (!showSchoolLines && cat === "Scolaire") return;
          if (!showFictiveLines && cat === "Autres") return;
          line.routes.forEach(route => buckets[cat].push({ line, route }));
        });
        Object.values(buckets).forEach(list => {
          list.sort((a, b) => {
            const diff = lengthScoreForLengthMode(b.line, b.route) - lengthScoreForLengthMode(a.line, a.route);
            if (diff) return diff;
            return String(a.route.name || "").localeCompare(String(b.route.name || ""), 'fr', {numeric:true, sensitivity:"base"});
          });
        });
        return buckets;
      }

      function isExpressRoute(route){
        const raw = String(route?.name || "").trim();
        return /^express\b/i.test(raw);
      }
      function getExpressGroupMeta(line, route){
        const routeName = String(route?.name || "").trim();
        const parsedLineNumber = String(parseRouteName(routeName || "").lineNumber || "").trim();
        const lineNumber = String(line?.number || "").trim();
        let number = "";

        const fromParsed = /^express\b\s*(.*)$/i.exec(parsedLineNumber);
        if (fromParsed) number = String(fromParsed[1] || "").trim();
        if (!number) {
          const fromRoute = routeName.match(/\bexpress\b\s*([0-9a-z]+)/i);
          if (fromRoute && fromRoute[1]) number = String(fromRoute[1]).trim();
        }
        if (!number) {
          const fromLine = /^express\b\s*(.*)$/i.exec(lineNumber);
          if (fromLine) number = String(fromLine[1] || "").trim();
        }
        if (!number && /^\d+$/.test(parsedLineNumber)) number = parsedLineNumber;
        if (!number && /^\d+$/.test(lineNumber)) number = lineNumber;
        if (!number) number = "Express";

        const displayNumber = number.replace(/^express\b/i, "").trim() || "Express";
        const uidPart = normalizeBadgeToken(displayNumber || "express");
        const colorKey = /^express\b/i.test(displayNumber) ? displayNumber : `Express ${displayNumber}`;
        return {
          uid: `group:express:${uidPart}`,
          number: displayNumber,
          colorKey
        };
      }
      function lengthScoreForLengthMode(line, route){
        const base = Number(route?.totalMinutes || 0);
        const express = isExpress(line) || isExpressRoute(route);
        return express ? base * 0.75 : base;
      }

      function isAutocarRoute(route){
        const raw = String(route?.name || "").trim();
        return /^autocar\b/i.test(raw) || /^fict/i.test(raw);
      }

      function buildGroupedLineFromRoutes(uid, label, sourceLines, routeFilter){
        const routes = [];
        sourceLines.forEach(srcLine => {
          (srcLine.routes || []).forEach(route => {
            if (!routeFilter(route)) return;
            routes.push({ ...route, __sourceLine: srcLine });
          });
        });
        if (!routes.length) return null;
        return { uid: `group:${uid}`, number: label, routes, __isGroup: true };
      }
      function buildGroupedExpressLines(urbanLines, extraSourceLines){
        const groups = new Map();
        const seenRouteKeys = new Set();
        const addRoute = (srcLine, route) => {
          const routeUid = String(route?.uid || "");
          const lineUid = String(srcLine?.uid || "");
          if (!routeUid || !lineUid) return;
          const routeKey = `${lineUid}:${routeUid}`;
          if (seenRouteKeys.has(routeKey)) return;
          seenRouteKeys.add(routeKey);

          const meta = getExpressGroupMeta(srcLine, route);
          let group = groups.get(meta.uid);
          if (!group) {
            group = {
              uid: meta.uid,
              number: meta.number,
              routes: [],
              __isGroup: true,
              __isExpressGroup: true,
              __expressColorKey: meta.colorKey
            };
            groups.set(meta.uid, group);
          }
          group.routes.push({ ...route, __sourceLine: srcLine });
        };

        (urbanLines || []).forEach(line => {
          if (!isExpress(line)) return;
          (line.routes || []).forEach(route => addRoute(line, route));
        });
        (extraSourceLines || []).forEach(line => {
          (line.routes || []).forEach(route => {
            if (!isExpressRoute(route)) return;
            addRoute(line, route);
          });
        });

        const all = [...groups.values()];
        all.sort((a, b) => {
          const aNum = parseInt(String(a.number || "").replace(/\D+/g, ""), 10);
          const bNum = parseInt(String(b.number || "").replace(/\D+/g, ""), 10);
          const aHas = Number.isFinite(aNum);
          const bHas = Number.isFinite(bNum);
          if (aHas && bHas) return aNum - bNum;
          if (aHas !== bHas) return aHas ? -1 : 1;
          return String(a.number || "").localeCompare(String(b.number || ""), "fr", { numeric: true, sensitivity: "base" });
        });
        return all;
      }

      function renderSection(key, lines) {
        if (!lines.length) return;
        const title = dbusCategoryTitle(key);

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        let totalRoutes = 0;
        lines.forEach(line => {
          totalRoutes += (line.routes ? line.routes.length : 0);
        });

        const isOpenByDefault = (key === "Urbain" || key === "Noctilien" || key === "urban" || key === "noctilien");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.dataset.cat = key;
        head.dataset.count = String(totalRoutes);
        head.innerHTML = `
          <span>${title} (${totalRoutes})</span>
          <span class="chev" style="margin-left:auto">▼</span>
        `;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault; 
        sec.appendChild(body);

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearDbusSelection(body);
            return;
          }
        });

        const showSchoolLogo = key === "Scolaire";
        if (key === "Scolaire") {
          const allRoutes = [];
          lines.forEach(line => {
            line.routes.forEach(route => allRoutes.push({ line, route }));
          });

          allRoutes.sort((a, b) => {
            const depA = String(a.route.name).split(">")[0].trim();
            const depB = String(b.route.name).split(">")[0].trim();
            return depA.localeCompare(depB, 'fr', { numeric: true, sensitivity: "base" });
          });

          allRoutes.forEach(({ line, route }) => renderLineItem(line, route, body, { showLogo: showSchoolLogo }));
        } else {
          lines.forEach(line => {
            line.routes.forEach(route => renderLineItem(line, route, body, { showLogo: showSchoolLogo }));
          });
        }
      }

      function renderSectionGrid(key, lines) {
        if (!lines.length) return;
        const title = dbusCategoryTitle(key);

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        const head = document.createElement("h4");
        head.textContent = title;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = false;
        sec.appendChild(body);

        let selectedLineUid = null;

        function clearLocal(){
          selectedLineUid = null;
          showDbusRoutesPlaceholder();
          ($dbusList || body).querySelectorAll(".dbus-logo").forEach(el=>{
            el.style.outline = "none";
            el.classList.remove("dim", "sel");
            el.style.removeProperty("--selColor");
          });
          try { currentSelectedKey = ""; } catch {}
          try { currentSelectedLineUid = ""; } catch {}
          try { dbusRoutesClosedByPanel = false; } catch {}
          try { if (typeof hideAllRoutes === "function") hideAllRoutes(); } catch {}
          try { if (typeof hideLinePreview === "function") hideLinePreview(); } catch {}
          try { if (typeof updateDbusModeUI === "function") updateDbusModeUI(); } catch {}
        }

        function selectionColorForLine(line) {
          const rawNum = String(line.number || "").trim();
          if (isTitusLine(line)) return "#ffffff";
          if (/^N\d+$/i.test(rawNum)) return noctilienStripeColor(rawNum);
          if (line && line.__isExpressGroup) {
            const [bg] = getLineColorsSync(line.__expressColorKey || `Express ${rawNum}`);
            return bg;
          }
          return null;
        }

        function createLogoForLine(line) {
          const raw = String(line.number || "").trim();
          const wrap = document.createElement("div");
          wrap.className = "dbus-logo";

          if (/^scolaire\b/i.test(raw) || getCategory(line) === "Scolaire") {
            wrap.style.background = "transparent";
            wrap.style.border = "none";
            wrap.style.boxShadow = "none";
            const img = document.createElement("img");
            img.alt = "Scolaire";
            img.src = overlayPath("bus_school.png");
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "contain";
            wrap.appendChild(img);
            return wrap;
          }

          if (isTitusLine(line)) {
            wrap.classList.add("dbus-logo--titus");
            wrap.style.background = "transparent";
            const img = document.createElement("img");
            img.alt = "Reseau Titus";
            img.src = overlayPath("reseau_titus.png");
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "contain";
            img.onerror = () => {
              wrap.textContent = "Reseau Titus";
              wrap.style.color = "#522a8a";
              wrap.style.background = "transparent";
            };
            wrap.appendChild(img);
            return wrap;
          }

          const isExpressGroup = !!line.__isGroup && /^express$/i.test(raw);
          const badgeSize = "88x36";
          const badge = makeLineBadge(raw, "#444", "#fff", badgeSize);
          badge.classList.add("dbus-logo");
          getLineColors(raw).then(([bg,text])=>{
            if (line && line.__isExpressGroup) {
              const expressKey = line.__expressColorKey || `Express ${raw}`;
              const [xbg, xtext] = getLineColorsSync(expressKey);
              badge.style.background = xbg || "#6fb2e1";
              badge.style.color = xtext || "#FFFFFF";
            } else {
              badge.style.background = bg;
              badge.style.color = text;
            }
            if (isNoctilien2(raw)) ensureStripe(badge, noctilienStripeColor(raw));
          });
          return badge;
        }

        function renderRoutesForLine(line){
          if (!$dbusRoutesList) return;
          $dbusRoutesList.innerHTML = "";
          $dbusRoutesList.appendChild(createDbusNoneAction(() => {
            $panelDbus?.querySelectorAll(".dbus-item.active").forEach(it => {
              it.classList.remove("active");
              it.style.outline = "none";
            });
            currentSelectedKey = "";
            currentSelectedLineUid = String(line?.uid || currentSelectedLineUid || "");
            dbusRoutesClosedByPanel = false;
            hideAllRoutes();
            hideLinePreview();
            renderSelectedChip();
            updateDbusModeUI();
          }));
        const routes = Array.isArray(line.routes) ? line.routes : [];
        setDbusRoutesTitleCount(routes.length);
        if (!routes.length) return;
        routes.forEach(route => {
          const sourceLine = route && route.__sourceLine ? route.__sourceLine : line;
          const showSchoolLogo = getCategory(sourceLine) === "Scolaire";
          renderLineItem(sourceLine, route, $dbusRoutesList, {
            showLogo: showSchoolLogo,
            compactBadges: true
          });
        });
      }

        function bindLogoClick(logo, line, sectionId){
          logo.addEventListener("click", () => {
            const isSame = selectedLineUid === line.uid;
            if (!isSame && window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section !== sectionId) {
              try { window.__DBUS_GRID_OPEN.clear && window.__DBUS_GRID_OPEN.clear(); } catch {}
              window.__DBUS_GRID_OPEN = null;
            }
            if (isSame) {
              clearLocal();
              if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === sectionId) window.__DBUS_GRID_OPEN = null;
              return;
            }
            clearLocal();
            selectedLineUid = line.uid;
            currentSelectedLineUid = line.uid;
            dbusRoutesClosedByPanel = false;
            const raw = String(line.number || "");
            const selColor = selectionColorForLine(line);
            if (selColor) logo.style.setProperty("--selColor", selColor);
            else { getLineColors(raw).then(([bg])=>{ logo.style.setProperty("--selColor", bg); }); }
            renderRoutesForLine(line);
            ($dbusList || body).querySelectorAll(".dbus-logo").forEach(el=>{ if (el!==logo) el.classList.add("dim"); else el.classList.remove("dim"); });
            ($dbusList || body).querySelectorAll(".dbus-logo.sel").forEach(el=> el.classList.remove("sel"));
            logo.classList.add("sel");
            window.__DBUS_GRID_OPEN = { section: sectionId, clear: clearLocal };
            updateDbusModeUI();
          });
        }

        function renderLogoGrid(host, items, sectionId){
          if (!items.length) return;
          const grid = document.createElement("div");
          grid.className = "dbus-grid";
          host.appendChild(grid);
          items.forEach(line => {
            const block = document.createElement("div");
            block.className = "line-block";
            const logo = createLogoForLine(line);
            logo.dataset.lineUid = String(line.uid || "");
            block.appendChild(logo);
            bindLogoClick(logo, line, sectionId);
            grid.appendChild(block);
          });
        }

        renderLogoGrid(body, lines, key);
      }
      function getLineId(line, route) {
        if (line.number && line.number !== "?") {
          return line.number;
        }
        const { lineNumber } = parseRouteName(route.name || "");
        return lineNumber || "?";
      }

      function renderLineItem(line, route, container, { showLogo = false, lengthMode = false, compactBadges = false } = {}) {
        const item = document.createElement("div");
        item.className = "dbus-item";
        if (lengthMode) item.classList.add("dbus-item-length");
        item.dataset.lineUid = String(line?.uid || "");
        item.dataset.routeUid = String(route?.uid || "");

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const parsedLineRaw = String(lineNumber || "").trim();
      let parsedNumber = String(lineNumber || "").trim();
      const prefixedMatch = /^(?:express|scolaire|autocar)\s+(.+)$/i.exec(parsedNumber);
      if (prefixedMatch && prefixedMatch[1]) {
        parsedNumber = prefixedMatch[1].trim();
      }
      const fallbackNumber = String(getLineNumber(line, route) || "").trim();
      const needsFallback =
        !parsedNumber ||
        /^express\b/i.test(parsedNumber) ||
        /^scolaire\b/i.test(parsedNumber) ||
        /^autocar\b/i.test(parsedNumber) ||
        /^[a-z]+$/i.test(parsedNumber);
      const badgeRawNumber = needsFallback ? fallbackNumber : parsedNumber;
      const mTitus = /^titus\s*(\d+)/i.exec(String(badgeRawNumber || ""));
      const category = getCategory(line);
      const routeRaw = String(route?.name || "").trim();
      const routeIsExpressLike =
        /^express\b/i.test(routeRaw) ||
        /^express\b/i.test(parsedLineRaw) ||
        /^express\b/i.test(String(line?.number || "").trim());
      const routeIsAutocarLike =
        /^autocar\b/i.test(routeRaw) ||
        /^fict/i.test(routeRaw) ||
        /^autocar\b/i.test(parsedLineRaw) ||
        /^fict/i.test(parsedLineRaw);
      const isExpressItem = routeIsExpressLike;
      const isAutresLike = routeIsAutocarLike || (!isExpressItem && category === "Autres");
      const expressMeta = isExpressItem ? getExpressGroupMeta(line, route) : null;
      let displayNumber = mTitus ? mTitus[1] : badgeRawNumber;
      if (isAutresLike) {
        displayNumber = "Autocar";
      }
      if (lengthMode && isExpressItem) {
        const expressNum = String(expressMeta?.number || "").trim();
        if (!expressNum) displayNumber = "Express";
        else displayNumber = /^express\b/i.test(expressNum) ? expressNum : `Express ${expressNum}`;
      }
      const isScolaire = getCategory(line) === "Scolaire";
      const effectiveShowLogo = (lengthMode && isExpressItem) ? false : showLogo;
      const forceExpressLengthSize = lengthMode && (isExpressItem || isAutresLike || category === "FlixBus");
      const compactLengthBadge = ((lengthMode && !isExpressItem && !isExpressNumber(badgeRawNumber) && !forceExpressLengthSize) || compactBadges);
      const badgeSize = forceExpressLengthSize ? routeBadgeSizeFor("Express") : (compactLengthBadge ? "72x28" : routeBadgeSizeFor(displayNumber));
      const badge = isScolaire ? null : makeLineBadge(displayNumber, "#444", "#fff", badgeSize);
      appendRouteLogo(item, line, badgeRawNumber, effectiveShowLogo);
      if (lengthMode && effectiveShowLogo && badge) item.classList.add("logo-badge-tight");
        
        const titleEl = document.createElement("div");
        titleEl.className = "rname";
        titleEl.style.flex = "1 1 auto";
        const displayTitle = translateRouteTitle(routeTitle);
        titleEl.dataset.routeKind = "line";
        titleEl.dataset.routeTitle = routeTitle || "";
        if (flag) titleEl.dataset.routeFlag = flag;
        let titleHtml = withRERIcon(displayTitle || routeTitle);
        if (flag) {
          titleHtml = titleHtml + ` <span class="route-flag">${flag}</span>`;
        }
        titleEl.innerHTML = titleHtml;

        const duration = document.createElement("div");
        duration.className = "dbus-duration";

        const stopCount = route.stops.length;

        let durationText;
        if (route.totalMinutes >= 60) {
          const h = Math.floor(route.totalMinutes / 60);
          const m = route.totalMinutes % 60;
          if (m > 0) {
            durationText = `${h} h ${m} ${minuteShortLabel()}`;
          } else {
            durationText = `${h} h`;
          }
        } else {
          durationText = `${route.totalMinutes} ${minuteShortLabel()}`;
        }

        setStopDurationText(duration, stopCount, durationText, "paren");

      if (badge) item.appendChild(badge);
      if (lengthMode) {
        const meta = document.createElement("div");
        meta.className = "dbus-item-meta";
        meta.appendChild(titleEl);
        meta.appendChild(duration);
        item.appendChild(meta);
      } else {
        item.appendChild(titleEl);
        item.appendChild(duration);
      }

        const colorKey = routeColorKey(line, route, badgeRawNumber);
        const expressStyleKey = /^\d+$/.test(String(displayNumber || "").trim())
          ? `Express ${displayNumber}`
          : "Express";
        const expressStyle = isExpressItem
          ? (getLineStyleEntry(expressMeta?.colorKey || expressStyleKey) || getLineStyleEntry("Express"))
          : null;
        const routeColorsPromise = expressStyle
          ? Promise.resolve([expressStyle[0], expressStyle[1]])
          : (isExpressItem ? Promise.resolve(["#6fb2e1", "#FFFFFF"]) : getLineColors(colorKey));
      if (badge) {
        routeColorsPromise.then(([bg,text])=>{
          badge.style.background = bg;
          badge.style.color = text;
          if (isNoctilien2(colorKey)) {
            ensureStripe(badge, noctilienStripeColor(colorKey));
          }
        });
      }
      const routeKey = `${line.uid}:${route.uid}`;
      if (currentSelectedKey === routeKey) {
        item.classList.add("active");
        routeColorsPromise.then(([bg]) => {
          if (item.classList.contains("active")) item.style.outline = `2px solid ${bg}`;
        });
      }


        item.addEventListener("click", ()=> {
          $panelDbus?.querySelectorAll(".dbus-item").forEach(it=>{
            it.classList.remove("active");
            it.style.outline = "none";
          });
          item.classList.add("active");
          routeColorsPromise.then(([bg])=>{
            if (item.classList.contains("active")) item.style.outline = `2px solid ${bg}`;
          });

          currentSelectedKey = routeKey;
          currentSelectedLineUid = line.uid;
          dbusRoutesClosedByPanel = false;
          showOnlyRoute(0, line, route);
          renderSelectedChip();
          updateDbusModeUI();
        });

        container.appendChild(item);
      }

      function renderSectionByDuration(title, entries) {
        if (!entries.length) return;

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        const isOpenByDefault = (
          title === "IDFM" ||
          title === "Noctiliens" ||
          normalizeBadgeToken(title) === normalizeBadgeToken(translatedNightBusLabel())
        );

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.innerHTML = `
          <span>${title} (${entries.length})</span>
          <span class="chev" style="margin-left:auto">▼</span>
        `;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault;
        sec.appendChild(body);

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          const willOpen = !expanded;
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearDbusSelection(body);
            return;
          }
          if (willOpen) {
            try {
              $dbusList.querySelectorAll('.dbus-sechead').forEach(h => {
                if (h !== head) {
                  h.setAttribute('aria-expanded','false');
                  const b = h.nextElementSibling;
                  if (b && b.classList.contains('dbus-secbody')) {
                    b.hidden = true;
                    clearDbusSelection(b);
                  }
                }
              });
              if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === 'function') {
                window.__DBUS_GRID_OPEN.clear();
                window.__DBUS_GRID_OPEN = null;
              }
            } catch {}
          }
        });

        entries.forEach(({ line, route }) => renderLineItem(line, route, body, { showLogo: true }));
      }
      function renderDbusLinesListInner(mode) {
        if (!$dbusList) return;
        $dbusList.innerHTML = "";
        if (mode === DBUS_MODES.LINES) showDbusRoutesPlaceholder();
        if (mode === DBUS_MODES.LENGTH) {
          const routeBuckets = buildRouteBuckets();
          const entries = [];
          Object.values(routeBuckets).forEach(list => entries.push(...list));
          entries.sort((a, b) => {
            const diff = lengthScoreForLengthMode(b.line, b.route) - lengthScoreForLengthMode(a.line, a.route);
            if (diff) return diff;
            return String(a.route.name || "").localeCompare(
              String(b.route.name || ""),
              "fr",
              { numeric: true, sensitivity: "base" }
            );
          });
          if (!entries.length) {
            const empty = document.createElement("div");
            empty.className = "dbus-none";
            empty.textContent = t("none");
            $dbusList.appendChild(empty);
            return;
          }
          entries.forEach(({ line, route }) => renderLineItem(line, route, $dbusList, { showLogo: true, lengthMode: true }));
          return;
        }
        const lineBuckets = buildLineBuckets();
        const extraSourceLines = lineBuckets["Autres"];
        const expressGroups = buildGroupedExpressLines(lineBuckets["Urbain"], extraSourceLines);
        const autocarGroupLine = buildGroupedLineFromRoutes("autocar", "Autocar", extraSourceLines, isAutocarRoute);

        const urbanLines = lineBuckets["Urbain"].filter(line => !isTitusLine(line) && !isExpress(line));
        const titusLines = lineBuckets["Urbain"].filter(line => isTitusLine(line));

        const others = [
          ...lineBuckets["FlixBus"],
          ...lineBuckets["Scolaire"],
          ...lineBuckets["Autres"].filter(line => {
            const n = String(line.number || "").trim().toLowerCase();
            return !/^fict/i.test(n) && !/^autocar\b/i.test(n);
          })
        ];
        if (autocarGroupLine) others.push(autocarGroupLine);
        others.sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));

        renderSectionGrid("urban", urbanLines);
        renderSectionGrid("Express", expressGroups);
        renderSectionGrid("noctilien",  lineBuckets["Noctilien"]);
        renderSectionGrid("other_networks", titusLines);
        renderSectionGrid("others", others);
      }

      renderDbusLinesList = renderDbusLinesListInner;
      renderDbusLinesList(currentDbusMode);
      applyI18N();
      buildDbusDepartures();
      if (currentDbusMode === DBUS_MODES.DEPARTS && dbusDepartPreviewActive) showDbusDepartures();

    }
    initDbusUI().then(()=>renderSelectedChip()).catch(()=>{});

    let currentActiveStopId = null;
    function clearActiveStop(){
      PREVIEW_STOP_ELEMS.forEach(({el}) => el.classList.remove('active'));
      currentActiveStopId = null;
    }

    function norm(s){
      return String(s||"")
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }
    function includesNorm(hay, needle){ return norm(hay).includes(norm(needle)); }

    function detectTypeFilter(q){
      const n = norm(q);

      const MAP = [
        {types:["Atelier"],      keys:["atelier","atelier de reparation","reparation","atelier reparation"]},
        {types:["Agence"],       keys:["agence","agence de recrutement","recrutement"]},
        {types:["Garage"],       keys:["garage"]},
        {types:["Concessionnaire"], keys:["concessionnaire","dealer","concess"]},
        {types:["Entreprise"],   keys:["entreprise","societe","company"]},
        {types:["Ville"],        keys:["ville","commune","city"]},
        {types:["Monument"],     keys:["monument","monuments","monu","lieu","lieu emblématique","lieux emblématiques","lieux","emblématique","emblématiques"]},
      ];

      for(const row of MAP){
        for(const k of row.keys){
          if(n === k || n.startsWith(k+" ") || n.endsWith(" "+k) || n.includes(" "+k+" ")){
            return { types: row.types, hit: k };
          }
        }
      }
      return null;
    }
      
    let sectionState = {};
    function getExpanded(key){ return sectionState[key] !== false; }
    function setExpanded(key, val){ sectionState[key] = !!val; }
    
    const ORDER = [
      ["Ville","Villes"],
      ["Monument","Lieux Emblématiques"],
      ["Atelier","Ateliers de réparation"],
      ["Agence","Agences de recrutement"],
      ["Concessionnaire","Concessionnaires"],
      ["Entreprise","Entreprises"]
    ];
    const PLURIEL = Object.fromEntries(ORDER);

    const SEARCH_CATEGORIES = [SEARCH_CATEGORY_ALL, ...ALL_TYPES];
    function setActiveSearchCategory(next){
      if (!next || ACTIVE_SEARCH_CATEGORY === next) return;
      ACTIVE_SEARCH_CATEGORY = next;
    }
    function filterSearchList(list, raw, allowTypeFilter){
      const nQ = norm(raw);
      if (nQ === "") return list.slice();
      let filtered = list.slice();
      const typeInfo = allowTypeFilter ? detectTypeFilter(nQ) : null;

      if (typeInfo){
        filtered = filtered.filter(it => typeInfo.types.includes(it.type));
        let rest = norm(raw.replace(new RegExp(typeInfo.hit,'i'), '').trim())
                    .replace(/^[\s,;:>-]+|[\s,;:>-]+$/g,'');
        if (rest){
          filtered = filtered.filter(it => {
            const hay = [it.name, it.city, it.brand].filter(Boolean).join(" ");
            return includesNorm(hay, rest);
          });
        }
      } else {
        const words = norm(raw).split(/\s+/).filter(Boolean);
        filtered = filtered.filter(it => {
          const hay = [it.type, it.name, it.city, it.brand].filter(Boolean).join(" ");
          const normHay = norm(hay);
          return words.every(w => normHay.includes(w));
        });
      }
      return filtered;
    }
    function updateSearchCategoryCounts(list){
      const counts = Object.fromEntries(ALL_TYPES.map(t => [t, 0]));
      for (const it of list){
        if (counts[it.type] !== undefined) counts[it.type] += 1;
      }
      SEARCH_CATEGORY_COUNTS = counts;
      SEARCH_CATEGORY_TOTAL = Object.values(counts).reduce((sum, n) => sum + n, 0);
    }

    function buildResultsFilterBar(host = ($searchFilters || $results)){
      if (!host) return;
      host.querySelector(".results-filters")?.remove();

      const bar = document.createElement("div");
      bar.className = "search-categories results-filters";

      SEARCH_CATEGORIES.forEach(typeKey=>{
        const labelText = searchCategoryButtonLabel(typeKey);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dbus-mode-btn";
        btn.dataset.category = typeKey;
        const active = typeKey === ACTIVE_SEARCH_CATEGORY;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
        btn.textContent = labelText;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (ACTIVE_SEARCH_CATEGORY === typeKey) return;
          setActiveSearchCategory(typeKey);
          doSearch($search.value);
        });
        bar.appendChild(btn);
      });

      host.prepend(bar);
    }

    function renderResults(list){
      $results.innerHTML = "";
      buildResultsFilterBar();
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "result-empty";
        empty.textContent = resultsEmptyText();
        $results.appendChild(empty);
        $results.hidden = false;
        return;
      }

      const buckets = {
        "Ville": [],
        "Atelier": [],
        "Agence": [],
        "Garage": [],
        "Concessionnaire": [],
        "Entreprise": [],
        "Monument": []
      };
      for (const it of list){ if (buckets[it.type]) buckets[it.type].push(it); }

      function addSectionBlockLocal(typeKey, label, count){
        const head = document.createElement("div");
        head.className = "result-sechead";
        const mapLbl = {
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies")
        };
        const base = mapLbl[typeKey] || label;
        head.dataset.type = typeKey;
        head.dataset.count = String(count);
        head.textContent = `${base} (${count})`;
        $results.appendChild(head);

        const body = document.createElement("div");
        body.className = "result-secbody";
        $results.appendChild(body);

        return body;
      }

      function addItem(container, item){
        const div = document.createElement("div");
        div.className = "result-item";

          if (item.type === "Lignes DBus") {
          const img = document.createElement("img");
          img.className = "ico ico-service";
          img.src = overlayPath("bus_ico.png");
          img.alt = "Bus";
          div.appendChild(img);

          let lineNumber = "";
          let routeName  = "";
          if (item.name.includes(":")) {
            const [left, right] = item.name.split(":");
            lineNumber = left.replace("Ligne","").trim();
            routeName  = right.trim();
          } else {
            lineNumber = item.name.trim();
            routeName  = "";
          }

          const category = getCategory({ number: lineNumber });

          if (category !== "Autres") {
            const tnum = item.titusNum || (/^titus\s*(\d+)/i.exec(String(lineNumber||""))?.[1] ?? null);
            if (tnum) {
              const wrap = document.createElement('div');
              wrap.style.display = 'inline-flex';
              wrap.style.alignItems = 'center';
              wrap.style.gap = '6px';
              const img = document.createElement('img');
              img.src = overlayPath("reseau_titus.png");
              img.alt = 'Réseau Titus';
              img.style.height = '22px';
              img.style.width = 'auto';
              const [bg, text] = getLineColorsSync('Titus ' + tnum);
              const chip = makeLineBadge(tnum, bg, text, '48x24');
              wrap.appendChild(img);
              wrap.appendChild(chip);
              div.appendChild(wrap);
            } else {
              const [bg, text] = getLineColorsSync(lineNumber);
              const badge = makeLineBadge(
                lineNumber,
                bg,
                text,
                routeBadgeSizeFor(lineNumber),
                isNoctilien2(lineNumber) ? noctilienStripeColor(lineNumber) : null,
                false
              );
              div.appendChild(badge);
            }
          }

          const span = document.createElement("div");
          span.className = "result-text";
          const cleanTitle = routeName.replace(/^\s*Titus\s*\d+\s*[:-]?\s*/i, '');
          span.dataset.routeTitle = cleanTitle;
          span.textContent = translateRouteTitle(cleanTitle);
          div.appendChild(span);
        } else {
          if (item.logo) {
            const img = document.createElement("img");
            img.className = "ico";
            if (["Atelier","Agence","Garage","Ville","Monument","Centre commercial"].includes(item.type)) {
              img.classList.add("ico-service");
            }
            img.src = item.logo;
            img.alt = "";
            img.onerror = () => {
              if (item.fallbackLogo && img.src !== item.fallbackLogo) img.src = item.fallbackLogo;
            };
            div.appendChild(img);
          }

          let label;
          if (item.type === "Concessionnaire"){
            const brand = (item.brand || String(item.name||"").replace(/^Concessionnaire\s+/i,"")).trim();
            label = item.city ? `${brand} - ${item.city}` : brand;
          } else if (["Atelier","Agence","Garage"].includes(item.type)){
            label = item.city || typeFallbackLabel(item.type);
          } else if (item.type === "Monument"){
            label = item.city ? `${item.name} - ${item.city}` : item.name; 
          } else {
            label = item.city ? `${item.name} - ${item.city}` : item.name;
          }

          const span = document.createElement("div");
          span.className = "result-text";
          span.textContent = label;
          div.appendChild(span);
        }

        div.addEventListener("click", () => {
          closeSearchUI({ reset: true });
          map.setView(item.center, Math.max(map.getZoom(), minNativeZoom + 4));
          if (item.open) setTimeout(()=> item.open(), 150);
        });

        container.appendChild(div);
      }



      let shown = 0;
      for (const [typeKey,label] of ORDER){
        const arr = buckets[typeKey];
        if (!arr.length) continue;
        const body = addSectionBlockLocal(typeKey,label, arr.length);
        for (const it of arr){
          if (shown >= 250) break;
          addItem(body,it);
          shown++;
        }
        if (shown >= 250) break;
      }

      $results.hidden = false;
      applyI18N();
    }

    function doSearch(q){
      const raw = String(q||"");
      const allowTypeFilter = ACTIVE_SEARCH_CATEGORY === SEARCH_CATEGORY_ALL;
      const baseFiltered = filterSearchList(searchIndex, raw, allowTypeFilter);
      updateSearchCategoryCounts(baseFiltered);

      const activeTypes = (ACTIVE_SEARCH_CATEGORY === SEARCH_CATEGORY_ALL)
        ? ALL_TYPES
        : [ACTIVE_SEARCH_CATEGORY];
      const ALLOWED = new Set(activeTypes);
      let filtered = baseFiltered.filter(it => ALLOWED.has(it.type));

      if (!raw.trim()){
        renderResults(filtered);
        $results.hidden = false;
        return;
      }

      filtered.sort((a,b)=>{
        const pa = (a.type==="Ville")?0:1, pb=(b.type==="Ville")?0:1;
        if(pa!==pb) return pa-pb;
        return String(a.name).localeCompare(String(b.name), LANG==='en'?'en':'fr', {numeric:true});
      });

      filtered.sort((a,b)=>{
        if (a.type === "Lignes DBus" && b.type === "Lignes DBus") {
          return (a.num ?? Infinity) - (b.num ?? Infinity);
        }
        return 0;
      });



      renderResults(filtered);
      $results.hidden = false;
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    const doSearchDebounced = debounce(q => {
      doSearch(String(q||''));
      openSearchUI();
      _resIdx = -1;
    }, 120);

    $search.addEventListener('focus', () => { closeDbusPanel(); openSearchUI({ refresh: true }); doSearch($search.value); });
    $search.addEventListener('input', e => doSearchDebounced(e.target.value));
    $search.addEventListener('keydown', e => { if (e.key === 'Enter') { const first = $results.querySelector('.result-item'); if (first) first.click(); } });

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;
      const path = (typeof e.composedPath === "function") ? e.composedPath() : [];
      const clickInSearch = path.includes($searchPanel)
        || path.includes($search)
        || ((!!$searchPanel && $searchPanel.contains(target)) || target === $search);
      const clickInLang = path.some(node => node instanceof Element && node.classList?.contains("lang-switch"))
        || !!target.closest(".lang-switch");

      if (!clickInSearch) closeSearchUI({ reset: true });
      if (!clickInLang) closeLangMenu();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('lpClose')?.click();
        closeSearchUI({ reset: true });
        closeDbusPanel();
        closeSettingsPanel();
        closeLangMenu();
        try { map.closePopup(); } catch {}
        updateUiOverlays();
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        openSearchUI({ focus: true, refresh: true });
      }
    });
  </script>
  <script>
    window.__setAppReady?.();
  </script>

  <script>
    const CLOSED = false 
      || (new URLSearchParams(location.search).get('closed') === '1');

    if (CLOSED) {
      const html = `
        <div style="
          position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
          background:#121212;color:#ececec;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
          text-align:center;padding:24px
        ">
          <div>
            <div style="font-size:28px;font-weight:800;margin-bottom:10px">${t("maintenance_title")}</div>
          </div>
        </div>
      `;
      document.body.innerHTML = html;
      throw new Error('Maintenance');
    }
  </script>

</body>
</html>



























